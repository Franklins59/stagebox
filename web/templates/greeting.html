<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stagebox</title>
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-card: #1f2940;
            --text-primary: #e8e8e8;
            --text-secondary: #a0a0a0;
            --accent-primary: #4a9eff;
            --accent-success: #4caf50;
            --accent-warning: #ff9800;
            --accent-danger: #f44336;
            --border-color: #2a3a5a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .top-header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            width: 64px;
            height: 64px;
        }

        .header-title h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
        }

        .edition-badge {
            font-size: 0.5em;
            font-weight: 600;
            padding: 0.15em 0.5em;
            border-radius: 4px;
            text-transform: uppercase;
            vertical-align: middle;
            margin-left: 0.25em;
        }

        .edition-badge.edition-pro {
            background: linear-gradient(135deg, #4a9eff, #2563eb);
            color: #fff;
        }

        .edition-badge.edition-personal {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: #fff;
        }

        /* Pro-only features (disabled in Personal edition) */
        .btn.pro-disabled {
            opacity: 0.5;
            cursor: not-allowed;
            position: relative;
        }

        .btn.pro-disabled::after {
            content: '‚≠ê Pro';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7em;
            background: linear-gradient(135deg, #4a9eff, #2563eb);
            color: #fff;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .btn.pro-disabled:hover {
            background: var(--bg-tertiary);
        }

        .header-title .subtitle {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin: 0;
        }

        /* Main Container - 2 Column */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Left Sidebar */
        .sidebar-left {
            width: 220px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            overflow-y: auto;
        }

        .sidebar-section {
            padding: 0.5rem 0;
        }

        .sidebar-section h2 {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
            padding-left: 0.5rem;
        }

        .sidebar-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.125rem;
        }

        .sidebar-buttons .btn {
            width: 100%;
            padding: 0.5rem 0.75rem;
            font-size: 0.85rem;
            justify-content: flex-start;
            text-align: left;
            background: transparent;
            border: none;
            border-radius: 4px;
            color: var(--text-primary);
            font-weight: 400;
        }

        .sidebar-buttons .btn:hover {
            background: var(--bg-card);
        }

        .sidebar-buttons .btn:disabled {
            color: var(--text-secondary);
            opacity: 0.5;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            padding-left: 0.5rem;
        }

        .admin-header h2 {
            margin: 0;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .btn-logout {
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .btn-logout:hover {
            border-color: var(--accent-danger);
            color: var(--accent-danger);
        }

        /* Main Content Area */
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            overflow: hidden;
        }

        .content-header {
            margin-bottom: 1rem;
        }

        .content-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        /* Building Grid */
        .building-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            overflow-y: auto;
            padding-right: 0.5rem;
            align-content: start;
        }

        .building-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .building-card:hover {
            border-color: var(--accent-primary);
            background: rgba(74, 158, 255, 0.05);
        }

        .building-card.selected {
            border-color: var(--accent-primary);
            background: rgba(74, 158, 255, 0.1);
        }

        .building-card .name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            word-break: break-word;
        }

        .building-card .info {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .building-card .info .ip-range {
            font-family: 'Monaco', 'Menlo', monospace;
            color: var(--accent-primary);
        }

        .building-card .device-count {
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .content-footer {
            margin-top: 1rem;
            display: flex;
            justify-content: flex-end;
        }

        .btn-large {
            padding: 0.875rem 2rem;
            font-size: 1rem;
        }

        /* No Buildings */
        .no-buildings {
            grid-column: 1 / -1;
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        /* Admin Panel */
        .admin-panel {
            display: none;
        }

        .admin-panel.active {
            display: block;
        }

        .btn.btn-admin {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 0.5rem 0.75rem;
            font-size: 0.85rem;
            font-weight: 400;
            text-align: left;
            justify-content: flex-start;
            border-radius: 4px;
        }

        .btn.btn-admin:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .btn.btn-admin.authenticated {
            color: var(--accent-success);
        }

        /* General Button Styles */
        .btn {
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #3a8eef;
        }

        .btn-primary:disabled {
            background: #3a5070;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-card);
        }

        .btn-danger {
            background: var(--accent-danger);
            color: white;
        }

        .btn-danger:hover {
            background: #e53935;
        }

        .btn-success {
            background: var(--accent-success);
            color: white;
        }

        .btn-success:hover {
            background: #43a047;
        }

        /* Loading */
        .loading {
            grid-column: 1 / -1;
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Modal Overlay */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 2rem;
            max-width: 450px;
            width: 90%;
        }

        .modal h3 {
            margin-bottom: 1rem;
            text-align: center;
        }

        .modal p {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .modal .btn-group {
            display: flex;
            gap: 1rem;
        }

        .modal .btn-group .btn {
            flex: 1;
        }

        /* Form elements */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .form-group input.error {
            border-color: var(--accent-danger);
        }

        .error-message {
            color: var(--accent-danger);
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        /* Admin Panel */
        .admin-panel {
            display: none;
        }

        .admin-panel.active {
            display: block;
        }

        .admin-panel h2 {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-panel .logout-btn {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            flex: none;
        }

        .admin-actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .admin-actions .btn {
            justify-content: flex-start;
            padding: 0.75rem 1rem;
        }

        .building-card .action-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0.3rem 0.5rem;
            font-size: 1.1rem;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .building-card .action-btn:hover {
            opacity: 1;
        }

        .building-card .action-btn.rename-btn {
            color: var(--accent-blue, #3b82f6);
        }

        .building-card .action-btn.delete-btn {
            color: var(--accent-danger);
        }

        .building-card .card-actions {
            float: right;
            display: flex;
            gap: 0.25rem;
        }

        /* Wide modal for NAS/USB */
        .modal-wide {
            max-width: 500px;
        }

        .modal-hint {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        /* Import Modal */
        .file-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 1rem;
        }

        .file-upload-area:hover,
        .file-upload-area.dragover {
            border-color: var(--accent-primary);
            background: rgba(74, 158, 255, 0.1);
        }

        .file-upload-area .hint {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        .import-file-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .import-file-info .btn-small {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem 0.5rem;
        }

        .import-file-info .btn-small:hover {
            color: var(--accent-danger);
        }

        #import-buildings-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .import-building-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .import-building-item:last-child {
            border-bottom: none;
        }

        .import-building-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .import-building-info {
            flex: 1;
        }

        .import-building-name {
            font-weight: 500;
        }

        .import-building-details {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .import-building-conflict {
            font-size: 0.75rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            background: rgba(255, 152, 0, 0.2);
            color: var(--accent-warning);
        }

        .import-conflict-action {
            display: flex;
            gap: 0.5rem;
            margin-left: auto;
        }

        .import-conflict-action select {
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.8rem;
        }

        /* Restore from USB Modal */
        .backup-list {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .backup-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
        }

        .backup-item:last-child {
            border-bottom: none;
        }

        .backup-item:hover {
            background: var(--bg-hover);
        }

        .backup-item.selected {
            background: rgba(74, 158, 255, 0.15);
            border-color: var(--accent-primary);
        }

        .backup-item input[type="radio"] {
            width: 18px;
            height: 18px;
        }

        .backup-info {
            flex: 1;
        }

        .backup-filename {
            font-weight: 500;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85rem;
        }

        .backup-details {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .backup-date {
            color: var(--accent-primary);
        }

        .backup-source {
            display: inline-block;
            padding: 0.1rem 0.4rem;
            border-radius: 3px;
            font-size: 0.7rem;
            margin-left: 0.5rem;
        }

        .backup-source.own {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
        }

        .backup-source.other {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .backup-item.own-device {
            border-left: 3px solid #4ade80;
        }

        .restore-file-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background: var(--bg-secondary);
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        #restore-buildings-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .empty-hint {
            text-align: center;
            color: var(--text-secondary);
            padding: 2rem;
        }

        /* Scripts Modal */
        .scripts-list-items {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .script-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .script-item:last-child {
            border-bottom: none;
        }

        .script-name {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85rem;
        }

        .scripts-upload {
            border-top: 1px solid var(--border-color);
            padding-top: 1rem;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        .scripts-upload h4 {
            margin: 0 0 0.75rem 0;
            font-size: 0.9rem;
        }

        .upload-area {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .upload-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .file-name {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-family: 'Monaco', 'Menlo', monospace;
        }

        /* Language Modal */
        .language-options {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .language-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .language-option:hover {
            background: var(--bg-hover);
            border-color: var(--accent-primary);
        }

        .language-option input[type="radio"] {
            width: 18px;
            height: 18px;
        }

        .language-option input[type="radio"]:checked + span {
            color: var(--accent-primary);
            font-weight: 500;
        }

        .form-row {
            display: flex;
            gap: 1rem;
        }

        .form-row .form-group {
            flex: 1;
        }

        .password-wrapper {
            position: relative;
            display: flex;
        }

        .password-wrapper input {
            flex: 1;
            padding-right: 2.5rem;
        }

        .toggle-pw {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            font-size: 1rem;
        }

        .toggle-pw:hover {
            color: var(--text-primary);
        }

        .status-box {
            padding: 0.75rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-size: 0.9rem;
        }

        .status-box.success {
            background: rgba(76, 175, 80, 0.15);
            border: 1px solid var(--accent-success);
            color: var(--accent-success);
        }

        .status-box.error {
            background: rgba(244, 67, 54, 0.15);
            border: 1px solid var(--accent-danger);
            color: var(--accent-danger);
        }

        .status-box.info {
            background: rgba(74, 158, 255, 0.15);
            border: 1px solid var(--accent-primary);
            color: var(--accent-primary);
        }

        .loading-small {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            color: var(--text-secondary);
        }

        .spinner-small {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .empty-state {
            text-align: center;
            padding: 1.5rem;
            color: var(--text-secondary);
        }

        .empty-state .hint {
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        /* USB Drive List */
        .usb-drive-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .usb-drive-item:last-child {
            margin-bottom: 0;
        }

        .usb-drive-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .usb-drive-name {
            font-weight: 600;
            font-size: 1rem;
        }

        .usb-drive-size {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .usb-drive-info {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
        }

        .usb-usage-bar {
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .usb-usage-fill {
            height: 100%;
            background: var(--accent-primary);
            transition: width 0.3s ease;
        }

        .usb-usage-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .usb-drive-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .usb-drive-actions .btn {
            flex: 1;
            padding: 0.5rem;
            font-size: 0.85rem;
        }

        .btn-warning {
            background: var(--accent-warning);
            color: #000;
        }

        .btn-warning:hover {
            background: #e68900;
        }

        /* Stagebox Badge */
        .stagebox-badge {
            display: inline-block;
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid var(--accent-success);
            color: var(--accent-success);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
        }

        .usb-drive-item.is-stagebox {
            border-color: var(--accent-success);
        }

        .usb-status-ok {
            display: inline-block;
            padding: 0.5rem 0.75rem;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 6px;
            color: var(--accent-success);
            font-weight: 500;
            font-size: 0.85rem;
        }

        .usb-drive-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            margin-top: 0.75rem;
            flex-wrap: wrap;
        }

        .usb-drive-actions .btn {
            padding: 0.6rem 1rem;
            font-size: 0.9rem;
        }

        .usb-drive-actions .btn-small {
            padding: 0.4rem 0.75rem;
            font-size: 0.8rem;
        }

        .usb-format-hint {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-primary);
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .usb-format-hint p {
            margin: 0 0 0.5rem 0;
            color: var(--text-secondary);
        }

        .usb-format-hint code {
            display: block;
            padding: 0.5rem 0.75rem;
            background: #0d1117;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
            color: var(--accent-primary);
        }

        /* App Footer */
        .app-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: var(--text-secondary);
            z-index: 100;
        }

        .footer-hw-info {
            display: flex;
            gap: 1rem;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .footer-hw-info span {
            white-space: nowrap;
        }

        .hw-label {
            color: var(--text-secondary);
            opacity: 0.7;
        }

        #version-display {
            font-family: 'Monaco', 'Menlo', monospace;
        }

        /* Adjust main container to not overlap footer */
        .main-container {
            padding-bottom: 2.5rem;
        }
        
        /* Toast notification */
        .toast-notification {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-success, #4caf50);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            z-index: 99999;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.25);
        }
        .toast-notification.show {
            opacity: 1;
        }

        /* Manual Button */
        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .manual-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .manual-btn:hover {
            background: var(--bg-card);
            color: var(--text-primary);
            border-color: var(--accent-primary);
        }

        /* Installer Profile Modal */
        .installer-profile-content {
            display: flex;
            gap: 2rem;
            margin-bottom: 1.5rem;
        }

        .logo-section {
            flex-shrink: 0;
            width: 200px;
        }

        .logo-preview-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-preview {
            width: 180px;
            height: 100px;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-primary);
            overflow: hidden;
        }

        .logo-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .logo-placeholder {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .logo-actions {
            display: flex;
            gap: 0.5rem;
        }

        .logo-hint {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: center;
            margin: 0;
        }

        .profile-fields {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .profile-fields .form-group {
            margin-bottom: 0;
        }

        .profile-fields textarea {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            resize: vertical;
        }

        .profile-fields textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .btn-small {
            padding: 0.35rem 0.6rem;
            font-size: 0.8rem;
        }

        @media (max-width: 600px) {
            .installer-profile-content {
                flex-direction: column;
            }
            
            .logo-section {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="top-header">
        <div class="header-left">
            <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Stagebox" class="logo">
            <div class="header-title">
                <h1><span data-i18n="app.name">Stagebox</span> <span id="edition-badge" class="edition-badge"></span></h1>
                <p class="subtitle" data-i18n="app.subtitle">Shelly Provisioning System</p>
            </div>
        </div>
        <div class="header-right">
            <a href="/manual" class="manual-btn" id="manual-link">üìñ <span data-i18n="manual.title">Manual</span></a>
        </div>
    </header>

    <!-- Main Container - 2 Column Layout -->
    <div class="main-container">
        <!-- Left Sidebar - Functions -->
        <aside class="sidebar-left">
            <div class="sidebar-section">
                <h2 data-i18n="system.title">System</h2>
                <div class="sidebar-buttons">
                    <button id="btn-backup-usb" class="btn" data-pro-only="hide" data-i18n="system.backup_usb">
                        üíæ Backup to USB
                    </button>
                    <button id="btn-reboot" class="btn" data-i18n="system.reboot">
                        üîÑ Reboot
                    </button>
                    <button id="btn-shutdown" class="btn" data-i18n="system.shutdown">
                        ‚èª Shutdown
                    </button>
                </div>
            </div>

            <div class="sidebar-section">
                <button id="btn-admin" class="btn btn-admin" data-i18n="admin.login">
                    üîí Admin
                </button>
            </div>

            <!-- Admin Panel (hidden until authenticated) -->
            <div id="admin-panel" class="sidebar-section admin-panel">
                <div class="admin-header">
                    <h2 data-i18n="admin.title_unlocked">üîì Admin</h2>
                    <button id="btn-logout" class="btn-logout" data-i18n="admin.logout">Logout</button>
                </div>
                <div class="sidebar-buttons">
                    <button id="btn-create-building" class="btn" data-pro-only="true" data-i18n="admin.new_building">
                        ‚ûï New Building
                    </button>
                    <button id="btn-export-buildings" class="btn" data-i18n="admin.export_buildings">
                        üì§ Export Building
                    </button>
                    <button id="btn-import-buildings" class="btn" data-i18n="admin.import_buildings">
                        üì• Import Building
                    </button>
                    <button id="btn-restore-usb" class="btn" data-pro-only="hide" data-i18n="admin.restore_usb">
                        üìÇ Restore from USB
                    </button>
                    <button id="btn-usb-format" class="btn" data-pro-only="hide" data-i18n="admin.usb_format">
                        üîå Format USB Stick
                    </button>
                    <button id="btn-change-pin" class="btn" data-pro-only="hide" data-i18n="admin.change_pin">
                        üîë Change PIN
                    </button>
                    <div style="position: relative; display: block; width: 100%;">
                        <button id="btn-check-updates" class="btn" data-i18n="admin.stagebox_update" style="width: 100%;">
                            üì¶ Stagebox Update
                        </button>
                        <span id="update-badge" style="display: none; position: absolute; top: 5px; right: 5px; background: var(--accent-danger); color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; line-height: 20px; text-align: center;">!</span>
                    </div>
                    <button id="btn-system-updates" class="btn" data-pro-only="true" data-i18n="admin.system_updates">
                        üñ•Ô∏è System Updates
                    </button>
                    <button id="btn-language" class="btn" data-i18n="admin.language">
                        üåê Language
                    </button>
                    <button id="btn-installer-profile" class="btn" data-pro-only="true" data-i18n="admin.installer_profile">
                        üë§ Installer Profile
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content - Building Selection -->
        <main class="content-area">
            <div class="content-header">
                <h2 data-i18n="greeting.select_building">Select Building</h2>
            </div>
            
            <div id="building-grid" class="building-grid">
                <div class="loading">
                    <div class="spinner"></div>
                    <p data-i18n="greeting.loading">Loading buildings...</p>
                </div>
            </div>

            <div class="content-footer">
                <button id="btn-open" class="btn btn-primary btn-large" disabled data-i18n="greeting.open">
                    Open ‚Üí
                </button>
            </div>
        </main>
    </div>

    <footer class="app-footer">
        <div class="footer-hw-info">
            <span>{{ hw_info.model }}</span>
            <span>{{ hw_info.ram }}</span>
            <span><span class="hw-label">SN:</span> {{ hw_info.serial }}</span>
            <span><span class="hw-label">MAC:</span> {{ hw_info.mac_suffix }}</span>
            <span><span class="hw-label">CPU:</span> <span id="hw-temp">{{ hw_info.cpu_temp }}¬∞C</span></span>
            <span><span class="hw-label">Up:</span> <span id="hw-uptime">{{ hw_info.uptime }}</span></span>
        </div>
        <span id="version-display">Stagebox {{ version }}</span>
    </footer>

    <!-- Confirm Modal -->
    <div id="modal-confirm" class="modal-overlay">
        <div class="modal">
            <h3 id="modal-title" data-i18n="confirm.title">Confirm</h3>
            <p id="modal-message" data-i18n="confirm.are_you_sure">Are you sure?</p>
            <div class="btn-group">
                <button id="modal-cancel" class="btn btn-secondary" data-i18n="common.cancel">Cancel</button>
                <button id="modal-confirm-btn" class="btn btn-danger" data-i18n="common.confirm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- PIN Modal -->
    <div id="modal-pin" class="modal-overlay">
        <div class="modal">
            <h3 id="pin-modal-title" data-i18n="pin.enter">Enter Admin PIN</h3>
            <div class="form-group">
                <label for="pin-input">PIN</label>
                <input type="password" id="pin-input" data-i18n-placeholder="pin.enter" placeholder="Enter PIN" autocomplete="off">
                <div id="pin-error" class="error-message" style="display: none;"></div>
            </div>
            <div class="btn-group">
                <button id="pin-cancel" class="btn btn-secondary" data-i18n="common.cancel">Cancel</button>
                <button id="pin-submit" class="btn btn-primary" data-i18n="pin.submit">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Create Building Modal -->
    <div id="modal-create-building" class="modal-overlay">
        <div class="modal">
            <h3 data-i18n="building.create">Create New Building</h3>
            <div class="form-group">
                <label for="building-name-input" data-i18n="building.name">Building Name</label>
                <input type="text" id="building-name-input" data-i18n-placeholder="building.name_placeholder" placeholder="e.g. sample_building" autocomplete="off">
                <div id="building-name-error" class="error-message" style="display: none;"></div>
            </div>
            <p style="font-size: 0.85rem;" data-i18n="building.name_hint">Only lowercase letters, numbers and underscores allowed.</p>
            <div class="btn-group">
                <button id="create-building-cancel" class="btn btn-secondary" data-i18n="common.cancel">Cancel</button>
                <button id="create-building-submit" class="btn btn-success" data-i18n="building.submit">Create</button>
            </div>
        </div>
    </div>

    <!-- Change PIN Modal -->
    <div id="modal-change-pin" class="modal-overlay">
        <div class="modal">
            <h3 data-i18n="pin.change">Change PIN</h3>
            <div class="form-group">
                <label for="new-pin-input" data-i18n="pin.new">New PIN</label>
                <input type="password" id="new-pin-input" placeholder="New PIN (min. 4 characters)" autocomplete="off">
            </div>
            <div class="form-group">
                <label for="confirm-pin-input" data-i18n="pin.confirm">Confirm PIN</label>
                <input type="password" id="confirm-pin-input" placeholder="Confirm PIN" autocomplete="off">
                <div id="change-pin-error" class="error-message" style="display: none;"></div>
            </div>
            <div class="btn-group">
                <button id="change-pin-cancel" class="btn btn-secondary" data-i18n="common.cancel">Cancel</button>
                <button id="change-pin-submit" class="btn btn-primary" data-i18n="pin.save">Change</button>
            </div>
        </div>
    </div>

    <!-- Rename Building Modal -->
    <div id="modal-rename" class="modal-overlay">
        <div class="modal">
            <h3>‚úèÔ∏è <span data-i18n="building.rename">Rename Building</span></h3>
            <input type="hidden" id="rename-old-name">
            <div class="form-group">
                <label for="rename-new-name" data-i18n="building.new_name">New Name</label>
                <input type="text" id="rename-new-name" placeholder="e.g. myhouse" autocomplete="off">
                <p class="hint" data-i18n="building.name_hint">Only lowercase letters, numbers and underscores allowed.</p>
                <div id="rename-error" class="error-message" style="display: none;"></div>
            </div>
            <div class="btn-group">
                <button id="rename-cancel" class="btn btn-secondary" data-i18n="common.cancel">Cancel</button>
                <button id="rename-submit" class="btn btn-primary" data-i18n="common.save">Save</button>
            </div>
        </div>
    </div>

    <!-- Import Buildings Modal -->
    <div id="modal-import" class="modal-overlay">
        <div class="modal modal-wide">
            <h3>üì• <span data-i18n="import.title">Import Buildings</span></h3>
            <p class="modal-hint" data-i18n="import.hint">Import buildings from a ZIP backup file.</p>
            
            <div id="import-upload-section">
                <div class="file-upload-area" id="import-drop-zone">
                    <p>üìÅ <span data-i18n="import.drag_drop">Drag & Drop ZIP file here</span></p>
                    <p class="hint" data-i18n="import.or_click">or click to select</p>
                    <input type="file" id="import-file-input" accept=".zip" style="display: none;">
                </div>
            </div>
            
            <div id="import-preview-section" style="display: none;">
                <div class="import-file-info">
                    <span id="import-filename"></span>
                    <button id="import-clear-file" class="btn-small">‚úï</button>
                </div>
                
                <div id="import-loading" class="loading-small" style="display: none;">
                    <div class="spinner-small"></div>
                    <span data-i18n="import.analyzing">Analyzing ZIP file...</span>
                </div>
                
                <div id="import-buildings-list" style="display: none;">
                    <h4 data-i18n="import.buildings_in_zip">Buildings in ZIP:</h4>
                    <div id="import-buildings-container"></div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button id="import-cancel" class="btn btn-secondary" data-i18n="common.cancel">Cancel</button>
                <button id="import-execute" class="btn btn-primary" disabled data-i18n="import.import_selected">Import Selected</button>
            </div>
        </div>
    </div>

    <!-- Import Progress Modal -->
    <div id="modal-import-progress" class="modal-overlay">
        <div class="modal">
            <h3>üì• <span data-i18n="import.importing">Importing...</span></h3>
            <div class="progress-content">
                <div class="spinner"></div>
                <p id="import-progress-text" data-i18n="import.importing_buildings">Importing buildings...</p>
            </div>
        </div>
    </div>

    <!-- Restore from USB Modal -->
    <div id="modal-restore-usb" class="modal-overlay">
        <div class="modal modal-wide">
            <h3>üìÇ <span data-i18n="restore.title">Restore from USB</span></h3>
            <p class="modal-hint" data-i18n="restore.hint">Select a backup to restore buildings from.</p>
            
            <div id="restore-backup-section">
                <div id="restore-loading" class="loading-small">
                    <div class="spinner-small"></div>
                    <span data-i18n="restore.loading_backups">Loading backups...</span>
                </div>
                
                <div id="restore-no-backups" style="display: none;">
                    <p class="empty-hint" data-i18n="restore.no_backups">No backups found on USB stick.</p>
                </div>
                
                <div id="restore-backup-list" style="display: none;">
                    <h4 data-i18n="restore.available_backups">Available Backups:</h4>
                    <div id="restore-backup-container" class="backup-list"></div>
                </div>
            </div>
            
            <div id="restore-buildings-section" style="display: none;">
                <div class="restore-file-info">
                    <span id="restore-selected-backup"></span>
                    <button id="restore-back-btn" class="btn-small">‚Üê <span data-i18n="common.back">Back</span></button>
                </div>
                
                <div id="restore-analyze-loading" class="loading-small" style="display: none;">
                    <div class="spinner-small"></div>
                    <span data-i18n="restore.analyzing">Analyzing backup...</span>
                </div>
                
                <div id="restore-buildings-list" style="display: none;">
                    <h4 data-i18n="restore.buildings_in_backup">Buildings in Backup:</h4>
                    <div id="restore-buildings-container"></div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button id="restore-cancel" class="btn btn-secondary" data-i18n="common.cancel">Cancel</button>
                <button id="restore-execute" class="btn btn-primary" disabled data-i18n="restore.restore_selected">Restore Selected</button>
            </div>
        </div>
    </div>

    <!-- Restore Progress Modal -->
    <div id="modal-restore-progress" class="modal-overlay">
        <div class="modal">
            <h3>üìÇ <span data-i18n="restore.restoring">Restoring...</span></h3>
            <div class="progress-content">
                <div class="spinner"></div>
                <p id="restore-progress-text" data-i18n="restore.restoring_buildings">Restoring buildings...</p>
            </div>
        </div>
    </div>

    <!-- USB Format Modal -->
    <div id="modal-usb" class="modal-overlay">
        <div class="modal modal-wide">
            <h3>üîå <span data-i18n="usb.title">Format USB Stick</span></h3>
            <p class="modal-hint" data-i18n="usb.hint">Prepare USB stick for backups.</p>
            
            <div id="usb-status-container">
                <div class="loading-small">
                    <div class="spinner-small"></div>
                    <span data-i18n="usb.searching">Loading USB devices...</span>
                </div>
            </div>
            
            <div id="usb-drives-list" style="display: none;">
                <!-- USB drives will be listed here -->
            </div>
            
            <div id="usb-no-drives" class="empty-state" style="display: none;">
                <p>‚ö†Ô∏è <span data-i18n="usb.no_drives">No USB stick detected</span></p>
                <p class="hint" data-i18n="usb.no_drives_hint">Please insert USB stick and click "Refresh".</p>
            </div>
            
            <div class="btn-group">
                <button id="usb-cancel" class="btn btn-secondary" data-i18n="common.close">Close</button>
                <button id="usb-refresh" class="btn btn-secondary">üîÑ <span data-i18n="common.refresh">Refresh</span></button>
            </div>
        </div>
    </div>

    <!-- Language Modal -->
    <div id="modal-language" class="modal-overlay">
        <div class="modal">
            <h3>üåê <span data-i18n="language_modal.title">Language</span></h3>
            <p class="modal-hint" data-i18n="language_modal.hint">Select interface language.</p>
            
            <div class="language-options">
                <label class="language-option">
                    <input type="radio" name="language" value="en">
                    <span>üá¨üáß English</span>
                </label>
                <label class="language-option">
                    <input type="radio" name="language" value="de">
                    <span>üá©üá™ Deutsch</span>
                </label>
                <label class="language-option">
                    <input type="radio" name="language" value="fr">
                    <span>üá´üá∑ Fran√ßais</span>
                </label>
                <label class="language-option">
                    <input type="radio" name="language" value="it">
                    <span>üáÆüáπ Italiano</span>
                </label>
                <label class="language-option">
                    <input type="radio" name="language" value="nl">
                    <span>üá≥üá± Nederlands</span>
                </label>
            </div>
            
            <div class="btn-group">
                <button id="language-cancel" class="btn btn-secondary" data-i18n="common.close">Close</button>
                <button id="language-save" class="btn btn-primary" data-i18n="common.save">Save</button>
            </div>
        </div>
    </div>

    <!-- Update Modal -->
    <div id="modal-update" class="modal-overlay">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="margin: 0;" data-i18n="update.title">üì¶ Stagebox Update</h3>
                <button class="modal-close" onclick="closeUpdateModal()" style="background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Checking state -->
                <div id="update-checking" style="text-align: center; padding: 2rem;">
                    <div class="spinner"></div>
                    <p style="margin-top: 1rem;" data-i18n="update.checking">Checking for updates...</p>
                </div>
                
                <!-- No update available -->
                <div id="update-current" style="display: none; text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
                    <h4 data-i18n="update.up_to_date">You're up to date!</h4>
                    <p style="color: var(--text-secondary); margin-top: 0.5rem;">
                        <span data-i18n="update.version_latest">Version</span> <span id="update-current-version"></span> <span data-i18n="update.is_latest">is the latest version.</span>
                    </p>
                </div>
                
                <!-- Update available -->
                <div id="update-available" style="display: none;">
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">üì¶</div>
                        <h4 data-i18n="update.available">Update Available!</h4>
                    </div>
                    
                    <div style="background: var(--bg-secondary); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--text-secondary);" data-i18n="update.current">Current:</span>
                            <span id="update-from-version">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--text-secondary);" data-i18n="update.new">New:</span>
                            <span id="update-to-version" style="color: var(--accent-success); font-weight: 600;">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--text-secondary);" data-i18n="update.released">Released:</span>
                            <span id="update-date">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-secondary);" data-i18n="update.size">Size:</span>
                            <span id="update-size">-</span>
                        </div>
                    </div>
                    
                    <div id="update-notes-container" style="margin-bottom: 1rem;">
                        <h5 style="margin-bottom: 0.5rem; color: var(--text-secondary);" data-i18n="update.release_notes">Release Notes:</h5>
                        <div id="update-notes" style="background: var(--bg-secondary); border-radius: 8px; padding: 1rem; font-size: 0.9rem; max-height: 150px; overflow-y: auto;">
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0;" data-i18n="update.backup_warning">
                            ‚ö†Ô∏è A backup will be created before updating. The web interface will restart after installation.
                        </p>
                    </div>
                    
                    <!-- LTE Warning -->
                    <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.75rem 1rem; margin-bottom: 1rem;">
                        <p style="font-size: 0.8rem; color: var(--text-secondary); margin: 0;" data-i18n="update.lte_warning">
                            üì∂ On slow/mobile connections the download may take longer.
                        </p>
                    </div>
                </div>
                
                <!-- Installing state -->
                <div id="update-installing" style="display: none; text-align: center; padding: 2rem;">
                    <div class="spinner"></div>
                    <p style="margin-top: 1rem;" id="update-install-status" data-i18n="update.downloading">Downloading update...</p>
                    <p style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.5rem;" data-i18n="update.do_not_close">
                        Please do not close this window.
                    </p>
                </div>
                
                <!-- Error state -->
                <div id="update-error" style="display: none; text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">‚ùå</div>
                    <h4 data-i18n="update.failed">Update Failed</h4>
                    <p id="update-error-message" style="color: var(--accent-danger); margin-top: 0.5rem;"></p>
                </div>
                
                <!-- Success state -->
                <div id="update-success" style="display: none; text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üéâ</div>
                    <h4 data-i18n="update.success">Update Successful!</h4>
                    <p style="color: var(--text-secondary); margin-top: 0.5rem;">
                        <span data-i18n="update.updated_to">Updated to version</span> <span id="update-new-version"></span>
                    </p>
                    <p style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.5rem;" data-i18n="update.reloading">
                        The page will reload in a few seconds...
                    </p>
                </div>
            </div>
            <div class="btn-group" style="margin-top: 1rem;">
                <button id="update-close-btn" class="btn btn-secondary" onclick="closeUpdateModal()" data-i18n="common.close">Close</button>
                <button id="update-install-btn" class="btn btn-primary" onclick="installUpdate()" style="display: none;" data-i18n="update.install">
                    ‚¨áÔ∏è Install Update
                </button>
            </div>
        </div>
    </div>

    <!-- System Updates Modal -->
    <div id="modal-system-updates" class="modal-overlay">
        <div class="modal" style="max-width: 550px; max-height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-shrink: 0;">
                <h3 style="margin: 0;" data-i18n="sysupdate.title">üñ•Ô∏è System Updates</h3>
                <button class="modal-close" onclick="closeSystemUpdatesModal()" style="background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            <div class="modal-body" style="overflow-y: auto; flex: 1; min-height: 0;">
                <!-- Checking state -->
                <div id="sysupdate-checking" style="text-align: center; padding: 2rem;">
                    <div class="spinner"></div>
                    <p style="margin-top: 1rem;" data-i18n="sysupdate.checking">Checking for system updates...</p>
                </div>
                
                <!-- No updates available -->
                <div id="sysupdate-current" style="display: none; text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
                    <h4 data-i18n="sysupdate.up_to_date">System is up to date!</h4>
                    <p style="color: var(--text-secondary); margin-top: 0.5rem;" data-i18n="sysupdate.all_current">
                        All packages are current.
                    </p>
                </div>
                
                <!-- Updates available -->
                <div id="sysupdate-available" style="display: none;">
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">üì¶</div>
                        <h4 data-i18n="sysupdate.available">System Updates Available</h4>
                    </div>
                    
                    <!-- Required packages (new Stagebox features) -->
                    <div id="sysupdate-required-section" style="display: none; margin-bottom: 1rem;">
                        <div style="background: rgba(255, 82, 82, 0.1); border: 2px solid var(--accent-danger); border-radius: 8px; padding: 1rem;">
                            <div style="display: flex; align-items: center; margin-bottom: 0.75rem;">
                                <span style="font-size: 1.2rem; margin-right: 0.5rem;">‚ö†Ô∏è</span>
                                <strong style="color: var(--accent-danger);" data-i18n="sysupdate.required">Required Dependencies</strong>
                            </div>
                            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.75rem;" data-i18n="sysupdate.required_hint">
                                These packages are needed for new Stagebox features.
                            </p>
                            <div id="sysupdate-required-packages" style="background: var(--bg-primary); border-radius: 4px; padding: 0.75rem; font-size: 0.85rem; max-height: 120px; overflow-y: auto; font-family: monospace;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Regular updates summary -->
                    <div id="sysupdate-regular-section" style="background: var(--bg-secondary); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--text-secondary);" data-i18n="sysupdate.security">üîí Security:</span>
                            <span id="sysupdate-security-count" style="color: var(--accent-danger); font-weight: 600;">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-secondary);" data-i18n="sysupdate.system">‚öôÔ∏è System:</span>
                            <span id="sysupdate-system-count">0</span>
                        </div>
                    </div>
                    
                    <!-- Package list -->
                    <div id="sysupdate-packages-container" style="margin-bottom: 1rem;">
                        <h5 style="margin-bottom: 0.5rem; color: var(--text-secondary);" data-i18n="sysupdate.packages">Packages:</h5>
                        <div id="sysupdate-packages" style="background: var(--bg-secondary); border-radius: 8px; padding: 1rem; font-size: 0.85rem; max-height: 200px; overflow-y: auto; font-family: monospace;">
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0;" data-i18n="sysupdate.reboot_warning">
                            ‚ö†Ô∏è System will reboot after installing updates if required.
                        </p>
                    </div>
                    
                    <!-- LTE Warning -->
                    <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.75rem 1rem; margin-bottom: 1rem;">
                        <p style="font-size: 0.8rem; color: var(--text-secondary); margin: 0;" data-i18n="sysupdate.lte_not_recommended">
                            üì∂ On slow/mobile connections this may take longer.
                        </p>
                    </div>
                </div>
                
                <!-- Installing state -->
                <div id="sysupdate-installing" style="display: none; text-align: center; padding: 2rem;">
                    <div class="spinner"></div>
                    <p style="margin-top: 1rem;" id="sysupdate-install-status" data-i18n="sysupdate.installing">Installing updates...</p>
                    <p style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.5rem;" data-i18n="sysupdate.please_wait">
                        This may take several minutes. Please wait.
                    </p>
                    <p style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 1rem;" data-i18n="sysupdate.lte_warning">
                        üì∂ On slow connections this may take up to 30 minutes.
                    </p>
                </div>
                
                <!-- Error state -->
                <div id="sysupdate-error" style="display: none; text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">‚ùå</div>
                    <h4 data-i18n="sysupdate.failed">Update Failed</h4>
                    <p id="sysupdate-error-message" style="color: var(--accent-danger); margin-top: 0.5rem;"></p>
                </div>
                
                <!-- Success state -->
                <div id="sysupdate-success" style="display: none; text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üéâ</div>
                    <h4 data-i18n="sysupdate.success">Updates Installed!</h4>
                    <p id="sysupdate-success-message" style="color: var(--text-secondary); margin-top: 0.5rem;"></p>
                </div>
            </div>
            <div class="btn-group" style="margin-top: 1rem; flex-shrink: 0;">
                <button id="sysupdate-close-btn" class="btn btn-secondary" onclick="closeSystemUpdatesModal()" data-i18n="common.close">Close</button>
                <button id="sysupdate-install-required-btn" class="btn btn-danger" onclick="installRequiredPackages()" style="display: none;" data-i18n="sysupdate.install_required">
                    ‚ö†Ô∏è Install Required
                </button>
                <button id="sysupdate-install-btn" class="btn btn-primary" onclick="installSystemUpdates()" style="display: none;" data-i18n="sysupdate.install">
                    ‚¨áÔ∏è Install All
                </button>
            </div>
        </div>
    </div>

    <!-- Installer Profile Modal -->
    <div id="modal-installer-profile" class="modal-overlay">
        <div class="modal modal-wide">
            <h3>üë§ <span data-i18n="installer_profile.title">Installer Profile</span></h3>
            <p class="modal-hint" data-i18n="installer_profile.hint">Company information for installation reports.</p>
            
            <div class="installer-profile-content">
                <!-- Logo Section -->
                <div class="logo-section">
                    <div class="logo-preview-container">
                        <div id="installer-logo-preview" class="logo-preview">
                            <span class="logo-placeholder" data-i18n="installer_profile.no_logo">No logo</span>
                        </div>
                        <div class="logo-actions">
                            <input type="file" id="logo-file-input" accept="image/png,image/jpeg,image/jpg" style="display: none;">
                            <button id="btn-upload-logo" class="btn btn-secondary btn-small">
                                üì§ <span data-i18n="installer_profile.upload_logo">Upload Logo</span>
                            </button>
                            <button id="btn-delete-logo" class="btn btn-danger btn-small" style="display: none;">
                                üóëÔ∏è <span data-i18n="installer_profile.delete_logo">Delete</span>
                            </button>
                        </div>
                        <p class="logo-hint" data-i18n="installer_profile.logo_hint">PNG or JPG, max 800x400px, 2MB</p>
                    </div>
                </div>
                
                <!-- Profile Fields -->
                <div class="profile-fields">
                    <div class="form-group">
                        <label for="installer-company" data-i18n="installer_profile.company_name">Company Name</label>
                        <input type="text" id="installer-company" maxlength="200" data-i18n-placeholder="installer_profile.company_placeholder" placeholder="e.g. Elektro M√ºller AG">
                    </div>
                    <div class="form-group">
                        <label for="installer-address" data-i18n="installer_profile.address">Address</label>
                        <textarea id="installer-address" rows="2" maxlength="500" data-i18n-placeholder="installer_profile.address_placeholder" placeholder="Street, ZIP City"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="installer-phone" data-i18n="installer_profile.phone">Phone</label>
                            <input type="tel" id="installer-phone" maxlength="50" data-i18n-placeholder="installer_profile.phone_placeholder" placeholder="+41 44 123 45 67">
                        </div>
                        <div class="form-group">
                            <label for="installer-email" data-i18n="installer_profile.email">Email</label>
                            <input type="email" id="installer-email" maxlength="100" data-i18n-placeholder="installer_profile.email_placeholder" placeholder="info@example.ch">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="installer-website" data-i18n="installer_profile.website">Website</label>
                        <input type="url" id="installer-website" maxlength="100" data-i18n-placeholder="installer_profile.website_placeholder" placeholder="www.example.ch">
                    </div>
                </div>
            </div>
            
            <div id="installer-profile-error" class="error-message" style="display: none;"></div>
            
            <div class="btn-group">
                <button id="installer-profile-cancel" class="btn btn-secondary" data-i18n="common.cancel">Cancel</button>
                <button id="installer-profile-save" class="btn btn-primary" data-i18n="common.save">Save</button>
            </div>
        </div>
    </div>

    <!-- i18n Script -->
    <script src="{{ url_for('static', filename='js/i18n.js') }}"></script>
    
    <script>
        let selectedBuilding = null;
        let pendingAction = null;
        let isAdminAuthenticated = false;
        let pinAction = null; // 'login', 'setup', 'change'

        // Simple toast notification
        function showToast(message, type = 'info', duration = 3000) {
            // Remove existing toast
            const existing = document.querySelector('.toast-notification');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.textContent = message;
            
            // Color based on type
            let bgColor = '#2196f3'; // info (blue)
            if (type === 'success') bgColor = '#4caf50'; // green
            else if (type === 'error') bgColor = '#f44336'; // red
            else if (type === 'warning') bgColor = '#ff9800'; // orange
            
            toast.style.background = bgColor;
            document.body.appendChild(toast);
            
            // Trigger show animation
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Load buildings on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize i18n first
            await i18n.init();
            
            await loadDeviceId();
            await loadEditionInfo();
            await checkAdminStatus();
            await loadBuildings();
            
            // Update manual link with current language
            updateManualLink();
            
            // Check for updates in background (non-blocking)
            checkForUpdatesBackground();
        });
        
        async function loadEditionInfo() {
            try {
                const response = await fetch('/api/system/version');
                const data = await response.json();
                
                if (data.success) {
                    const badge = document.getElementById('edition-badge');
                    if (badge) {
                        badge.textContent = data.edition_name || '';
                        badge.className = 'edition-badge edition-' + (data.edition || 'pro').toLowerCase();
                    }
                    // Store for later use
                    window.stageboxEdition = data.edition;
                    window.stageboxIsPro = data.is_pro;
                    
                    // Disable Pro-only features in Personal edition
                    if (!data.is_pro) {
                        disableProFeatures();
                    }
                }
            } catch (error) {
                console.error('Error loading edition info:', error);
            }
        }
        
        function disableProFeatures() {
            // Find all buttons with data-pro-only="true" (disable + grey out)
            const proButtons = document.querySelectorAll('[data-pro-only="true"]');
            
            proButtons.forEach(btn => {
                btn.classList.add('pro-disabled');
                btn.disabled = true;
                btn.title = 'This feature requires Stagebox Pro';
                
                // Prevent click events (only if still disabled)
                btn.addEventListener('click', (e) => {
                    if (btn.classList.contains('pro-disabled')) {
                        e.preventDefault();
                        e.stopPropagation();
                        showToast('This feature requires Stagebox Pro', 'warning');
                    }
                }, true);
            });
            
            // Find all elements with data-pro-only="hide" (completely hide)
            const hideElements = document.querySelectorAll('[data-pro-only="hide"]');
            hideElements.forEach(el => {
                el.style.display = 'none';
            });
            
            // Personal Edition: No PIN system
            // - Hide Admin login button
            // - Show Admin panel always (no authentication needed)
            // - Hide Logout button
            const adminBtn = document.getElementById('btn-admin');
            const adminPanel = document.getElementById('admin-panel');
            const logoutBtn = document.getElementById('btn-logout');
            
            if (adminBtn) adminBtn.style.display = 'none';
            if (adminPanel) adminPanel.classList.add('active');
            if (logoutBtn) logoutBtn.style.display = 'none';
            
            // Personal Edition: Change button texts (single building)
            const exportBtn = document.getElementById('btn-export-buildings');
            const importBtn = document.getElementById('btn-import-buildings');
            if (exportBtn) exportBtn.innerHTML = 'üì§ Export Building';
            if (importBtn) importBtn.innerHTML = 'üì• Import Building';
            
            // Override isAdminAuthenticated for Personal edition
            window.isAdminAuthenticated = true;
            
            console.log(`Disabled ${proButtons.length} Pro-only features, hidden ${hideElements.length} elements`);
        }
        
        function updateManualLink() {
            const lang = i18n.getLanguage();
            const manualLink = document.getElementById('manual-link');
            if (manualLink && lang !== 'en') {
                manualLink.href = `/manual?lang=${lang}`;
            }
        }

        async function loadDeviceId() {
            try {
                const response = await fetch('/api/system/device-id');
                const data = await response.json();
                
                if (data.success && data.device_id) {
                    const el = document.getElementById('device-id');
                    if (el) el.textContent = data.device_id;
                }
            } catch (error) {
                console.error('Error loading device ID:', error);
            }
        }

        async function checkAdminStatus() {
            // Skip admin check in Personal edition (no PIN system)
            // window.stageboxIsPro is set by loadEditionInfo() which runs before this
            if (window.stageboxIsPro === false) {
                isAdminAuthenticated = true;
                return;
            }
            
            try {
                const response = await fetch('/api/admin/status');
                if (!response.ok) {
                    // Admin routes not available (Personal edition or error)
                    isAdminAuthenticated = true;
                    return;
                }
                const data = await response.json();
                
                isAdminAuthenticated = data.authenticated;
                updateAdminUI(data.authenticated, data.pin_set);
            } catch (error) {
                console.error('Error checking admin status:', error);
                // Fallback: assume authenticated in case of error
                isAdminAuthenticated = true;
            }
        }

        function updateAdminUI(authenticated, pinSet) {
            const adminBtn = document.getElementById('btn-admin');
            const adminPanel = document.getElementById('admin-panel');
            
            if (authenticated) {
                adminBtn.setAttribute('data-i18n', 'admin.title_unlocked');
                adminBtn.textContent = t('admin.title_unlocked');
                adminBtn.classList.add('authenticated');
                adminPanel.classList.add('active');
            } else {
                adminBtn.setAttribute('data-i18n', 'admin.login');
                adminBtn.textContent = t('admin.login');
                adminBtn.classList.remove('authenticated');
                adminPanel.classList.remove('active');
            }
        }

        async function loadBuildings() {
            const container = document.getElementById('building-grid');
            
            try {
                const response = await fetch('/api/buildings');
                const data = await response.json();
                
                if (!data.success) {
                    container.innerHTML = '<div class="no-buildings">Error loading</div>';
                    return;
                }
                
                if (data.buildings.length === 0) {
                    container.innerHTML = '<div class="no-buildings">No buildings found.<br>Create a building in the Admin section.</div>';
                    
                    // Enable "New Building" button even in limited editions if no buildings exist
                    const createBtn = document.getElementById('btn-create-building');
                    if (createBtn && createBtn.classList.contains('pro-disabled')) {
                        createBtn.classList.remove('pro-disabled');
                        createBtn.disabled = false;
                        createBtn.title = '';
                    }
                    return;
                }
                
                container.innerHTML = data.buildings.map(b => {
                    // Format IP range compactly: "50.1 - 99"
                    const poolStart = b.pool_start || '?';
                    const poolEndShort = (b.pool_end || '').split('.').pop();
                    const ipRange = `${poolStart} - ${poolEndShort}`;
                    
                    return `
                        <div class="building-card" data-name="${b.name}" onclick="selectBuilding('${b.name}')" ondblclick="openBuilding('${b.name}')">
                            <div class="name">
                                ${b.name}
                                ${isAdminAuthenticated ? `
                                    <span class="card-actions">
                                        <button class="action-btn rename-btn" onclick="event.stopPropagation(); renameBuilding('${b.name}')" title="${t('building.rename')}">‚úèÔ∏è</button>
                                        <button class="action-btn delete-btn" onclick="event.stopPropagation(); deleteBuilding('${b.name}')" title="${t('building.delete')}">üóëÔ∏è</button>
                                    </span>
                                ` : ''}
                            </div>
                            <div class="info">
                                <span class="ip-range">${ipRange}</span>
                            </div>
                            <div class="device-count">${b.device_count || 0} Devices</div>
                        </div>
                    `;
                }).join('');
                
                // Auto-select if only one building
                if (data.buildings.length === 1) {
                    selectBuilding(data.buildings[0].name);
                }
                
                // Re-disable "New Building" in limited editions when building(s) exist
                const createBtn = document.getElementById('btn-create-building');
                if (createBtn && !window.stageboxIsPro && data.buildings.length >= 1) {
                    createBtn.classList.add('pro-disabled');
                    createBtn.disabled = true;
                    createBtn.title = 'Limited to 1 building in this edition';
                }
                
            } catch (error) {
                console.error('Error loading buildings:', error);
                container.innerHTML = '<div class="no-buildings">Connection error</div>';
            }
        }

        function selectBuilding(name) {
            selectedBuilding = name;
            
            document.querySelectorAll('.building-card').forEach(el => {
                el.classList.toggle('selected', el.dataset.name === name);
            });
            
            document.getElementById('btn-open').disabled = false;
        }

        // Open building directly (double-click)
        async function openBuilding(name) {
            selectedBuilding = name;
            
            const btn = document.getElementById('btn-open');
            btn.disabled = true;
            btn.textContent = 'Opening...';
            
            try {
                const response = await fetch('/api/buildings/activate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name })
                });
                
                const data = await response.json();
                if (data.success) {
                    window.location.href = '/';
                } else {
                    alert('Error: ' + data.error);
                    btn.disabled = false;
                    btn.textContent = 'Open';
                }
            } catch (error) {
                alert('Connection error');
                btn.disabled = false;
                btn.textContent = 'Open';
            }
        }

        // Open building
        document.getElementById('btn-open').addEventListener('click', async () => {
            if (!selectedBuilding) return;
            
            const btn = document.getElementById('btn-open');
            btn.disabled = true;
            btn.textContent = 'Opening...';
            
            try {
                const response = await fetch('/api/buildings/activate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: selectedBuilding })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('Error: ' + data.error);
                    btn.disabled = false;
                    btn.textContent = '√ñffnen ‚Üí';
                }
            } catch (error) {
                alert('Connection error');
                btn.disabled = false;
                btn.textContent = '√ñffnen ‚Üí';
            }
        });

        // Reboot
        document.getElementById('btn-reboot').addEventListener('click', () => {
            showConfirmModal('Reboot System', 'Do you really want to reboot the Stagebox?', 'reboot');
        });

        // Shutdown
        document.getElementById('btn-shutdown').addEventListener('click', () => {
            showConfirmModal('Shutdown System', 'Do you really want to shut down the Stagebox?', 'shutdown');
        });

        // Admin button
        document.getElementById('btn-admin').addEventListener('click', async () => {
            if (isAdminAuthenticated) {
                // Already authenticated - scroll to admin panel
                document.getElementById('admin-panel').scrollIntoView({ behavior: 'smooth' });
            } else {
                // Check if PIN is set
                const response = await fetch('/api/admin/status');
                const data = await response.json();
                
                if (data.pin_set) {
                    pinAction = 'login';
                    document.getElementById('pin-modal-title').textContent = 'Enter Admin PIN';
                } else {
                    pinAction = 'setup';
                    document.getElementById('pin-modal-title').textContent = 'Create Admin PIN';
                }
                
                document.getElementById('pin-input').value = '';
                document.getElementById('pin-error').style.display = 'none';
                document.getElementById('modal-pin').classList.add('active');
                document.getElementById('pin-input').focus();
            }
        });

        // Logout
        document.getElementById('btn-logout').addEventListener('click', async () => {
            try {
                await fetch('/api/admin/logout', { method: 'POST' });
                isAdminAuthenticated = false;
                updateAdminUI(false, true);
                await loadBuildings(); // Reload to remove delete buttons
            } catch (error) {
                console.error('Error logging out:', error);
            }
        });

        // PIN Modal
        document.getElementById('pin-cancel').addEventListener('click', () => {
            document.getElementById('modal-pin').classList.remove('active');
        });

        document.getElementById('pin-submit').addEventListener('click', submitPin);
        document.getElementById('pin-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') submitPin();
        });

        async function submitPin() {
            const pin = document.getElementById('pin-input').value;
            const errorEl = document.getElementById('pin-error');
            
            if (!pin || pin.length < 4) {
                errorEl.textContent = 'PIN muss mindestens 4 Zeichen haben';
                errorEl.style.display = 'block';
                return;
            }
            
            try {
                const endpoint = pinAction === 'setup' ? '/api/admin/setup-pin' : '/api/admin/authenticate';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pin })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('modal-pin').classList.remove('active');
                    isAdminAuthenticated = true;
                    updateAdminUI(true, true);
                    await loadBuildings(); // Reload to show delete buttons
                } else {
                    errorEl.textContent = data.error || 'Falscher PIN';
                    errorEl.style.display = 'block';
                    document.getElementById('pin-input').classList.add('error');
                }
            } catch (error) {
                errorEl.textContent = 'Connection error';
                errorEl.style.display = 'block';
            }
        }

        // Create Building
        document.getElementById('btn-create-building').addEventListener('click', () => {
            document.getElementById('building-name-input').value = '';
            document.getElementById('building-name-error').style.display = 'none';
            document.getElementById('modal-create-building').classList.add('active');
            document.getElementById('building-name-input').focus();
        });

        document.getElementById('create-building-cancel').addEventListener('click', () => {
            document.getElementById('modal-create-building').classList.remove('active');
        });

        document.getElementById('create-building-submit').addEventListener('click', createBuilding);
        document.getElementById('building-name-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') createBuilding();
        });

        async function createBuilding() {
            let name = document.getElementById('building-name-input').value.trim();
            const errorEl = document.getElementById('building-name-error');
            
            if (!name) {
                errorEl.textContent = 'Name erforderlich';
                errorEl.style.display = 'block';
                return;
            }
            
            // Normalize name: lowercase, spaces to underscores
            name = name.toLowerCase().replace(/\s+/g, '_').replace(/-/g, '_');
            name = name.replace(/[^a-z0-9_]/g, '').replace(/_+/g, '_').replace(/^_|_$/g, '');
            
            if (!name) {
                errorEl.textContent = 'Invalid name';
                errorEl.style.display = 'block';
                return;
            }
            
            const btn = document.getElementById('create-building-submit');
            btn.disabled = true;
            btn.textContent = 'Creating...';
            
            try {
                const response = await fetch('/api/admin/buildings/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Get the normalized name from server
                    const createdName = data.name || name;
                    
                    // Auto-activate the new building
                    const activateResponse = await fetch('/api/buildings/activate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: createdName })
                    });
                    
                    const activateData = await activateResponse.json();
                    
                    if (activateData.success) {
                        // Redirect to main UI with ?new=1 to trigger settings dialog
                        window.location.href = '/?new=1';
                    } else {
                        // Activation failed, but building was created
                        document.getElementById('modal-create-building').classList.remove('active');
                        await loadBuildings();
                        showToast(`Building "${createdName}" created. Please open it manually.`);
                    }
                } else {
                    errorEl.textContent = data.error || 'Error creating building';
                    errorEl.style.display = 'block';
                }
            } catch (error) {
                errorEl.textContent = 'Connection error';
                errorEl.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create';
            }
        }
        
        // Toast notification helper
        // showToast is defined earlier in the file

        // Delete Building
        async function deleteBuilding(name) {
            if (!confirm(t('building.confirm_delete', {name: name}))) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/buildings/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    await loadBuildings();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Connection error');
            }
        }

        // Rename Building
        function renameBuilding(name) {
            document.getElementById('rename-old-name').value = name;
            document.getElementById('rename-new-name').value = name;
            document.getElementById('rename-error').style.display = 'none';
            document.getElementById('modal-rename').classList.add('active');
            
            const input = document.getElementById('rename-new-name');
            input.focus();
            input.select();
        }

        document.getElementById('rename-cancel').addEventListener('click', () => {
            document.getElementById('modal-rename').classList.remove('active');
        });

        document.getElementById('rename-submit').addEventListener('click', async () => {
            const oldName = document.getElementById('rename-old-name').value;
            const newName = document.getElementById('rename-new-name').value.trim();
            
            if (!newName) {
                document.getElementById('rename-error').textContent = t('building.error_name_required');
                document.getElementById('rename-error').style.display = 'block';
                return;
            }
            
            try {
                const response = await fetch('/api/admin/buildings/rename', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ old_name: oldName, new_name: newName })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('modal-rename').classList.remove('active');
                    showToast(t('building.rename_success'), 'success');
                    await loadBuildings();
                } else {
                    document.getElementById('rename-error').textContent = data.error;
                    document.getElementById('rename-error').style.display = 'block';
                }
            } catch (error) {
                document.getElementById('rename-error').textContent = 'Connection error';
                document.getElementById('rename-error').style.display = 'block';
            }
        });

        // Change PIN
        document.getElementById('btn-change-pin').addEventListener('click', () => {
            document.getElementById('new-pin-input').value = '';
            document.getElementById('confirm-pin-input').value = '';
            document.getElementById('change-pin-error').style.display = 'none';
            document.getElementById('modal-change-pin').classList.add('active');
            document.getElementById('new-pin-input').focus();
        });

        document.getElementById('change-pin-cancel').addEventListener('click', () => {
            document.getElementById('modal-change-pin').classList.remove('active');
        });

        document.getElementById('change-pin-submit').addEventListener('click', changePIN);

        async function changePIN() {
            const newPin = document.getElementById('new-pin-input').value;
            const confirmPin = document.getElementById('confirm-pin-input').value;
            const errorEl = document.getElementById('change-pin-error');
            
            if (!newPin || newPin.length < 4) {
                errorEl.textContent = 'PIN muss mindestens 4 Zeichen haben';
                errorEl.style.display = 'block';
                return;
            }
            
            if (newPin !== confirmPin) {
                errorEl.textContent = 'PINs do not match';
                errorEl.style.display = 'block';
                return;
            }
            
            try {
                const response = await fetch('/api/admin/change-pin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_pin: newPin })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('modal-change-pin').classList.remove('active');
                    alert('PIN changed.');
                } else {
                    errorEl.textContent = data.error || 'Error changing';
                    errorEl.style.display = 'block';
                }
            } catch (error) {
                errorEl.textContent = 'Connection error';
                errorEl.style.display = 'block';
            }
        }

        // Confirm Modal functions
        function showConfirmModal(title, message, action) {
            pendingAction = action;
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal-confirm-btn').style.display = 'block';
            document.getElementById('modal-confirm-btn').disabled = false;
            document.getElementById('modal-cancel').textContent = 'Cancel';
            document.getElementById('modal-confirm').classList.add('active');
        }

        document.getElementById('modal-cancel').addEventListener('click', () => {
            document.getElementById('modal-confirm').classList.remove('active');
            pendingAction = null;
            // Reset modal state for next use
            document.getElementById('modal-confirm-btn').style.display = '';
            document.getElementById('modal-confirm-btn').disabled = false;
            document.getElementById('modal-cancel').textContent = 'Cancel';
        });

        document.getElementById('modal-confirm-btn').addEventListener('click', async () => {
            if (pendingAction === 'reboot') {
                try {
                    await fetch('/api/system/reboot', { method: 'POST' });
                    document.getElementById('modal-message').textContent = 'System is rebooting...';
                    document.getElementById('modal-confirm-btn').style.display = 'none';
                    document.getElementById('modal-cancel').textContent = 'OK';
                } catch (error) {
                    alert('Error restarting');
                }
            } else if (pendingAction === 'shutdown') {
                try {
                    await fetch('/api/system/shutdown', { method: 'POST' });
                    document.getElementById('modal-message').textContent = 'System is shutting down...';
                    document.getElementById('modal-confirm-btn').style.display = 'none';
                    document.getElementById('modal-cancel').textContent = 'OK';
                } catch (error) {
                    alert('Error shutting down');
                }
            } else if (pendingAction === 'backup-usb') {
                try {
                    document.getElementById('modal-message').textContent = t('system.backup_in_progress');
                    document.getElementById('modal-confirm-btn').disabled = true;
                    const response = await fetch('/api/system/backup/usb', { method: 'POST' });
                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('modal-message').textContent = 
                            t('system.backup_success') + (data.backup_count ? ` (${data.backup_count} ${t('system.backups_on_usb')})` : '');
                    } else {
                        document.getElementById('modal-message').textContent = 
                            t('system.backup_failed') + ': ' + (data.error || '');
                    }
                } catch (error) {
                    document.getElementById('modal-message').textContent = t('system.backup_failed');
                }
                document.getElementById('modal-confirm-btn').style.display = 'none';
                document.getElementById('modal-cancel').textContent = 'OK';
            }
            pendingAction = null;
        });

        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    e.currentTarget.classList.remove('active');
                    pendingAction = null;
                }
            });
        });

        // =====================================================================
        // Backup Buttons (System Section)
        // =====================================================================
        
        document.getElementById('btn-backup-usb').addEventListener('click', async () => {
            showConfirmModal(t('system.backup_usb'), t('system.confirm_backup_usb'), 'backup-usb');
        });
        
        document.getElementById('btn-restore-usb').addEventListener('click', openRestoreModal);
        document.getElementById('restore-cancel').addEventListener('click', closeRestoreModal);
        document.getElementById('restore-back-btn').addEventListener('click', backToBackupList);
        document.getElementById('restore-execute').addEventListener('click', executeRestore);
        
        let restoreSelectedBackup = null;
        let restoreBuildings = [];
        
        function openRestoreModal() {
            resetRestoreState();
            document.getElementById('modal-restore-usb').classList.add('active');
            loadUsbBackups();
        }
        
        function closeRestoreModal() {
            document.getElementById('modal-restore-usb').classList.remove('active');
            resetRestoreState();
        }
        
        function resetRestoreState() {
            restoreSelectedBackup = null;
            restoreBuildings = [];
            document.getElementById('restore-backup-section').style.display = 'block';
            document.getElementById('restore-buildings-section').style.display = 'none';
            document.getElementById('restore-execute').disabled = true;
            document.getElementById('restore-loading').style.display = 'flex';
            document.getElementById('restore-no-backups').style.display = 'none';
            document.getElementById('restore-backup-list').style.display = 'none';
        }
        
        function backToBackupList() {
            restoreSelectedBackup = null;
            restoreBuildings = [];
            document.getElementById('restore-backup-section').style.display = 'block';
            document.getElementById('restore-buildings-section').style.display = 'none';
            document.getElementById('restore-execute').disabled = true;
        }
        
        async function loadUsbBackups() {
            document.getElementById('restore-loading').style.display = 'flex';
            document.getElementById('restore-no-backups').style.display = 'none';
            document.getElementById('restore-backup-list').style.display = 'none';
            
            try {
                const response = await fetch('/api/system/backup/usb/list');
                const data = await response.json();
                
                document.getElementById('restore-loading').style.display = 'none';
                
                if (!data.success) {
                    // USB stick not found or other error
                    document.getElementById('restore-no-backups').innerHTML = 
                        `<p class="empty-hint">‚ö†Ô∏è ${data.error || t('restore.usb_not_found')}</p>`;
                    document.getElementById('restore-no-backups').style.display = 'block';
                } else if (data.backups && data.backups.length > 0) {
                    renderBackupList(data.backups, data.own_mac_suffix);
                    document.getElementById('restore-backup-list').style.display = 'block';
                } else {
                    // Stick found but no backups
                    document.getElementById('restore-no-backups').innerHTML = 
                        `<p class="empty-hint">${t('restore.no_backups')}</p>`;
                    document.getElementById('restore-no-backups').style.display = 'block';
                }
            } catch (error) {
                document.getElementById('restore-loading').style.display = 'none';
                showToast(t('restore.load_failed') + ': ' + error.message, 'error');
            }
        }
        
        function renderBackupList(backups, ownMacSuffix) {
            const container = document.getElementById('restore-backup-container');
            container.innerHTML = backups.map(b => {
                const isOwnDevice = b.mac_suffix === ownMacSuffix;
                const sourceLabel = isOwnDevice 
                    ? '<span class="backup-source own">üìç this device</span>'
                    : `<span class="backup-source other">üì¶ ${b.mac_suffix}</span>`;
                return `
                <div class="backup-item ${isOwnDevice ? 'own-device' : ''}" data-path="${b.path}" onclick="selectBackup(this, '${b.path}')">
                    <input type="radio" name="restore-backup" value="${b.path}">
                    <div class="backup-info">
                        <div class="backup-filename">${b.filename}</div>
                        <div class="backup-details">
                            <span class="backup-date">${b.date}</span> ¬∑ ${b.size} ${sourceLabel}
                        </div>
                    </div>
                </div>
            `}).join('');
        }
        
        function selectBackup(element, path) {
            // Update UI selection
            document.querySelectorAll('.backup-item').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            element.querySelector('input[type="radio"]').checked = true;
            
            restoreSelectedBackup = path;
            
            // Analyze the selected backup
            analyzeBackup(path);
        }
        
        async function analyzeBackup(path) {
            document.getElementById('restore-backup-section').style.display = 'none';
            document.getElementById('restore-buildings-section').style.display = 'block';
            document.getElementById('restore-analyze-loading').style.display = 'flex';
            document.getElementById('restore-buildings-list').style.display = 'none';
            
            // Show selected backup filename
            const filename = path.split('/').pop();
            document.getElementById('restore-selected-backup').textContent = filename;
            
            try {
                const response = await fetch('/api/system/backup/usb/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: path })
                });
                const data = await response.json();
                
                document.getElementById('restore-analyze-loading').style.display = 'none';
                
                if (data.success) {
                    restoreBuildings = data.buildings;
                    renderRestoreBuildings(data.buildings, data.existing);
                    document.getElementById('restore-buildings-list').style.display = 'block';
                } else {
                    showToast('Analysis failed: ' + (data.error || 'Unknown'), 'error');
                    backToBackupList();
                }
            } catch (error) {
                document.getElementById('restore-analyze-loading').style.display = 'none';
                showToast('Analysis failed: ' + error.message, 'error');
                backToBackupList();
            }
        }
        
        function renderRestoreBuildings(buildings, existing) {
            const container = document.getElementById('restore-buildings-container');
            
            if (buildings.length === 0) {
                container.innerHTML = '<div class="import-building-item"><em>No buildings found in backup</em></div>';
                return;
            }
            
            container.innerHTML = buildings.map(b => {
                const hasConflict = existing.includes(b.name);
                return `
                    <div class="import-building-item">
                        <input type="checkbox" id="restore-${b.name}" data-name="${b.name}" data-conflict="${hasConflict}">
                        <div class="import-building-info">
                            <div class="import-building-name">${b.name}</div>
                            <div class="import-building-details">${b.device_count || 0} devices</div>
                        </div>
                        ${hasConflict ? '<span class="import-building-conflict">‚ö†Ô∏è Exists (will backup existing)</span>' : ''}
                    </div>
                `;
            }).join('');
            
            // Add change listeners
            container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', updateRestoreButton);
            });
            
            updateRestoreButton();
        }
        
        function updateRestoreButton() {
            const checked = document.querySelectorAll('#restore-buildings-container input[type="checkbox"]:checked');
            document.getElementById('restore-execute').disabled = checked.length === 0;
        }
        
        async function executeRestore() {
            if (!restoreSelectedBackup) {
                showToast('No backup selected', 'error');
                return;
            }
            
            // Gather selections
            const selections = [];
            document.querySelectorAll('#restore-buildings-container input[type="checkbox"]:checked').forEach(cb => {
                const name = cb.dataset.name;
                const hasConflict = cb.dataset.conflict === 'true';
                selections.push({
                    name: name,
                    action: hasConflict ? 'overwrite' : 'import'
                });
            });
            
            if (selections.length === 0) {
                showToast('No buildings selected', 'error');
                return;
            }
            
            // Check admin
            if (!isAdminAuthenticated) {
                showToast('Admin authentication required', 'error');
                return;
            }
            
            document.getElementById('modal-restore-usb').classList.remove('active');
            document.getElementById('modal-restore-progress').classList.add('active');
            
            try {
                const response = await fetch('/api/system/backup/usb/restore', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        path: restoreSelectedBackup,
                        selections: selections
                    })
                });
                const data = await response.json();
                
                document.getElementById('modal-restore-progress').classList.remove('active');
                
                if (data.success) {
                    showToast(`Restored ${data.imported} building(s)`, 'success');
                    loadBuildings();
                    resetRestoreState();
                } else {
                    showToast('Restore failed: ' + (data.error || 'Unknown'), 'error');
                }
            } catch (error) {
                document.getElementById('modal-restore-progress').classList.remove('active');
                showToast('Restore failed: ' + error.message, 'error');
            }
        }
        
        // =====================================================================
        // Export/Import Buildings
        // =====================================================================
        
        document.getElementById('btn-export-buildings').addEventListener('click', exportBuildings);
        document.getElementById('btn-import-buildings').addEventListener('click', openImportModal);
        document.getElementById('import-cancel').addEventListener('click', closeImportModal);
        document.getElementById('import-clear-file').addEventListener('click', clearImportFile);
        document.getElementById('import-execute').addEventListener('click', executeImport);
        
        // File drop zone
        const dropZone = document.getElementById('import-drop-zone');
        const fileInput = document.getElementById('import-file-input');
        
        if (dropZone) {
            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    handleImportFile(e.dataTransfer.files[0]);
                }
            });
        }
        
        if (fileInput) {
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleImportFile(e.target.files[0]);
                }
            });
        }
        
        let importFile = null;
        let importBuildings = [];
        
        async function exportBuildings() {
            try {
                const response = await fetch('/api/buildings/export', { method: 'POST' });
                
                // Check content type to determine if it's an error or the file
                const contentType = response.headers.get('content-type');
                
                if (contentType && contentType.includes('application/json')) {
                    // It's an error response
                    const data = await response.json();
                    throw new Error(data.error || 'Export failed');
                }
                
                if (!response.ok) {
                    throw new Error(`Export failed with status ${response.status}`);
                }
                
                // Download the ZIP file
                const blob = await response.blob();
                
                if (blob.size === 0) {
                    throw new Error('Export file is empty');
                }
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                
                // Extract filename from Content-Disposition header
                const disposition = response.headers.get('Content-Disposition');
                let filename = 'stagebox-buildings.zip';
                if (disposition) {
                    const match = disposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                    if (match && match[1]) {
                        filename = match[1].replace(/['"]/g, '');
                    }
                }
                a.download = filename;
                document.body.appendChild(a);
                
                // Show toast BEFORE triggering download
                showToast(`‚úÖ Exported: ${filename}`, 'success', 4000);
                
                setTimeout(() => {
                    a.click();
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);
                }, 100);
            } catch (error) {
                showToast('Export failed: ' + error.message, 'error', 5000);
            }
        }
        
        function openImportModal() {
            resetImportState();
            document.getElementById('modal-import').classList.add('active');
        }
        
        function closeImportModal() {
            document.getElementById('modal-import').classList.remove('active');
            resetImportState();
        }
        
        function resetImportState() {
            importFile = null;
            importBuildings = [];
            document.getElementById('import-upload-section').style.display = 'block';
            document.getElementById('import-preview-section').style.display = 'none';
            document.getElementById('import-buildings-list').style.display = 'none';
            document.getElementById('import-execute').disabled = true;
            document.getElementById('import-file-input').value = '';
        }
        
        function clearImportFile() {
            resetImportState();
        }
        
        async function handleImportFile(file) {
            if (!file.name.endsWith('.zip')) {
                showToast('Please select a ZIP file', 'error');
                return;
            }
            
            importFile = file;
            
            const uploadSection = document.getElementById('import-upload-section');
            const previewSection = document.getElementById('import-preview-section');
            const filenameEl = document.getElementById('import-filename');
            const loadingEl = document.getElementById('import-loading');
            const listEl = document.getElementById('import-buildings-list');
            
            if (uploadSection) uploadSection.style.display = 'none';
            if (previewSection) previewSection.style.display = 'block';
            if (filenameEl) filenameEl.textContent = file.name;
            if (loadingEl) loadingEl.style.display = 'flex';
            if (listEl) listEl.style.display = 'none';
            
            // Upload and analyze
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/api/buildings/import/analyze', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                if (loadingEl) loadingEl.style.display = 'none';
                
                if (data.success) {
                    importBuildings = data.buildings;
                    renderImportBuildings(data.buildings);
                    if (listEl) listEl.style.display = 'block';
                } else {
                    showToast('Analysis failed: ' + (data.error || 'Unknown'), 'error');
                    resetImportState();
                }
            } catch (error) {
                if (loadingEl) loadingEl.style.display = 'none';
                showToast('Analysis failed: ' + error.message, 'error');
                resetImportState();
            }
        }
        
        function renderImportBuildings(buildings) {
            const container = document.getElementById('import-buildings-container');
            
            if (buildings.length === 0) {
                container.innerHTML = '<div class="import-building-item"><em>No buildings found in ZIP</em></div>';
                return;
            }
            
            container.innerHTML = buildings.map(b => {
                const hasConflict = b.exists === true;
                return `
                    <div class="import-building-item">
                        <input type="checkbox" id="import-${b.name}" data-name="${b.name}" data-conflict="${hasConflict}" ${!hasConflict ? 'checked' : ''}>
                        <div class="import-building-info">
                            <div class="import-building-name">${b.name}</div>
                            <div class="import-building-details">${b.action || (hasConflict ? 'skip' : 'import')}</div>
                        </div>
                        ${hasConflict ? '<span class="import-building-conflict">‚ö†Ô∏è Exists (will overwrite)</span>' : ''}
                    </div>
                `;
            }).join('');
            
            // Enable execute button
            updateImportButton();
            
            // Add change listeners
            container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', updateImportButton);
            });
        }
        
        function updateImportButton() {
            const checked = document.querySelectorAll('#import-buildings-container input[type="checkbox"]:checked');
            document.getElementById('import-execute').disabled = checked.length === 0;
        }
        
        async function executeImport() {
            if (!importFile) {
                showToast('No file selected', 'error');
                return;
            }
            
            // Gather selections
            const selections = [];
            document.querySelectorAll('#import-buildings-container input[type="checkbox"]:checked').forEach(cb => {
                const name = cb.dataset.name;
                const hasConflict = cb.dataset.conflict === 'true';
                selections.push({
                    name: name,
                    action: hasConflict ? 'overwrite' : 'import'
                });
            });
            
            if (selections.length === 0) {
                showToast('No buildings selected', 'error');
                return;
            }
            
            // Save file reference before closing modal
            const fileToImport = importFile;
            
            document.getElementById('modal-import').classList.remove('active');
            document.getElementById('modal-import-progress').classList.add('active');
            
            // Upload and import
            const formData = new FormData();
            formData.append('file', fileToImport);
            formData.append('selections', JSON.stringify(selections));
            
            try {
                const response = await fetch('/api/buildings/import/execute', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                document.getElementById('modal-import-progress').classList.remove('active');
                
                if (data.success) {
                    showToast(`Imported ${data.imported} building(s)`, 'success');
                    loadBuildings(); // Refresh building list
                    resetImportState(); // Reset after success
                } else {
                    showToast('Import failed: ' + (data.error || 'Unknown'), 'error');
                }
            } catch (error) {
                document.getElementById('modal-import-progress').classList.remove('active');
                showToast('Import failed: ' + error.message, 'error');
            }
        }

        // =====================================================================
        // USB Backup
        // =====================================================================
        
        document.getElementById('btn-usb-format').addEventListener('click', openUsbModal);
        document.getElementById('usb-cancel').addEventListener('click', closeUsbModal);
        document.getElementById('usb-refresh').addEventListener('click', loadUsbDrives);
        
        async function openUsbModal() {
            document.getElementById('modal-usb').classList.add('active');
            await loadUsbDrives();
        }
        
        function closeUsbModal() {
            document.getElementById('modal-usb').classList.remove('active');
        }
        
        // =====================================================================
        // Update System
        // =====================================================================
        
        let updateInfo = null;  // Store update info for installation
        
        document.getElementById('btn-check-updates').addEventListener('click', checkForUpdates);
        
        async function checkForUpdates() {
            // Open modal and show checking state
            const modal = document.getElementById('modal-update');
            modal.classList.add('active');
            
            showUpdateState('checking');
            
            try {
                const response = await fetch('/api/system/updates/check');
                
                // Handle 401 - not authenticated
                if (response.status === 401) {
                    closeUpdateModal();
                    showToast('Please log in as admin first', 'warning');
                    return;
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    showUpdateError(data.error || 'Failed to check for updates');
                    return;
                }
                
                if (data.update_available) {
                    // Store update info for installation
                    updateInfo = {
                        download_url: data.download_url,
                        sha256: data.sha256
                    };
                    
                    // Populate update details
                    document.getElementById('update-from-version').textContent = data.current_version;
                    document.getElementById('update-to-version').textContent = data.remote_version;
                    document.getElementById('update-date').textContent = data.release_date || '-';
                    document.getElementById('update-size').textContent = formatBytes(data.file_size);
                    document.getElementById('update-notes').textContent = data.release_notes || 'No release notes available.';
                    
                    showUpdateState('available');
                } else {
                    document.getElementById('update-current-version').textContent = data.current_version;
                    showUpdateState('current');
                }
            } catch (error) {
                console.error('Update check error:', error);
                showUpdateError('Connection error: ' + error.message);
            }
        }
        
        async function installUpdate() {
            if (!updateInfo) {
                showUpdateError('No update information available');
                return;
            }
            
            showUpdateState('installing');
            document.getElementById('update-install-status').textContent = 'Creating backup...';
            
            try {
                const response = await fetch('/api/system/updates/install', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateInfo)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('update-new-version').textContent = data.new_version;
                    showUpdateState('success');
                    
                    // System is rebooting - wait and try to reconnect
                    if (data.rebooting) {
                        document.getElementById('update-success').querySelector('p:last-child').textContent = 
                            'System is rebooting. Reconnecting...';
                        
                        // Wait for reboot to start, then poll until server is back
                        setTimeout(() => {
                            waitForServerAndReload();
                        }, 5000);
                    } else {
                        // No reboot, just reload after delay
                        setTimeout(() => {
                            window.location.reload(true);
                        }, 3000);
                    }
                } else {
                    showUpdateError(data.error || 'Installation failed');
                }
            } catch (error) {
                console.error('Update install error:', error);
                showUpdateError('Connection error: ' + error.message);
            }
        }
        
        async function waitForServerAndReload() {
            const maxAttempts = 60;  // Try for up to 2 minutes
            const interval = 2000;   // Every 2 seconds
            let attempts = 0;
            
            const checkServer = async () => {
                attempts++;
                try {
                    const response = await fetch('/api/system/version', {
                        method: 'GET',
                        cache: 'no-store'
                    });
                    if (response.ok) {
                        // Server is back! Navigate to clean start page
                        window.location.href = '/';
                        return;
                    }
                } catch (e) {
                    // Server not ready yet
                }
                
                if (attempts < maxAttempts) {
                    setTimeout(checkServer, interval);
                } else {
                    // Give up and let user manually reload
                    document.getElementById('update-success').querySelector('p:last-child').textContent = 
                        'Reboot taking longer than expected. Please refresh manually.';
                }
            };
            
            checkServer();
        }
        
        function showUpdateState(state) {
            // Hide all states
            document.getElementById('update-checking').style.display = 'none';
            document.getElementById('update-current').style.display = 'none';
            document.getElementById('update-available').style.display = 'none';
            document.getElementById('update-installing').style.display = 'none';
            document.getElementById('update-error').style.display = 'none';
            document.getElementById('update-success').style.display = 'none';
            
            // Hide/show buttons
            document.getElementById('update-install-btn').style.display = 'none';
            document.getElementById('update-close-btn').style.display = 'block';
            
            // Show requested state
            switch (state) {
                case 'checking':
                    document.getElementById('update-checking').style.display = 'block';
                    break;
                case 'current':
                    document.getElementById('update-current').style.display = 'block';
                    break;
                case 'available':
                    document.getElementById('update-available').style.display = 'block';
                    document.getElementById('update-install-btn').style.display = 'inline-block';
                    break;
                case 'installing':
                    document.getElementById('update-installing').style.display = 'block';
                    document.getElementById('update-close-btn').style.display = 'none';
                    break;
                case 'error':
                    document.getElementById('update-error').style.display = 'block';
                    break;
                case 'success':
                    document.getElementById('update-success').style.display = 'block';
                    break;
            }
        }
        
        function showUpdateError(message) {
            document.getElementById('update-error-message').textContent = message;
            showUpdateState('error');
        }
        
        function closeUpdateModal() {
            document.getElementById('modal-update').classList.remove('active');
            updateInfo = null;
        }
        
        function formatBytes(bytes) {
            if (!bytes || bytes === 0) return '-';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        // =====================================================================
        // System Updates
        // =====================================================================
        
        let systemUpdateInfo = null;
        
        document.getElementById('btn-system-updates').addEventListener('click', checkSystemUpdates);
        
        async function checkSystemUpdates() {
            // Open modal and show checking state
            const modal = document.getElementById('modal-system-updates');
            modal.classList.add('active');
            
            showSystemUpdateState('checking');
            
            try {
                const response = await fetch('/api/admin/system/apt/check');
                
                // Handle 401 - not authenticated
                if (response.status === 401) {
                    closeSystemUpdatesModal();
                    showToast('Please log in as admin first', 'warning');
                    return;
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    showSystemUpdateError(data.error || 'Failed to check for updates');
                    return;
                }
                
                // Count all updates including required
                const requiredCount = (data.required_apt?.length || 0) + (data.required_pip?.length || 0);
                const totalUpdates = data.security_count + data.system_count;
                
                if (requiredCount === 0 && totalUpdates === 0) {
                    showSystemUpdateState('current');
                } else {
                    // Store update info
                    systemUpdateInfo = {
                        packages: [...(data.security_packages || []), ...(data.system_packages || [])],
                        required_apt: data.required_apt || [],
                        required_pip: data.required_pip || []
                    };
                    
                    // Show required section if there are missing dependencies
                    const requiredSection = document.getElementById('sysupdate-required-section');
                    const requiredPackagesDiv = document.getElementById('sysupdate-required-packages');
                    
                    if (requiredCount > 0) {
                        let requiredHtml = '';
                        if (data.required_apt && data.required_apt.length > 0) {
                            requiredHtml += data.required_apt.map(p => `<div>üì¶ ${p} (apt)</div>`).join('');
                        }
                        if (data.required_pip && data.required_pip.length > 0) {
                            requiredHtml += data.required_pip.map(p => `<div>üêç ${p} (pip)</div>`).join('');
                        }
                        requiredPackagesDiv.innerHTML = requiredHtml;
                        requiredSection.style.display = 'block';
                    } else {
                        requiredSection.style.display = 'none';
                    }
                    
                    // Show regular updates section only if there are updates
                    const regularSection = document.getElementById('sysupdate-regular-section');
                    const packagesContainer = document.getElementById('sysupdate-packages-container');
                    
                    if (totalUpdates > 0) {
                        regularSection.style.display = 'block';
                        packagesContainer.style.display = 'block';
                        
                        // Populate update details
                        document.getElementById('sysupdate-security-count').textContent = data.security_count;
                        document.getElementById('sysupdate-system-count').textContent = data.system_count;
                        
                        // Show package list
                        const packagesDiv = document.getElementById('sysupdate-packages');
                        let packagesHtml = '';
                        
                        if (data.security_packages && data.security_packages.length > 0) {
                            packagesHtml += '<div style="color: var(--accent-danger); margin-bottom: 0.5rem;"><strong>Security:</strong></div>';
                            packagesHtml += data.security_packages.map(p => `<div style="margin-left: 1rem;">üîí ${p}</div>`).join('');
                        }
                        
                        if (data.system_packages && data.system_packages.length > 0) {
                            if (packagesHtml) packagesHtml += '<div style="margin-top: 0.5rem;"></div>';
                            packagesHtml += '<div style="margin-bottom: 0.5rem;"><strong>System:</strong></div>';
                            packagesHtml += data.system_packages.map(p => `<div style="margin-left: 1rem;">‚öôÔ∏è ${p}</div>`).join('');
                        }
                        
                        packagesDiv.innerHTML = packagesHtml || 'No package details available';
                    } else {
                        regularSection.style.display = 'none';
                        packagesContainer.style.display = 'none';
                    }
                    
                    showSystemUpdateState('available');
                }
            } catch (error) {
                console.error('System update check error:', error);
                showSystemUpdateError('Connection error: ' + error.message);
            }
        }
        
        async function installRequiredPackages() {
            if (!systemUpdateInfo) {
                showSystemUpdateError('No update info available');
                return;
            }
            
            const requiredCount = (systemUpdateInfo.required_apt?.length || 0) + 
                                 (systemUpdateInfo.required_pip?.length || 0);
            
            if (requiredCount === 0) {
                showSystemUpdateError('No required packages to install');
                return;
            }
            
            showSystemUpdateState('installing');
            document.getElementById('sysupdate-install-status').textContent = 
                `Installing ${requiredCount} required packages...`;
            
            try {
                const response = await fetch('/api/admin/system/deps/install', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    let message = data.message;
                    if (data.reboot_recommended) {
                        message += ' Reboot recommended.';
                    }
                    document.getElementById('sysupdate-success-message').textContent = message;
                    showSystemUpdateState('success');
                } else {
                    showSystemUpdateError(data.error || 'Installation failed');
                }
            } catch (error) {
                console.error('Dependency install error:', error);
                showSystemUpdateError('Connection error: ' + error.message);
            }
        }
        
        async function installSystemUpdates() {
            if (!systemUpdateInfo) {
                showSystemUpdateError('No update info available');
                return;
            }
            
            // First install required packages if any
            const requiredCount = (systemUpdateInfo.required_apt?.length || 0) + 
                                 (systemUpdateInfo.required_pip?.length || 0);
            
            const updateCount = systemUpdateInfo.packages?.length || 0;
            const totalCount = requiredCount + updateCount;
            
            if (totalCount === 0) {
                showSystemUpdateError('No packages to install');
                return;
            }
            
            showSystemUpdateState('installing');
            document.getElementById('sysupdate-install-status').textContent = 
                `Installing ${totalCount} packages...`;
            
            try {
                // Install required dependencies first
                if (requiredCount > 0) {
                    document.getElementById('sysupdate-install-status').textContent = 
                        `Installing ${requiredCount} required dependencies...`;
                    
                    const depsResponse = await fetch('/api/admin/system/deps/install', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const depsData = await depsResponse.json();
                    if (!depsData.success) {
                        showSystemUpdateError('Failed to install dependencies: ' + (depsData.error || 'Unknown error'));
                        return;
                    }
                }
                
                // Then install system updates
                if (updateCount > 0) {
                    document.getElementById('sysupdate-install-status').textContent = 
                        `Installing ${updateCount} system updates...`;
                    
                    const response = await fetch('/api/admin/system/apt/upgrade', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ packages: systemUpdateInfo.packages })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        document.getElementById('sysupdate-success-message').textContent = data.message;
                        showSystemUpdateState('success');
                        
                        // If reboot required, wait and reconnect
                        if (data.rebooting) {
                            document.getElementById('sysupdate-success-message').textContent = 
                                'Updates installed. System is rebooting...';
                            setTimeout(() => {
                                waitForServerAndReload();
                            }, 5000);
                        }
                    } else {
                        showSystemUpdateError(data.error || 'Installation failed');
                    }
                } else {
                    // Only dependencies were installed
                    document.getElementById('sysupdate-success-message').textContent = 
                        `${requiredCount} dependencies installed successfully.`;
                    showSystemUpdateState('success');
                }
            } catch (error) {
                console.error('System update install error:', error);
                showSystemUpdateError('Connection error: ' + error.message);
            }
        }
        
        function showSystemUpdateState(state) {
            // Hide all states
            document.getElementById('sysupdate-checking').style.display = 'none';
            document.getElementById('sysupdate-current').style.display = 'none';
            document.getElementById('sysupdate-available').style.display = 'none';
            document.getElementById('sysupdate-installing').style.display = 'none';
            document.getElementById('sysupdate-error').style.display = 'none';
            document.getElementById('sysupdate-success').style.display = 'none';
            
            // Hide/show buttons
            document.getElementById('sysupdate-install-btn').style.display = 'none';
            document.getElementById('sysupdate-install-required-btn').style.display = 'none';
            document.getElementById('sysupdate-close-btn').style.display = 'block';
            
            // Show requested state
            switch (state) {
                case 'checking':
                    document.getElementById('sysupdate-checking').style.display = 'block';
                    break;
                case 'current':
                    document.getElementById('sysupdate-current').style.display = 'block';
                    break;
                case 'available':
                    document.getElementById('sysupdate-available').style.display = 'block';
                    
                    // Show appropriate buttons based on what's available
                    const hasRequired = systemUpdateInfo && 
                        ((systemUpdateInfo.required_apt?.length || 0) + (systemUpdateInfo.required_pip?.length || 0) > 0);
                    const hasUpdates = systemUpdateInfo && (systemUpdateInfo.packages?.length || 0) > 0;
                    
                    if (hasRequired && !hasUpdates) {
                        // Only required packages
                        document.getElementById('sysupdate-install-required-btn').style.display = 'inline-block';
                    } else if (hasRequired || hasUpdates) {
                        // Both or just updates - show Install All
                        document.getElementById('sysupdate-install-btn').style.display = 'inline-block';
                        if (hasRequired) {
                            // Also show Install Required button
                            document.getElementById('sysupdate-install-required-btn').style.display = 'inline-block';
                        }
                    }
                    break;
                case 'installing':
                    document.getElementById('sysupdate-installing').style.display = 'block';
                    document.getElementById('sysupdate-close-btn').style.display = 'none';
                    break;
                case 'error':
                    document.getElementById('sysupdate-error').style.display = 'block';
                    break;
                case 'success':
                    document.getElementById('sysupdate-success').style.display = 'block';
                    break;
            }
        }
        
        function showSystemUpdateError(message) {
            document.getElementById('sysupdate-error-message').textContent = message;
            showSystemUpdateState('error');
        }
        
        function closeSystemUpdatesModal() {
            document.getElementById('modal-system-updates').classList.remove('active');
            systemUpdateInfo = null;
        }
        
        // =====================================================================
        // Language Settings
        // =====================================================================
        
        document.getElementById('btn-language').addEventListener('click', openLanguageModal);
        document.getElementById('language-cancel').addEventListener('click', closeLanguageModal);
        document.getElementById('language-save').addEventListener('click', saveLanguage);
        
        async function openLanguageModal() {
            document.getElementById('modal-language').classList.add('active');
            
            // Load current language
            try {
                const response = await fetch('/api/system/language');
                const data = await response.json();
                if (data.success && data.language) {
                    const radio = document.querySelector(`input[name="language"][value="${data.language}"]`);
                    if (radio) radio.checked = true;
                }
            } catch (error) {
                console.error('Error loading language:', error);
            }
        }
        
        function closeLanguageModal() {
            document.getElementById('modal-language').classList.remove('active');
        }
        
        async function saveLanguage() {
            const selected = document.querySelector('input[name="language"]:checked');
            if (!selected) {
                showToast('Please select a language', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/api/system/language', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ language: selected.value })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Language changed - reloading...', 'success');
                    closeLanguageModal();
                    // Reload page to apply new language
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showToast('Error: ' + (data.error || 'Unknown'), 'error');
                }
            } catch (error) {
                showToast('Connection error', 'error');
            }
        }
        
        // =====================================================================
        // USB Drives
        // =====================================================================
        
        async function loadUsbDrives() {
            const container = document.getElementById('usb-status-container');
            const drivesList = document.getElementById('usb-drives-list');
            const noDrives = document.getElementById('usb-no-drives');
            
            // Show loading
            container.style.display = 'block';
            drivesList.style.display = 'none';
            noDrives.style.display = 'none';
            
            try {
                const response = await fetch('/api/admin/system/usb');
                const data = await response.json();
                
                container.style.display = 'none';
                
                if (data.success && data.drives && data.drives.length > 0) {
                    drivesList.innerHTML = data.drives.map(drive => renderUsbDrive(drive)).join('');
                    drivesList.style.display = 'block';
                } else {
                    noDrives.style.display = 'block';
                }
            } catch (error) {
                container.style.display = 'none';
                noDrives.innerHTML = '<p>‚ùå Error loading der USB devices</p>';
                noDrives.style.display = 'block';
            }
        }
        
        function renderUsbDrive(drive) {
            const label = drive.label || drive.name || 'USB-Stick';
            const fstype = drive.fstype || t('usb.unformatted');
            const isStagebox = drive.is_stagebox;
            
            let usageHtml = '';
            if (drive.total_bytes) {
                const totalGB = (drive.total_bytes / 1024 / 1024 / 1024).toFixed(1);
                const freeGB = (drive.free_bytes / 1024 / 1024 / 1024).toFixed(1);
                const usedPercent = drive.usage_percent || 0;
                
                usageHtml = `
                    <div class="usb-usage-bar">
                        <div class="usb-usage-fill" style="width: ${usedPercent}%"></div>
                    </div>
                    <div class="usb-usage-text">${t('usb.free_of', {free: freeGB, total: totalGB, percent: usedPercent})}</div>
                `;
            }
            
            const stageboxBadge = isStagebox ? `<span class="stagebox-badge">‚úì ${t('usb.stagebox_backup')}</span>` : '';
            
            // Show different actions based on whether it's already a Stagebox drive
            let actionsHtml = '';
            if (isStagebox) {
                actionsHtml = `
                    <div class="usb-drive-actions">
                        <div class="usb-status-ok">‚úì ${t('usb.ready_for_backups')}</div>
                        <button class="btn btn-warning btn-small" onclick="formatUsbDrive('${drive.device}', '${label}')">
                            ‚ö†Ô∏è ${t('usb.reformat')}
                        </button>
                    </div>
                `;
            } else {
                actionsHtml = `
                    <div class="usb-drive-actions">
                        <button class="btn btn-primary" onclick="formatUsbDrive('${drive.device}', '${label}')">
                            üìÄ ${t('usb.format_as_stagebox')}
                        </button>
                    </div>
                `;
            }
            
            return `
                <div class="usb-drive-item ${isStagebox ? 'is-stagebox' : ''}">
                    <div class="usb-drive-header">
                        <span class="usb-drive-name">üîå ${label}</span>
                        <span class="usb-drive-size">${drive.size || ''}</span>
                    </div>
                    ${stageboxBadge}
                    <div class="usb-drive-info">
                        <span>${drive.device}</span>
                        <span>${t('usb.format_label')}: ${fstype}</span>
                    </div>
                    ${usageHtml}
                    ${actionsHtml}
                </div>
            `;
        }
        
        async function formatUsbDrive(device, currentLabel) {
            const isExisting = currentLabel.startsWith('STAGEBOX');
            
            let confirmMsg = isExisting 
                ? t('usb.confirm_reformat', {device: device, label: currentLabel})
                : t('usb.confirm_format', {device: device});
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            if (!confirm(t('usb.final_warning', {device: device}))) {
                return;
            }
            
            // Show progress
            const container = document.getElementById('usb-drives-list');
            container.innerHTML = `
                <div class="loading-small">
                    <div class="spinner-small"></div>
                    <span>${t('usb.formatting', {device: device})}</span>
                </div>
            `;
            
            try {
                const response = await fetch('/api/admin/system/usb/format', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        device: device,
                        label: 'STAGEBOXBAK'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(t('usb.format_success'));
                    await loadUsbDrives();
                } else {
                    alert(t('usb.format_failed') + '\n\n' + (data.error || 'Unknown error'));
                    await loadUsbDrives();
                }
            } catch (error) {
                alert('‚ùå Connection error');
                await loadUsbDrives();
            }
        }

        // ============================================================
        // Installer Profile Functions
        // ============================================================
        
        async function loadInstallerProfile() {
            try {
                const response = await fetch('/api/admin/installer-profile');
                const data = await response.json();
                
                if (data.success) {
                    const profile = data.profile;
                    document.getElementById('installer-company').value = profile.company_name || '';
                    document.getElementById('installer-address').value = profile.address || '';
                    document.getElementById('installer-phone').value = profile.phone || '';
                    document.getElementById('installer-email').value = profile.email || '';
                    document.getElementById('installer-website').value = profile.website || '';
                    
                    // Update logo preview
                    updateLogoPreview(profile.has_logo);
                }
            } catch (error) {
                console.error('Error loading installer profile:', error);
            }
        }
        
        function updateLogoPreview(hasLogo) {
            const preview = document.getElementById('installer-logo-preview');
            const deleteBtn = document.getElementById('btn-delete-logo');
            
            if (hasLogo) {
                // Add cache-busting timestamp
                preview.innerHTML = `<img src="/api/admin/installer-logo?t=${Date.now()}" alt="Logo">`;
                deleteBtn.style.display = 'inline-flex';
            } else {
                preview.innerHTML = `<span class="logo-placeholder">${t('installer_profile.no_logo')}</span>`;
                deleteBtn.style.display = 'none';
            }
        }
        
        async function saveInstallerProfile() {
            const profile = {
                company_name: document.getElementById('installer-company').value,
                address: document.getElementById('installer-address').value,
                phone: document.getElementById('installer-phone').value,
                email: document.getElementById('installer-email').value,
                website: document.getElementById('installer-website').value
            };
            
            try {
                const response = await fetch('/api/admin/installer-profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(profile)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('modal-installer-profile').classList.remove('active');
                    showToast(t('installer_profile.saved'), 'success');
                } else {
                    showInstallerProfileError(data.error || t('common.error'));
                }
            } catch (error) {
                showInstallerProfileError(t('common.error'));
            }
        }
        
        async function uploadInstallerLogo(file) {
            const formData = new FormData();
            formData.append('logo', file);
            
            try {
                const response = await fetch('/api/admin/installer-logo', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    updateLogoPreview(true);
                    showToast(t('installer_profile.logo_uploaded'), 'success');
                } else {
                    showInstallerProfileError(data.error || t('installer_profile.logo_error'));
                }
            } catch (error) {
                showInstallerProfileError(t('installer_profile.logo_error'));
            }
        }
        
        async function deleteInstallerLogo() {
            try {
                const response = await fetch('/api/admin/installer-logo', {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    updateLogoPreview(false);
                    showToast(t('installer_profile.logo_deleted'), 'success');
                }
            } catch (error) {
                console.error('Error deleting logo:', error);
            }
        }
        
        function showInstallerProfileError(message) {
            const errorDiv = document.getElementById('installer-profile-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        // Event Listeners for Installer Profile
        document.getElementById('btn-installer-profile').addEventListener('click', () => {
            loadInstallerProfile();
            document.getElementById('installer-profile-error').style.display = 'none';
            document.getElementById('modal-installer-profile').classList.add('active');
        });
        
        document.getElementById('installer-profile-cancel').addEventListener('click', () => {
            document.getElementById('modal-installer-profile').classList.remove('active');
        });
        
        document.getElementById('installer-profile-save').addEventListener('click', saveInstallerProfile);
        
        document.getElementById('btn-upload-logo').addEventListener('click', () => {
            document.getElementById('logo-file-input').click();
        });
        
        document.getElementById('logo-file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                uploadInstallerLogo(file);
            }
            e.target.value = ''; // Reset input
        });
        
        document.getElementById('btn-delete-logo').addEventListener('click', () => {
            if (confirm(t('installer_profile.confirm_delete_logo'))) {
                deleteInstallerLogo();
            }
        });
        
        // Close modal on overlay click
        document.getElementById('modal-installer-profile').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                document.getElementById('modal-installer-profile').classList.remove('active');
            }
        });
        
        // =====================================================================
        // Background Update Check
        // =====================================================================
        
        async function checkForUpdatesBackground() {
            // Check localStorage for last check time
            const lastCheck = localStorage.getItem('stagebox_update_last_check');
            const lastResult = localStorage.getItem('stagebox_update_result');
            const checkInterval = 24 * 60 * 60 * 1000; // 24 hours in ms
            
            // If checked recently, use cached result
            if (lastCheck && lastResult) {
                const timeSinceCheck = Date.now() - parseInt(lastCheck);
                if (timeSinceCheck < checkInterval) {
                    try {
                        const cached = JSON.parse(lastResult);
                        if (cached.update_available) {
                            showUpdateBadge(cached.current_version, cached.remote_version);
                            // Only show toast once per session
                            if (!sessionStorage.getItem('update_toast_shown')) {
                                showUpdateToast(cached.current_version, cached.remote_version);
                                sessionStorage.setItem('update_toast_shown', 'true');
                            }
                        }
                    } catch (e) {
                        console.log('Invalid cached update result, clearing');
                        localStorage.removeItem('stagebox_update_result');
                    }
                    return;
                }
            }
            
            // Quick ping to check if server is reachable
            // Use AbortController for better browser compatibility
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 2000);
                
                const pingResponse = await fetch('/api/system/ping', { 
                    signal: controller.signal 
                });
                clearTimeout(timeoutId);
                
                const pingData = await pingResponse.json();
                
                if (!pingData.reachable) {
                    // No internet, skip check
                    console.log('Update server not reachable, skipping check');
                    return;
                }
            } catch (e) {
                // Network error or timeout, skip check
                console.log('Ping failed, skipping update check:', e.message);
                return;
            }
            
            // Server reachable, do actual check
            try {
                const response = await fetch('/api/system/updates/check-background');
                const data = await response.json();
                
                console.log('Background update check result:', data);
                
                if (data.success) {
                    // Cache result
                    localStorage.setItem('stagebox_update_last_check', Date.now().toString());
                    localStorage.setItem('stagebox_update_result', JSON.stringify(data));
                    
                    if (data.update_available) {
                        console.log('Update available! Showing badge and toast');
                        showUpdateBadge(data.current_version, data.remote_version);
                        // Only show toast once per session
                        if (!sessionStorage.getItem('update_toast_shown')) {
                            showUpdateToast(data.current_version, data.remote_version);
                            sessionStorage.setItem('update_toast_shown', 'true');
                        }
                    }
                }
            } catch (error) {
                console.log('Background update check failed:', error);
            }
        }
        
        function showUpdateBadge(currentVersion, remoteVersion) {
            const badge = document.getElementById('update-badge');
            const btn = document.getElementById('btn-check-updates');
            console.log('showUpdateBadge called, badge element:', badge);
            if (badge) {
                badge.style.display = 'block';
                console.log('Badge is now visible');
            } else {
                console.error('update-badge element not found!');
            }
            // Add hover tooltip with version info
            if (btn && currentVersion && remoteVersion) {
                btn.title = `${currentVersion} ‚Üí ${remoteVersion}`;
            }
        }
        
        function hideUpdateBadge() {
            const badge = document.getElementById('update-badge');
            if (badge) {
                badge.style.display = 'none';
            }
        }
        
        function showUpdateToast(currentVersion, remoteVersion) {
            // Create toast element
            const toast = document.createElement('div');
            toast.id = 'update-toast';
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--bg-secondary);
                border: 2px solid var(--accent-primary);
                border-radius: 12px;
                padding: 1rem 1.5rem;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 350px;
                animation: slideIn 0.3s ease;
            `;
            
            toast.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 1rem;">
                    <div style="font-size: 2rem;">üì¶</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; margin-bottom: 0.5rem;" data-i18n="update.new_available">
                            New Stagebox Update Available
                        </div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.75rem;">
                            ${currentVersion} ‚Üí <strong style="color: var(--accent-primary);">${remoteVersion}</strong>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="closeUpdateToast()" class="btn btn-secondary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;" data-i18n="common.later">
                                Later
                            </button>
                            <button onclick="closeUpdateToast(); document.getElementById('btn-check-updates').click();" class="btn btn-primary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;" data-i18n="update.view_update">
                                View Update
                            </button>
                        </div>
                    </div>
                    <button onclick="closeUpdateToast()" style="background: none; border: none; color: var(--text-secondary); font-size: 1.2rem; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
                </div>
            `;
            
            // Add animation keyframes if not exists
            if (!document.getElementById('toast-animation-style')) {
                const style = document.createElement('style');
                style.id = 'toast-animation-style';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(toast);
            
            // Apply i18n if available
            if (typeof i18n !== 'undefined' && i18n.translateElement) {
                i18n.translateElement(toast);
            }
        }
        
        function closeUpdateToast() {
            const toast = document.getElementById('update-toast');
            if (toast) {
                toast.style.animation = 'slideOut 0.3s ease forwards';
                setTimeout(() => toast.remove(), 300);
            }
        }
        
        // =====================================================================
        // Hardware Info Updates
        // =====================================================================
        
        async function updateHardwareInfo() {
            try {
                const response = await fetch('/api/system/hardware');
                const data = await response.json();
                
                if (data.success) {
                    const tempEl = document.getElementById('hw-temp');
                    const uptimeEl = document.getElementById('hw-uptime');
                    
                    if (tempEl && data.cpu_temp !== null) {
                        tempEl.textContent = data.cpu_temp + '¬∞C';
                    }
                    if (uptimeEl && data.uptime) {
                        uptimeEl.textContent = data.uptime;
                    }
                }
            } catch (error) {
                console.log('Hardware info update failed:', error);
            }
        }
        
        // Update hardware info every 30 seconds
        setInterval(updateHardwareInfo, 30000);
    </script>
</body>
</html>
