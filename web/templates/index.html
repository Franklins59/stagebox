<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stagebox Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/layout.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
</head>
<body>
    <!-- Top Header -->
    <header class="top-header">
        <div class="header-left">
            <button id="btn-back" class="back-btn" data-i18n-title="header.back_to_buildings" title="Back to building selection">‚Üê</button>
            <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Stagebox" class="header-logo">
            <h1>Stagebox <span id="edition-badge" class="edition-badge"></span> <span id="building-name" class="building-name"></span></h1>
        </div>
        <div class="header-right">
            <a href="/manual" class="manual-btn" id="manual-link">üìñ <span data-i18n="manual.title">Manual</span></a>
            <div class="backend-status">
                <span class="status-label" data-i18n="header.backend">Backend</span>
                <span class="status-indicator" id="backend-status"></span>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Sidebar - Functions -->
        <aside class="sidebar-left">
            <nav class="function-nav">
                <h2 data-i18n="sidebar.provisioning">Provisioning</h2>
                <div class="stage-buttons">
                    <button class="stage-btn" data-stage="1" id="btn-stage1">
                        <span class="stage-num">S1</span>
                        <span class="stage-label" data-i18n="stages.s1_label">AP Setup</span>
                    </button>
                    <button class="stage-btn" data-stage="2" id="btn-stage2">
                        <span class="stage-num">S2</span>
                        <span class="stage-label" data-i18n="stages.s2_label">Adopt</span>
                    </button>
                    <button class="stage-btn" data-stage="3" id="btn-stage3">
                        <span class="stage-num">S3</span>
                        <span class="stage-label" data-i18n="stages.s3_label">OTA + Name</span>
                    </button>
                    <button class="stage-btn" data-stage="4" id="btn-stage4">
                        <span class="stage-num">S4</span>
                        <span class="stage-label" data-i18n="stages.s4_label">Configure</span>
                    </button>
                </div>
                
                <h2 data-i18n="sidebar.filter">Filter</h2>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all" data-i18n="filter.all">All</button>
                    <button class="filter-btn" data-filter="2">S2</button>
                    <button class="filter-btn" data-filter="3">S3</button>
                    <button class="filter-btn" data-filter="4">S4</button>
                    <button class="filter-btn" data-filter="online" data-i18n="filter.online">Online</button>
                    <button class="filter-btn" data-filter="offline" data-i18n="filter.offline">Offline</button>
                </div>

                <h2 data-i18n="sidebar.device_actions">Device Actions</h2>
                <div class="action-buttons">
                    <button class="action-btn" id="btn-reboot" disabled data-i18n="device_actions.reboot">
                        <span>üîÑ Reboot</span>
                    </button>
                    <button class="action-btn" id="btn-visit" disabled data-i18n="device_actions.visit">
                        <span>üåê Visit Shelly UI</span>
                    </button>
                    <button class="action-btn" id="btn-replace-device" data-pro-only="true" data-i18n="device_actions.replace">
                        <span>üîÅ Replace</span>
                    </button>
                </div>

                <h2 data-i18n="sidebar.settings">Settings</h2>
                <div class="settings-buttons">
                    <button class="settings-btn" id="btn-building-settings">
                        <span data-i18n="settings.network_settings">‚öôÔ∏è Network Settings</span>
                    </button>
                    <button class="settings-btn" id="btn-export-labels" data-pro-only="true">
                        <span data-i18n="settings.export_labels">üè∑Ô∏è Export Labels (CSV)</span>
                    </button>
                </div>

                <h2><span data-i18n="sidebar.audit">Audit</span> <span id="snapshot-badge" class="badge badge-warning" style="display: none;">!</span></h2>
                <div class="settings-buttons">
                    <button class="settings-btn" id="btn-create-snapshot" data-pro-only="true" data-i18n="audit.create_snapshot">
                        <span>üì∏ Create Snapshot</span>
                    </button>
                    <button class="settings-btn" id="btn-view-snapshots" data-pro-only="true" data-i18n="audit.view_snapshots">
                        <span>üìÇ View Snapshots</span>
                    </button>
                    <button class="settings-btn" id="btn-run-audit" data-pro-only="true" data-i18n="audit.run_audit">
                        <span>üîç Run Audit</span>
                    </button>
                    <button class="settings-btn" id="btn-generate-report" data-pro-only="true" data-i18n="report.generate">
                        <span>üìÑ Generate Report</span>
                    </button>
                </div>

                <h2 data-i18n="sidebar.expert">Expert</h2>
                <div class="admin-buttons">
                    <button class="admin-btn" id="btn-settings" data-pro-only="true" data-i18n="expert.settings">
                        <span>‚öôÔ∏è Building Settings</span>
                    </button>
                </div>
            </nav>
        </aside>

        <!-- Center - Device List -->
        <main class="device-list-container">
            <div class="list-header">
                <h2><span data-i18n="device_list.title">Devices</span> <span id="device-count">0 total</span></h2>
                <div class="list-controls">
                    <input type="text" id="search-input" data-i18n-placeholder="device_list.search_placeholder" placeholder="Search..." class="search-box">
                    <button id="refresh-btn" class="btn-primary" data-i18n="device_list.refresh">Refresh</button>
                </div>
            </div>
            <div class="device-list" id="device-list">
                <!-- Device items will be loaded here -->
                <div class="loading" data-i18n="device_list.loading">Loading devices...</div>
            </div>
        </main>

        <!-- Right Sidebar - Details/Stage Panels -->
        <aside class="sidebar-right">
            <div class="tabs">
                <button class="tab-btn active" data-tab="details" data-i18n-title="tabs.details" title="Details">üìã</button>
                <button class="tab-btn" data-tab="stage" data-i18n-title="tabs.stage" title="Stage">üîß</button>
                <button class="tab-btn" data-tab="scripts" data-i18n-title="tabs.scripts" title="Scripts">üìú</button>
                <button class="tab-btn" data-tab="kvs" data-i18n-title="tabs.kvs" title="KVS">üóÑ</button>
                <button class="tab-btn" data-tab="webhooks" data-i18n-title="tabs.webhooks" title="Webhooks">üîó</button>
                <button class="tab-btn" data-tab="firmware" data-i18n-title="tabs.firmware" title="Firmware">üíæ</button>
            </div>
            
            <div class="tab-content">
                <!-- Details Tab -->
                <div class="tab-pane active" id="tab-details">
                    <p class="placeholder" data-i18n="details.no_device">Select a device from the list to view details.</p>
                    <form id="device-form" style="display: none;">
                        <div class="form-group">
                            <label for="device-id" data-i18n="details.mac">MAC</label>
                            <input type="text" id="device-id" readonly>
                        </div>
                        <div class="form-group">
                            <label for="device-ip">IP</label>
                            <input type="text" id="device-ip" readonly>
                        </div>
                        <div class="form-group">
                            <label for="device-name" data-i18n="details.name">Name</label>
                            <input type="text" id="device-name">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="device-room" data-i18n="details.room">Room</label>
                                <input type="text" id="device-room">
                            </div>
                            <div class="form-group">
                                <label for="device-location" data-i18n="details.location">Location</label>
                                <input type="text" id="device-location">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="device-model" data-i18n="details.model">Model</label>
                                <input type="text" id="device-model" readonly>
                            </div>
                            <div class="form-group">
                                <label for="device-fw" data-i18n="details.firmware">Firmware</label>
                                <input type="text" id="device-fw" readonly>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="device-stage" data-i18n="details.stage">Stage</label>
                            <input type="text" id="device-stage" readonly>
                        </div>
                        
                        <!-- Switch Settings Section -->
                        <div class="settings-section" id="switch-settings-section" style="display: none;">
                            <h4 class="section-title" data-i18n="details.switch_settings">Switch Settings</h4>
                            <div class="form-group">
                                <label for="switch-name" data-i18n="details.output_name">Output Name</label>
                                <input type="text" id="switch-name" maxlength="32" placeholder="e.g. licht_decke">
                            </div>
                            <div class="form-group">
                                <label for="switch-initial-state" data-i18n="details.initial_state">Initial State</label>
                                <select id="switch-initial-state">
                                    <option value="off" data-i18n="common.off">Off</option>
                                    <option value="on" data-i18n="common.on">On</option>
                                    <option value="restore_last" data-i18n="details.restore_last">Restore Last</option>
                                    <option value="match_input" data-i18n="details.match_input">Match Input</option>
                                </select>
                            </div>
                            <div class="form-row">
                                <div class="form-group checkbox-group">
                                    <label>
                                        <input type="checkbox" id="switch-auto-off">
                                        <span data-i18n="details.auto_off">Auto-Off</span>
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label for="switch-auto-off-delay" data-i18n="details.delay_sec">Delay (sec)</label>
                                    <input type="number" id="switch-auto-off-delay" min="0" step="1" value="60">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group checkbox-group">
                                    <label>
                                        <input type="checkbox" id="switch-auto-on">
                                        <span data-i18n="details.auto_on">Auto-On</span>
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label for="switch-auto-on-delay" data-i18n="details.delay_sec">Delay (sec)</label>
                                    <input type="number" id="switch-auto-on-delay" min="0" step="1" value="60">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Input Settings Section -->
                        <div class="settings-section" id="input-settings-section" style="display: none;">
                            <h4 class="section-title" data-i18n="details.input_settings">Input Settings</h4>
                            <div id="input-settings-container">
                                <!-- Input rows will be added dynamically -->
                            </div>
                        </div>
                        
                        <!-- Cover Settings Section -->
                        <div class="settings-section" id="cover-settings-section" style="display: none;">
                            <h4 class="section-title" data-i18n="details.cover_settings">Cover Settings</h4>
                            <div class="form-group">
                                <label for="cover-name" data-i18n="details.cover_name">Cover Name</label>
                                <input type="text" id="cover-name" maxlength="32" placeholder="e.g. jalousie_sued">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="cover-open-time" data-i18n="details.open_time">Open Time (sec)</label>
                                    <input type="number" id="cover-open-time" min="1" max="300" step="1" value="60">
                                </div>
                                <div class="form-group">
                                    <label for="cover-close-time" data-i18n="details.close_time">Close Time (sec)</label>
                                    <input type="number" id="cover-close-time" min="1" max="300" step="1" value="60">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group checkbox-group">
                                    <label>
                                        <input type="checkbox" id="cover-swap-inputs">
                                        <span data-i18n="details.swap_inputs">Swap Inputs</span>
                                    </label>
                                </div>
                                <div class="form-group checkbox-group">
                                    <label>
                                        <input type="checkbox" id="cover-invert">
                                        <span data-i18n="details.invert_direction">Invert Direction</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Dimmer Settings Section -->
                        <div class="settings-section" id="light-settings-section" style="display: none;">
                            <h4 class="section-title" data-i18n="details.dimmer_settings">Dimmer Settings</h4>
                            <div class="form-group">
                                <label for="light-name" data-i18n="details.dimmer_name">Dimmer Name</label>
                                <input type="text" id="light-name" maxlength="32" placeholder="e.g. dimmer_wohnzimmer">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="light-initial-state" data-i18n="details.initial_state">Initial State</label>
                                    <select id="light-initial-state">
                                        <option value="off" data-i18n="common.off">Off</option>
                                        <option value="on" data-i18n="common.on">On</option>
                                        <option value="restore_last" data-i18n="details.restore_last">Restore Last</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="light-default-brightness" data-i18n="details.default_brightness">Default Brightness (%)</label>
                                    <input type="number" id="light-default-brightness" min="1" max="100" step="1" value="100">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="light-min-brightness" data-i18n="details.min_brightness">Min Brightness (%)</label>
                                    <input type="number" id="light-min-brightness" min="0" max="100" step="1" value="0">
                                </div>
                                <div class="form-group">
                                    <label for="light-night-brightness" data-i18n="details.night_brightness">Night Brightness (%)</label>
                                    <input type="number" id="light-night-brightness" min="1" max="100" step="1" value="50">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group checkbox-group">
                                    <label>
                                        <input type="checkbox" id="light-night-mode">
                                        <span data-i18n="details.night_mode">Night Mode</span>
                                    </label>
                                </div>
                                <div class="form-group checkbox-group">
                                    <label>
                                        <input type="checkbox" id="light-auto-off">
                                        <span data-i18n="details.auto_off">Auto-Off</span>
                                    </label>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="light-auto-off-delay" data-i18n="details.auto_off_delay">Auto-Off Delay (sec)</label>
                                    <input type="number" id="light-auto-off-delay" min="0" step="1" value="60">
                                </div>
                                <div class="form-group">
                                    <label for="light-auto-on-delay" data-i18n="details.auto_on_delay">Auto-On Delay (sec)</label>
                                    <input type="number" id="light-auto-on-delay" min="0" step="1" value="60">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Profile Convert Section (only for 2PM devices) -->
                        <div class="form-group profile-convert-section" id="profile-convert-section" style="display: none;">
                            <label data-i18n="details.profile">Shelly Profile</label>
                            <div class="profile-convert-row">
                                <span class="current-profile" id="current-profile">switch</span>
                                <button type="button" id="btn-convert-profile" class="btn-warning" data-i18n="details.convert">
                                    Convert to Cover
                                </button>
                            </div>
                            <small class="help-text" data-i18n="details.convert_hint">Converting will reboot the device!</small>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" id="cancel-btn" class="btn-secondary" data-i18n="details.cancel">Cancel</button>
                            <button type="submit" id="save-btn" class="btn-primary" disabled data-i18n="details.save">Save</button>
                        </div>
                    </form>
                </div>

                <!-- Stage Execution Tab -->
                <div class="tab-pane" id="tab-stage">
                    <p class="placeholder" id="stage-placeholder" data-i18n="stage.placeholder">Click a Stage button (S2/S3/S4) to start provisioning.</p>
                    
                    <!-- Stage 2 Panel -->
                    <div class="stage-panel" id="panel-stage2" style="display: none;">
                        <h3 data-i18n="stage.s2_title">Stage 2: Adopt Devices</h3>
                        <p class="stage-desc" data-i18n="stage.s2_desc">Scan DHCP range for new Shelly devices and assign static IPs.</p>
                        <div class="stage-actions">
                            <button class="btn-primary" id="btn-scan" data-i18n="stage.scan_network">Scan Network</button>
                        </div>
                        <div class="stage-results" id="results-stage2">
                            <!-- Scan results will appear here -->
                        </div>
                        <div class="stage-progress" id="progress-stage2" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress-fill-2"></div>
                            </div>
                            <div class="progress-text" id="progress-text-2" data-i18n="stage.scanning">Scanning...</div>
                        </div>
                    </div>

                    <!-- Stage 3 Panel -->
                    <div class="stage-panel" id="panel-stage3" style="display: none;">
                        <h3 data-i18n="stage.s3_title">Stage 3: OTA + Names</h3>
                        <p class="stage-desc" data-i18n="stage.s3_desc">Update firmware and sync friendly names to devices.</p>
                        <div class="stage-info">
                            <span id="stage3-eligible">0</span> <span data-i18n="stage.devices_ready_s2">devices ready (at S2)</span>
                        </div>
                        <div class="stage-device-list" id="stage3-device-list">
                            <!-- Device list will be rendered here -->
                        </div>
                        <div class="stage-actions">
                            <button class="btn-primary" id="btn-run-stage3" data-i18n="stage.run_stage3">Run Stage 3</button>
                        </div>
                        <div class="stage-progress" id="progress-stage3" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress-fill-3"></div>
                            </div>
                            <div class="progress-text" id="progress-text-3" data-i18n="stage.processing">Processing...</div>
                        </div>
                        <div class="stage-results" id="results-stage3">
                            <!-- Results will appear here -->
                        </div>
                    </div>

                    <!-- Stage 4 Panel -->
                    <div class="stage-panel" id="panel-stage4" style="display: none;">
                        <h3 data-i18n="stage.s4_title">Stage 4: Configure</h3>
                        <p class="stage-desc" data-i18n="stage.s4_desc">Apply configuration profiles to devices.</p>
                        <div class="stage-info">
                            <span id="stage4-eligible">0</span> <span data-i18n="stage.devices_ready_s3">devices ready (at S3)</span>
                        </div>
                        <div class="stage-device-list" id="stage4-device-list">
                            <!-- Device list will be rendered here -->
                        </div>
                        <div class="stage-actions">
                            <button class="btn-primary" id="btn-run-stage4" data-i18n="stage.run_stage4">Run Stage 4</button>
                        </div>
                        <div class="stage-progress" id="progress-stage4" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress-fill-4"></div>
                            </div>
                            <div class="progress-text" id="progress-text-4" data-i18n="stage.processing">Processing...</div>
                        </div>
                        <div class="stage-results" id="results-stage4">
                            <!-- Results will appear here -->
                        </div>
                    </div>
                </div>
                
                <!-- Scripts Tab -->
                <div class="tab-pane" id="tab-scripts">
                    <div class="scripts-panel">
                        <div class="scripts-header">
                            <h3 data-i18n="scripts.title">Manage Scripts</h3>
                            <div class="scripts-source-select">
                                <label data-i18n="scripts.source">Source:</label>
                                <select id="scripts-source">
                                    <option value="local" data-i18n="scripts.source_local">Local (data/scripts/)</option>
                                    <option value="github" data-i18n="scripts.source_github">Shelly Library (GitHub)</option>
                                </select>
                                <button id="btn-refresh-scripts" class="btn-small" data-i18n-title="common.refresh">üîÑ</button>
                                <span class="scripts-header-divider">|</span>
                                <input type="file" id="script-upload-input" accept=".js" style="display: none;">
                                <button id="btn-upload-script-file" class="btn-small" title="Upload .js file">üìÅ Upload</button>
                                <button id="btn-delete-script-file" class="btn-small btn-danger-small" title="Delete selected script from pool" disabled>üóëÔ∏è</button>
                            </div>
                        </div>
                        
                        <div class="scripts-list-container">
                            <div class="scripts-list" id="scripts-list">
                                <div class="loading-small" data-i18n="scripts.loading">Loading scripts...</div>
                            </div>
                        </div>
                        
                        <div class="scripts-target">
                            <div class="scripts-target-header">
                                <h4 data-i18n="scripts.target_devices">Target devices</h4>
                                <div class="scripts-target-controls">
                                    <button id="btn-scripts-select-all" class="btn-tiny" data-i18n="scripts.select_all">Select All</button>
                                    <button id="btn-scripts-select-none" class="btn-tiny" data-i18n="scripts.select_none">None</button>
                                </div>
                            </div>
                            <div class="scripts-device-list" id="scripts-device-list">
                                <!-- Devices with checkboxes will appear here -->
                            </div>
                            <div class="scripts-selection-info">
                                <span id="scripts-selected-count">0</span> <span data-i18n="scripts.selected">selected</span>
                            </div>
                        </div>
                        
                        <div class="scripts-options">
                            <div class="script-name-input">
                                <label for="script-deploy-name" data-i18n="scripts.script_name">Script name:</label>
                                <input type="text" id="script-deploy-name" placeholder="Script name on device" maxlength="32">
                            </div>
                            <label class="checkbox-inline">
                                <input type="checkbox" id="script-enable-on-boot" checked>
                                <span data-i18n="scripts.run_on_startup">Run on startup</span>
                            </label>
                            <label class="checkbox-inline">
                                <input type="checkbox" id="script-start-after-deploy" checked>
                                <span data-i18n="scripts.start_after_deploy">Start after deploy</span>
                            </label>
                        </div>
                        
                        <div class="scripts-actions">
                            <button id="btn-deploy-script" class="btn-primary" disabled data-i18n="scripts.deploy">
                                üì§ Deploy
                            </button>
                            <button id="btn-script-status" class="btn-secondary" disabled data-i18n="scripts.status">
                                üìã Status
                            </button>
                            <button id="btn-delete-script" class="btn-danger" disabled data-i18n="scripts.delete">
                                üóëÔ∏è Delete
                            </button>
                            <span class="scripts-actions-divider">|</span>
                            <button id="btn-script-start" class="btn-secondary" disabled data-i18n="scripts.start">
                                ‚ñ∂Ô∏è Start
                            </button>
                            <button id="btn-script-stop" class="btn-secondary" disabled data-i18n="scripts.stop">
                                ‚èπÔ∏è Stop
                            </button>
                            <button id="btn-script-restart" class="btn-secondary" disabled data-i18n="scripts.restart">
                                üîÑ Restart
                            </button>
                        </div>
                        
                        <div class="scripts-progress" id="scripts-progress" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="scripts-progress-fill"></div>
                            </div>
                            <div class="progress-text" id="scripts-progress-text" data-i18n="scripts.deploying">Deploying...</div>
                        </div>
                        
                        <div class="scripts-results" id="scripts-results">
                            <!-- Results will appear here -->
                        </div>
                    </div>
                </div>

                <!-- KVS Tab -->
                <div class="tab-pane" id="tab-kvs">
                    <div class="kvs-panel">
                        <div class="kvs-header">
                            <h3 data-i18n="kvs.title">Key-Value Store</h3>
                            <button id="btn-refresh-kvs" class="btn-small" data-i18n-title="kvs.refresh" title="Refresh from device">üîÑ</button>
                        </div>
                        
                        <div class="kvs-no-device" id="kvs-no-device">
                            <p data-i18n="kvs.no_device">Select a device from the list to view KVS entries.</p>
                        </div>
                        
                        <div class="kvs-content" id="kvs-content" style="display: none;">
                            <div class="kvs-loading" id="kvs-loading" style="display: none;">
                                <div class="spinner"></div>
                                <span data-i18n="kvs.loading">Loading KVS...</span>
                            </div>
                            
                            <div class="kvs-empty" id="kvs-empty" style="display: none;">
                                <p data-i18n="kvs.empty">No KVS entries found.</p>
                                <p class="kvs-hint" data-i18n="kvs.empty_hint">KVS keys are created by scripts.</p>
                            </div>
                            
                            <div class="kvs-table-container" id="kvs-table-container" style="display: none;">
                                <table class="kvs-table">
                                    <thead>
                                        <tr>
                                            <th data-i18n="kvs.key">Key</th>
                                            <th data-i18n="kvs.value">Value</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody id="kvs-table-body">
                                        <!-- KVS entries will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="kvs-actions" id="kvs-actions" style="display: none;">
                                <button id="btn-save-kvs" class="btn-primary" disabled data-i18n="kvs.save_changes">Save Changes</button>
                                <button id="btn-delete-all-kvs" class="btn-danger" data-i18n="kvs.delete_all">üóëÔ∏è Delete All</button>
                                <span class="kvs-changes-hint" id="kvs-changes-hint"></span>
                            </div>
                        </div>
                        
                        <div class="kvs-info">
                            <p data-i18n="kvs.info">‚ÑπÔ∏è Keys are created by scripts. Here you can only edit or delete existing keys.</p>
                        </div>
                    </div>
                </div>

                <!-- Webhooks Tab -->
                <div class="tab-pane" id="tab-webhooks">
                    <div class="webhooks-panel">
                        <div class="webhooks-header">
                            <h3 data-i18n="webhooks.title">Webhooks</h3>
                            <button id="btn-refresh-webhooks" class="btn-small" data-i18n-title="webhooks.refresh" title="Refresh from device">üîÑ</button>
                        </div>
                        
                        <div class="webhooks-no-device" id="webhooks-no-device">
                            <p data-i18n="webhooks.no_device">Select a device from the list to view webhooks.</p>
                        </div>
                        
                        <div class="webhooks-content" id="webhooks-content" style="display: none;">
                            <div class="webhooks-loading" id="webhooks-loading" style="display: none;">
                                <div class="spinner"></div>
                                <span data-i18n="webhooks.loading">Loading webhooks...</span>
                            </div>
                            
                            <div class="webhooks-list" id="webhooks-list">
                                <!-- Webhook entries will be loaded here -->
                            </div>
                            
                            <div class="webhooks-empty" id="webhooks-empty" style="display: none;">
                                <p data-i18n="webhooks.empty">No webhooks configured.</p>
                            </div>
                            
                            <!-- Create New Webhook -->
                            <div class="webhooks-create">
                                <h4 data-i18n="webhooks.new">New Webhook</h4>
                                <div class="webhook-form">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label data-i18n="webhooks.event">Event</label>
                                            <select id="webhook-event">
                                                <option value="" data-i18n="webhooks.select_event">-- Select event --</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label data-i18n="webhooks.component">Component</label>
                                            <select id="webhook-component">
                                                <option value="0">0</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label data-i18n="webhooks.name">Name (optional)</label>
                                        <input type="text" id="webhook-name" data-i18n-placeholder="webhooks.name_placeholder" placeholder="Webhook Name">
                                    </div>
                                    
                                    <!-- URL Builder -->
                                    <div class="url-builder">
                                        <div class="url-builder-header">
                                            <label data-i18n="webhooks.url_builder">URL Builder</label>
                                            <button type="button" class="btn-tiny" id="btn-toggle-url-builder">‚ñº</button>
                                        </div>
                                        <div class="url-builder-content" id="url-builder-content">
                                            <div class="form-row">
                                                <div class="form-group">
                                                    <label data-i18n="webhooks.target_device">Target device</label>
                                                    <select id="url-target-device">
                                                        <option value="" data-i18n="webhooks.select_device">-- Select device --</option>
                                                    </select>
                                                </div>
                                                <div class="form-group" style="flex: 0 0 120px;">
                                                    <label data-i18n="webhooks.or_ip">or IP</label>
                                                    <input type="text" id="url-target-ip" placeholder="192.168.x.x">
                                                </div>
                                            </div>
                                            <div class="form-row">
                                                <div class="form-group">
                                                    <label data-i18n="webhooks.action">Action</label>
                                                    <select id="url-action">
                                                        <option value="" data-i18n="webhooks.select_action">-- Select action --</option>
                                                        <optgroup label="Switch">
                                                            <option value="Switch.Set?id={id}&on=true">Switch.Set (on=true)</option>
                                                            <option value="Switch.Set?id={id}&on=false">Switch.Set (on=false)</option>
                                                            <option value="Switch.Toggle?id={id}">Switch.Toggle</option>
                                                        </optgroup>
                                                        <optgroup label="Cover">
                                                            <option value="Cover.Open?id={id}">Cover.Open</option>
                                                            <option value="Cover.Close?id={id}">Cover.Close</option>
                                                            <option value="Cover.Stop?id={id}">Cover.Stop</option>
                                                            <option value="Cover.GoToPosition?id={id}&pos={pos}">Cover.GoToPosition</option>
                                                        </optgroup>
                                                        <optgroup label="Light">
                                                            <option value="Light.Set?id={id}&on=true">Light.Set (on=true)</option>
                                                            <option value="Light.Set?id={id}&on=false">Light.Set (on=false)</option>
                                                            <option value="Light.Toggle?id={id}">Light.Toggle</option>
                                                        </optgroup>
                                                        <optgroup label="Input">
                                                            <option value="Input.Trigger?id={id}&event_type=single_push">Input.Trigger (single_push)</option>
                                                            <option value="Input.Trigger?id={id}&event_type=long_push">Input.Trigger (long_push)</option>
                                                        </optgroup>
                                                        <optgroup label="System">
                                                            <option value="Shelly.Reboot">Shelly.Reboot</option>
                                                        </optgroup>
                                                    </select>
                                                </div>
                                                <div class="form-group" style="flex: 0 0 60px;">
                                                    <label>ID</label>
                                                    <input type="number" id="url-param-id" value="0" min="0" max="10">
                                                </div>
                                            </div>
                                            <div class="form-row" id="url-extra-params" style="display: none;">
                                                <div class="form-group">
                                                    <label data-i18n="webhooks.position">Position (%)</label>
                                                    <input type="number" id="url-param-pos" value="50" min="0" max="100">
                                                </div>
                                            </div>
                                            <button type="button" class="btn-small btn-secondary" id="btn-generate-url" data-i18n="webhooks.generate_url">‚Üí Generate URL</button>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>URL</label>
                                        <input type="text" id="webhook-url" placeholder="http://192.168.x.x/rpc/...">
                                    </div>
                                    <div class="form-group">
                                        <label class="checkbox-inline">
                                            <input type="checkbox" id="webhook-enable" checked>
                                            <span data-i18n="webhooks.enabled">Enabled</span>
                                        </label>
                                    </div>
                                    <button id="btn-create-webhook" class="btn-primary" disabled data-i18n="webhooks.create">Create webhook</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="webhooks-info">
                            <p data-i18n="webhooks.info">‚ÑπÔ∏è Max. 20 webhooks per device. Events depend on device type.</p>
                        </div>
                    </div>
                </div>

                <!-- Firmware Tab -->
                <div class="tab-pane" id="tab-firmware">
                    <div class="firmware-panel">
                        <div class="firmware-header">
                            <h3 data-i18n="firmware.title">Firmware Updates</h3>
                            <button id="btn-check-firmware" class="btn-small" data-i18n-title="firmware.check_title" title="Check for updates">üîÑ <span data-i18n="firmware.check">Check</span></button>
                        </div>
                        
                        <div class="firmware-scope">
                            <label>
                                <input type="radio" name="fw-scope" value="filtered" checked>
                                <span data-i18n="firmware.filtered">Filtered</span> (<span id="fw-filtered-count">0</span>)
                            </label>
                            <label>
                                <input type="radio" name="fw-scope" value="all">
                                <span data-i18n="firmware.all">All</span> (<span id="fw-all-count">0</span>)
                            </label>
                        </div>
                        
                        <div class="firmware-loading" id="firmware-loading" style="display: none;">
                            <div class="spinner"></div>
                            <span data-i18n="firmware.checking">Checking firmware versions...</span>
                        </div>
                        
                        <div class="firmware-table-container" id="firmware-table-container" style="display: none;">
                            <table class="firmware-table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="fw-select-all" data-i18n-title="firmware.select_all" title="Select all"></th>
                                        <th data-i18n="firmware.device">Device</th>
                                        <th data-i18n="firmware.current">Current</th>
                                        <th data-i18n="firmware.available">Available</th>
                                        <th data-i18n="firmware.status">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="firmware-table-body">
                                    <!-- Firmware entries will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="firmware-empty" id="firmware-empty" style="display: none;">
                            <p data-i18n="firmware.empty">Click "Check" to check firmware versions.</p>
                        </div>
                        
                        <div class="firmware-actions" id="firmware-actions" style="display: none;">
                            <button id="btn-update-firmware" class="btn-primary" disabled>
                                <span data-i18n="firmware.update_selected">Update Selected</span> (<span id="fw-update-count">0</span>)
                            </button>
                            <button id="btn-update-all-outdated" class="btn-secondary" disabled data-i18n="firmware.update_all_outdated">
                                Update All Outdated
                            </button>
                        </div>
                        
                        <div class="firmware-progress" id="firmware-progress" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="firmware-progress-fill"></div>
                            </div>
                            <div class="progress-text" id="firmware-progress-text" data-i18n="firmware.updating">Updating...</div>
                        </div>
                        
                        <div class="firmware-info">
                            <p data-i18n="firmware.info">‚ÑπÔ∏è Updates may take several minutes. Devices reboot automatically.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Danger Zone - Device Removal -->
                <div class="danger-zone" id="danger-zone" style="display: none;">
                    <div class="danger-zone-content">
                        <div class="danger-item">
                            <div class="danger-info">
                                <span class="danger-title">‚ö†Ô∏è <span data-i18n="device.remove_device">Remove Device</span></span>
                                <span class="danger-description" data-i18n="device.remove_description">Removes this Shelly from the database</span>
                            </div>
                            <button id="btn-delete-device" class="btn-danger-small" data-i18n="device.remove">Remove</button>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Stage 1 Modal -->
    <div id="modal-stage1" class="modal-overlay">
        <div class="modal stage1-modal">
            <div class="modal-header">
                <h3 data-i18n="stage1.title">üîå Stage 1 ‚Äì AP Provisioning</h3>
                <p class="modal-subtitle" data-i18n="stage1.subtitle">Search for Shelly APs and configure WiFi</p>
            </div>
            
            <div class="stage1-status">
                <div class="status-indicator-large" id="stage1-status-indicator">
                    <div class="spinner-large"></div>
                </div>
                <div class="status-text" id="stage1-status-text" data-i18n="stage1.initializing">Initializing...</div>
            </div>
            
            <div class="stage1-devices">
                <h4><span data-i18n="stage1.processed_devices">Processed devices</span> <span id="stage1-device-count" class="device-count-badge">0</span></h4>
                <div class="device-list-mini" id="stage1-device-list">
                    <div class="empty-state" data-i18n="stage1.no_devices_yet">No devices yet</div>
                </div>
            </div>
            
            <div class="stage1-log" id="stage1-log">
                <!-- Live log entries -->
            </div>
            
            <div class="modal-actions">
                <button id="stage1-stop-btn" class="btn-danger" data-i18n="stage1.stop">‚èπ Stop</button>
            </div>
        </div>
    </div>

    <!-- Admin PIN Dialog -->
    <div id="modal-pin" class="modal-overlay">
        <div class="modal pin-modal">
            <div class="modal-header">
                <h3>üîê Admin Authentication</h3>
                <p class="modal-subtitle">Enter PIN for admin functions</p>
            </div>
            
            <div class="pin-form">
                <input type="password" id="admin-pin-input" placeholder="Enter PIN" 
                       autocomplete="off" maxlength="20" class="pin-input">
                <div class="pin-error" id="pin-error" style="display: none;"></div>
            </div>
            
            <div class="modal-actions">
                <button id="pin-cancel-btn" class="btn-secondary">Cancel</button>
                <button id="pin-submit-btn" class="btn-primary">Login</button>
            </div>
        </div>
    </div>

    <!-- YAML Editor Warning Modal -->
    <!-- Building Settings Modal -->
    <div id="modal-settings" class="modal-overlay">
        <div class="modal settings-modal">
            <div class="modal-header">
                <h3>‚öôÔ∏è <span data-i18n="settings.title">Building Settings</span></h3>
                <p class="modal-subtitle" id="settings-subtitle">Building: -</p>
            </div>
            
            <div class="settings-tabs">
                <button class="settings-tab-btn active" data-tab="provisioning" data-i18n="settings.tab_provisioning">Provisioning</button>
                <button class="settings-tab-btn" data-tab="ota" data-i18n="settings.tab_ota">OTA &amp; Names</button>
                <button class="settings-tab-btn" data-tab="export" data-i18n="settings.tab_export">Export</button>
                <button class="settings-tab-btn" data-tab="modelmap" data-i18n="settings.tab_modelmap">Model Map</button>
                <button class="settings-tab-btn" data-tab="object" data-i18n="settings.tab_object">Object</button>
                <button class="settings-tab-btn" data-tab="advanced" data-i18n="settings.tab_advanced">Advanced</button>
            </div>
            
            <div class="settings-content">
                <!-- Provisioning Tab -->
                <div class="settings-tab-content active" data-tab="provisioning">
                    <div class="settings-section">
                        <h4 data-i18n="settings.stage1_title">Stage 1 - Provisioning Options</h4>
                        <div class="settings-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="setting-loop-mode" checked>
                                <span data-i18n="settings.loop_mode">Loop Mode</span>
                                <small data-i18n="settings.loop_mode_desc">Continuously scan for new devices</small>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="setting-disable-ap" checked>
                                <span data-i18n="settings.disable_ap">Disable AP after provisioning</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="setting-disable-bt" checked>
                                <span data-i18n="settings.disable_bt">Disable Bluetooth</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="setting-disable-cloud" checked>
                                <span data-i18n="settings.disable_cloud">Disable Cloud</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="setting-disable-mqtt" checked>
                                <span data-i18n="settings.disable_mqtt">Disable MQTT</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- OTA & Names Tab -->
                <div class="settings-tab-content" data-tab="ota">
                    <div class="settings-section">
                        <h4 data-i18n="settings.ota_title">Firmware Updates (OTA)</h4>
                        <div class="settings-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="setting-ota-enabled" checked>
                                <span data-i18n="settings.ota_enabled">Enable OTA Updates</span>
                            </label>
                            <label class="setting-row">
                                <span data-i18n="settings.ota_mode">Update Mode</span>
                                <select id="setting-ota-mode">
                                    <option value="check_only" data-i18n="settings.ota_check_only">Check only</option>
                                    <option value="check_and_update" data-i18n="settings.ota_check_update">Check &amp; Update</option>
                                </select>
                            </label>
                            <label class="setting-row">
                                <span data-i18n="settings.ota_timeout">Timeout (seconds)</span>
                                <input type="number" id="setting-ota-timeout" min="5" max="120" value="20" class="setting-input-small">
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Export Tab -->
                <div class="settings-tab-content" data-tab="export">
                    <div class="settings-section">
                        <h4 data-i18n="settings.export_title">CSV Export Settings</h4>
                        <div class="settings-group">
                            <label class="setting-row">
                                <span data-i18n="settings.csv_delimiter">CSV Delimiter</span>
                                <select id="setting-csv-delimiter">
                                    <option value=";">Semicolon (;)</option>
                                    <option value=",">Comma (,)</option>
                                    <option value="&#9;">Tab</option>
                                </select>
                            </label>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h4 data-i18n="settings.columns_title">Default Columns</h4>
                        <div class="settings-columns-grid" id="settings-columns-grid">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
                
                <!-- Model Map Tab -->
                <div class="settings-tab-content" data-tab="modelmap">
                    <div class="settings-section">
                        <h4 data-i18n="settings.modelmap_title">Shelly Model Mapping</h4>
                        <p class="settings-hint" data-i18n="settings.modelmap_desc">Map hardware IDs to friendly display names</p>
                        <div class="modelmap-table-container">
                            <table class="modelmap-table" id="modelmap-table">
                                <thead>
                                    <tr>
                                        <th data-i18n="settings.hw_id">Hardware ID</th>
                                        <th data-i18n="settings.display_name">Display Name</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="modelmap-tbody">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>
                        <button id="modelmap-add-btn" class="btn-secondary btn-small">+ <span data-i18n="settings.add_model">Add Model</span></button>
                    </div>
                </div>
                
                <!-- Object Tab (Building Profile) -->
                <div class="settings-tab-content" data-tab="object">
                    <div class="settings-section">
                        <h4 data-i18n="building_profile.title">üè† Object Information</h4>
                        <p class="settings-hint" data-i18n="building_profile.hint">Customer and location data for installation reports.</p>
                        
                        <div class="settings-form-grid">
                            <div class="form-group">
                                <label for="building-object-name" data-i18n="building_profile.object_name">Object Name</label>
                                <input type="text" id="building-object-name" maxlength="200" data-i18n-placeholder="building_profile.object_placeholder" placeholder="e.g. Single Family House M√ºller">
                            </div>
                            <div class="form-group">
                                <label for="building-customer-name" data-i18n="building_profile.customer_name">Customer Name</label>
                                <input type="text" id="building-customer-name" maxlength="200" data-i18n-placeholder="building_profile.customer_placeholder" placeholder="e.g. Familie M√ºller">
                            </div>
                            <div class="form-group full-width">
                                <label for="building-address" data-i18n="building_profile.address">Address</label>
                                <textarea id="building-address" rows="2" maxlength="500" data-i18n-placeholder="building_profile.address_placeholder" placeholder="Street, ZIP City"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="building-contact-phone" data-i18n="building_profile.contact_phone">Phone</label>
                                <input type="tel" id="building-contact-phone" maxlength="50" data-i18n-placeholder="building_profile.phone_placeholder" placeholder="+41 44 123 45 67">
                            </div>
                            <div class="form-group">
                                <label for="building-contact-email" data-i18n="building_profile.contact_email">Email</label>
                                <input type="email" id="building-contact-email" maxlength="100" data-i18n-placeholder="building_profile.email_placeholder" placeholder="kunde@example.ch">
                            </div>
                            <div class="form-group full-width">
                                <label for="building-notes" data-i18n="building_profile.notes">Notes</label>
                                <textarea id="building-notes" rows="3" maxlength="1000" data-i18n-placeholder="building_profile.notes_placeholder" placeholder="Additional notes..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Advanced Tab -->
                <div class="settings-tab-content" data-tab="advanced">
                    <div class="settings-section">
                        <div class="advanced-warning">
                            <span class="warning-icon">‚ö†Ô∏è</span>
                            <span data-i18n="settings.advanced_warning">Direct YAML editing - incorrect changes can break the system!</span>
                        </div>
                        <label class="setting-row">
                            <span data-i18n="settings.select_file">Select File</span>
                            <select id="advanced-file-select">
                                <option value="">-- Select --</option>
                            </select>
                        </label>
                        <div class="yaml-editor-container">
                            <div class="yaml-toolbar">
                                <div class="yaml-status">
                                    <span class="yaml-valid-indicator" id="yaml-valid-indicator">‚óè</span>
                                    <span id="yaml-status-text">-</span>
                                </div>
                                <div class="yaml-actions-small">
                                    <button id="yaml-validate-btn" class="btn-small" title="Validate YAML">‚úì Validate</button>
                                </div>
                            </div>
                            <textarea id="yaml-editor" class="yaml-textarea" spellcheck="false" placeholder="Select a file to edit..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button id="admin-settings-cancel-btn" class="btn-secondary" data-i18n="common.close">Close</button>
                <button id="admin-settings-save-btn" class="btn-primary" data-i18n="common.save">üíæ Save</button>
            </div>
        </div>
    </div>

    <!-- Backups List Modal -->
    <div id="modal-backups" class="modal-overlay">
        <div class="modal backups-modal">
            <div class="modal-header">
                <h3>üìÅ Backups</h3>
                <p class="modal-subtitle" id="backups-subtitle">config.yaml</p>
            </div>
            
            <div class="backups-list" id="backups-list">
                <div class="empty-state">Keine Backups vorhanden</div>
            </div>
            
            <div class="modal-actions">
                <button id="backups-close-btn" class="btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Network Settings Modal -->
    <div id="modal-building-settings" class="modal-overlay">
        <div class="modal building-settings-modal">
            <div class="modal-header">
                <h3 data-i18n="building.title">‚öôÔ∏è Network Settings</h3>
                <p class="modal-subtitle" id="settings-building-name" data-i18n="building.building_label">Building: -</p>
            </div>
            
            <div class="settings-form">
                <!-- WiFi Section -->
                <div class="settings-section">
                    <h4 data-i18n="building.wifi_network">üì∂ WiFi Network</h4>
                    
                    <div class="wifi-group">
                        <div class="wifi-label" data-i18n="building.primary_required">Primary (required)</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="wifi-primary-ssid">SSID</label>
                                <input type="text" id="wifi-primary-ssid" data-i18n-placeholder="building.ssid_placeholder" placeholder="e.g. MyNetwork">
                            </div>
                            <div class="form-group">
                                <label for="wifi-primary-password" data-i18n="building.password">Password</label>
                                <div class="password-input-wrapper">
                                    <input type="password" id="wifi-primary-password" data-i18n-placeholder="building.wifi_password" placeholder="WiFi Password">
                                    <button type="button" class="toggle-password" data-target="wifi-primary-password">üëÅ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="wifi-group collapsible">
                        <div class="wifi-label clickable" id="toggle-fallback-wifi" data-i18n="building.fallback_wifi">
                            ‚ñ∂ Fallback WiFi (optional)
                        </div>
                        <div class="wifi-fallback-fields" id="fallback-wifi-fields" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="wifi-fallback-ssid">SSID</label>
                                    <input type="text" id="wifi-fallback-ssid" data-i18n-placeholder="building.ssid_fallback_placeholder" placeholder="e.g. MyNetwork_5G">
                                </div>
                                <div class="form-group">
                                    <label for="wifi-fallback-password" data-i18n="building.password">Password</label>
                                    <div class="password-input-wrapper">
                                        <input type="password" id="wifi-fallback-password" data-i18n-placeholder="building.wifi_password" placeholder="WiFi Password">
                                        <button type="button" class="toggle-password" data-target="wifi-fallback-password">üëÅ</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Network Section -->
                <div class="settings-section">
                    <h4 data-i18n="building.ip_ranges">üåê IP Address Ranges</h4>
                    <p class="section-hint" data-i18n="building.must_match_network">‚ö†Ô∏è Must match local network!</p>
                    
                    <div class="network-group">
                        <div class="network-label" data-i18n="building.shelly_pool">Shelly Pool (static IPs for devices)</div>
                        <div class="ip-range-labels">
                            <span data-i18n="building.from">From</span>
                            <span></span>
                            <span data-i18n="building.to">To</span>
                        </div>
                        <div class="ip-range-row">
                            <input type="text" id="pool-start" placeholder="192.168.1.100" class="ip-input">
                            <span class="range-separator">‚Äì</span>
                            <input type="text" id="pool-end" placeholder="192.168.1.150" class="ip-input">
                        </div>
                    </div>
                    
                    <div class="network-group">
                        <div class="network-label" data-i18n="building.gateway">Gateway (router IP, auto: .1)</div>
                        <div class="ip-single-row">
                            <input type="text" id="network-gateway" data-i18n-placeholder="building.auto_from_pool" placeholder="auto from pool" class="ip-input">
                        </div>
                    </div>
                    
                    <details class="advanced-network-section">
                        <summary data-i18n="building.advanced_dhcp">Advanced: DHCP Scan Range</summary>
                        <p class="advanced-hint" data-i18n="building.dhcp_hint">Optional ‚Äì if empty, scans entire subnet (slower but always works)</p>
                    <div class="network-group">
                        <div class="network-label" data-i18n="building.dhcp_scan">DHCP scan (range for new devices)</div>
                        <div class="ip-range-labels">
                            <span data-i18n="building.from">From</span>
                            <span></span>
                            <span data-i18n="building.to">To</span>
                        </div>
                        <div class="ip-range-row">
                            <input type="text" id="dhcp-start" placeholder="192.168.1.50" class="ip-input">
                            <span class="range-separator">‚Äì</span>
                            <input type="text" id="dhcp-end" placeholder="192.168.1.99" class="ip-input">
                        </div>
                    </div>
                    </details>
                    
                    <div class="network-info" id="network-info">
                        <span class="info-item" id="pool-count-info">Pool: - IPs</span>
                        <span class="info-item" id="dhcp-count-info">DHCP: - IPs</span>
                    </div>
                    
                    <div class="network-validation" id="network-validation" style="display: none;">
                        <!-- Validation errors/warnings will appear here -->
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button id="settings-cancel-btn" class="btn-secondary" data-i18n="common.cancel">Cancel</button>
                <button id="settings-save-btn" class="btn-primary" data-i18n="building.save">üíæ Save</button>
            </div>
        </div>
    </div>

    <!-- Export Labels Modal -->
    <div id="modal-export-labels" class="modal-overlay">
        <div class="modal export-modal">
            <div class="modal-header">
                <h3 data-i18n="export.title">üè∑Ô∏è Export Labels</h3>
                <p class="modal-subtitle"><span id="export-device-count">0</span> <span data-i18n="export.devices_selected">devices selected</span></p>
            </div>
            
            <div class="export-info">
                <p data-i18n="export.csv_columns">CSV with the following columns:</p>
                <ul>
                    <li><code>label_line1</code> ‚Äì <span data-i18n="export.example_line1">e.g. "50.41 Living room light switch door"</span></li>
                    <li><code>label_line2</code> ‚Äì <span data-i18n="export.example_line2">e.g. "Plus2PM 3DC35C"</span></li>
                    <li data-i18n="export.individual_fields">+ Individual fields (ip_short, room, location, model, mac_short)</li>
                </ul>
                <p class="export-hint" data-i18n="export.map_hint">Map fields in your label software as needed.</p>
            </div>
            
            <div id="export-result" class="export-result" style="display: none;">
                <!-- Success message will appear here -->
            </div>
            
            <div class="modal-actions">
                <button id="export-cancel-btn" class="btn-secondary" data-i18n="common.cancel">Cancel</button>
                <button id="export-download-btn" class="btn-primary" data-i18n="export.download_csv">üì• Download CSV</button>
            </div>
        </div>
    </div>

    <!-- Snapshots Modal -->
    <div id="modal-snapshots" class="modal-overlay">
        <div class="modal snapshots-modal">
            <div class="modal-header">
                <h3 data-i18n="snapshots.title">üìÇ Snapshots</h3>
                <p class="modal-subtitle" data-i18n="snapshots.subtitle">Device configuration backups</p>
            </div>
            
            <div id="snapshots-list" class="snapshots-list">
                <div class="loading-message" data-i18n="snapshots.loading">Loading snapshots...</div>
            </div>
            
            <div class="modal-actions">
                <button id="snapshots-close-btn" class="btn-secondary" data-i18n="common.close">Close</button>
                <button id="snapshots-create-btn" class="btn-primary" data-i18n="snapshots.create_new">üì∏ Create New</button>
            </div>
        </div>
    </div>

    <!-- Snapshot Progress Modal -->
    <div id="modal-snapshot-progress" class="modal-overlay">
        <div class="modal progress-modal">
            <div class="modal-header">
                <h3 data-i18n="snapshots.creating">üì∏ Creating Snapshot...</h3>
            </div>
            
            <div class="progress-content">
                <div class="spinner"></div>
                <p id="snapshot-progress-text" data-i18n="snapshots.scanning_devices">Scanning devices in IP range...</p>
                <p class="progress-hint" data-i18n="snapshots.progress_hint">This may take up to 2 minutes depending on the number of devices.</p>
            </div>
        </div>
    </div>

    <!-- Snapshot Reminder Modal (when leaving building) -->
    <div id="modal-snapshot-reminder" class="modal-overlay">
        <div class="modal reminder-modal">
            <div class="modal-header">
                <h3 data-i18n="snapshots.reminder_title">üì∏ Create Snapshot?</h3>
            </div>
            
            <div class="reminder-content">
                <p data-i18n="snapshots.no_recent">No recent snapshot found for this building.</p>
                <p data-i18n="snapshots.recommendation">It's recommended to create a snapshot before leaving to document the current installation state.</p>
            </div>
            
            <div class="modal-actions">
                <button id="reminder-skip-btn" class="btn-secondary" data-i18n="common.skip">Skip</button>
                <button id="reminder-create-btn" class="btn-primary" data-i18n="snapshots.create_snapshot">üì∏ Create Snapshot</button>
            </div>
        </div>
    </div>

    <!-- Audit Results Modal -->
    <!-- Audit Setup Modal -->
    <div id="modal-audit-setup" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 data-i18n="audit.setup_title">üîç Run Audit</h3>
                <button class="modal-close" onclick="closeAuditSetupModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <p data-i18n="audit.setup_description">Compare current device state with a previous snapshot to detect changes.</p>
                
                <div class="form-group">
                    <label data-i18n="audit.reference_snapshot">Reference Snapshot:</label>
                    <select id="audit-snapshot-select" class="form-select">
                        <option value="" data-i18n="audit.no_snapshots">Loading snapshots...</option>
                    </select>
                    <small class="form-hint" data-i18n="audit.snapshot_hint">Select a snapshot to compare against the current live state</small>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeAuditSetupModal()" data-i18n="common.cancel">Cancel</button>
                <button id="audit-start-btn" class="btn-primary" onclick="startAudit()" data-i18n="audit.start_audit">üîç Start Audit</button>
            </div>
        </div>
    </div>

    <!-- Audit Results Modal -->
    <div id="modal-audit" class="modal-overlay">
        <div class="modal audit-modal">
            <div class="modal-header">
                <h3 data-i18n="audit.results_title">üîç Audit Results</h3>
                <p class="modal-subtitle" id="audit-subtitle" data-i18n="audit.comparing">Comparing live state vs snapshot</p>
            </div>
            
            <div id="audit-summary" class="audit-summary">
                <!-- Summary will be inserted here -->
            </div>
            
            <div id="audit-results" class="audit-results">
                <div class="loading-message" data-i18n="audit.running">Running audit...</div>
            </div>
            
            <div class="modal-actions">
                <button id="audit-close-btn" class="btn-secondary" data-i18n="common.close">Close</button>
            </div>
        </div>
    </div>

    <!-- Audit Progress Modal -->
    <div id="modal-audit-progress" class="modal-overlay">
        <div class="modal progress-modal">
            <div class="modal-header">
                <h3 data-i18n="audit.running_title">üîç Running Audit...</h3>
            </div>
            
            <div class="progress-content">
                <div class="spinner"></div>
                <p data-i18n="audit.scanning_comparing">Scanning devices and comparing configurations...</p>
                <p class="progress-hint" data-i18n="audit.progress_hint">This may take up to 2 minutes.</p>
            </div>
        </div>
    </div>

    <!-- Report Generator Modal -->
    <div id="modal-report" class="modal-overlay">
        <div class="modal report-modal">
            <div class="modal-header">
                <h3 data-i18n="report.title">üìÑ Generate Installation Report</h3>
                <p class="modal-subtitle" data-i18n="report.subtitle">Create PDF report for customer handover</p>
            </div>
            
            <div class="report-options">
                <!-- Snapshot Selection -->
                <div class="report-section">
                    <label class="report-label" data-i18n="report.snapshot_source">Snapshot Source</label>
                    <div class="report-radio-group">
                        <label class="radio-label">
                            <input type="radio" name="snapshot-source" value="new" checked>
                            <span data-i18n="report.create_new">Create new snapshot</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="snapshot-source" value="existing">
                            <span data-i18n="report.use_existing">Use existing snapshot</span>
                        </label>
                    </div>
                    <select id="report-snapshot-select" class="report-select" disabled>
                        <option value="" data-i18n="report.select_snapshot">-- Select snapshot --</option>
                    </select>
                </div>
                
                <!-- Language Selection -->
                <div class="report-section">
                    <label class="report-label" data-i18n="report.language">Report Language</label>
                    <select id="report-language" class="report-select">
                        <option value="de">Deutsch</option>
                        <option value="en">English</option>
                        <option value="fr">Fran√ßais</option>
                        <option value="it">Italiano</option>
                        <option value="nl">Nederlands</option>
                    </select>
                </div>
                
                <!-- Format Selection -->
                <div class="report-section">
                    <label class="report-label" data-i18n="report.format">Output Format</label>
                    <select id="report-format" class="report-select">
                        <option value="pdf">PDF</option>
                        <option value="xlsx">Excel (XLSX)</option>
                    </select>
                </div>
                
                <!-- Info Box -->
                <div class="report-info">
                    <p data-i18n="report.info_text">The report includes device overview with QR codes, technical details, and your company branding from the Installer Profile.</p>
                </div>
            </div>
            
            <div id="report-progress" class="report-progress" style="display: none;">
                <div class="spinner"></div>
                <p data-i18n="report.generating">Generating report...</p>
            </div>
            
            <div id="report-error" class="error-message" style="display: none;"></div>
            
            <div class="modal-actions">
                <button id="report-cancel-btn" class="btn-secondary" data-i18n="common.cancel">Cancel</button>
                <button id="report-generate-btn" class="btn-primary" data-i18n="report.generate_btn">üìÑ Generate</button>
            </div>
        </div>
    </div>

    <!-- Replace Device Modal -->
    <div id="modal-replace-device" class="modal-overlay">
        <div class="modal replace-modal">
            <div class="modal-header">
                <h3 data-i18n="replace.title">üîÑ Replace Device</h3>
                <p class="modal-subtitle" data-i18n="replace.subtitle">Swap a failed device with a new one</p>
            </div>
            
            <div class="replace-content">
                <!-- Step 1: Select old device -->
                <div class="replace-section">
                    <label class="replace-label" data-i18n="replace.step1">1. Select device to replace:</label>
                    <select id="replace-old-device" class="replace-select">
                        <option value="" data-i18n="replace.select_device">-- Select device --</option>
                    </select>
                    <div id="replace-old-info" class="replace-device-info" style="display: none;"></div>
                </div>
                
                <!-- Step 2: Find new device -->
                <div class="replace-section">
                    <label class="replace-label" data-i18n="replace.step2">2. Find new device in DHCP range:</label>
                    <div class="replace-scan-row">
                        <select id="replace-new-device" class="replace-select" disabled>
                            <option value="" data-i18n="replace.scan_first">-- Scan first --</option>
                        </select>
                        <button id="replace-scan-btn" class="btn-secondary" data-i18n="replace.scan">üîç Scan</button>
                    </div>
                    <div id="replace-new-info" class="replace-device-info" style="display: none;"></div>
                </div>
                
                <!-- Type check warning -->
                <div id="replace-type-warning" class="replace-warning" style="display: none;" data-i18n="replace.type_warning">
                    ‚ö†Ô∏è Device types don't match! Are you sure?
                </div>
                
                <!-- Snapshot config info -->
                <div id="replace-snapshot-info" class="replace-snapshot-info" style="display: none;">
                    <label class="replace-label" data-i18n="replace.snapshot_config">üì∏ Old device config from snapshot:</label>
                    <div id="replace-snapshot-content" class="replace-snapshot-content"></div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button id="replace-cancel-btn" class="btn-secondary" data-i18n="common.cancel">Cancel</button>
                <button id="replace-execute-btn" class="btn-primary" disabled data-i18n="replace.replace_btn">üîÑ Replace</button>
            </div>
        </div>
    </div>

    <!-- Replace Device Progress Modal -->
    <div id="modal-replace-progress" class="modal-overlay">
        <div class="modal progress-modal">
            <div class="modal-header">
                <h3 data-i18n="replace.replacing">üîÑ Replacing Device...</h3>
            </div>
            
            <div class="progress-content">
                <div class="spinner"></div>
                <p id="replace-progress-text" data-i18n="replace.updating_state">Updating ip_state.json...</p>
                <p class="progress-hint" data-i18n="common.please_wait">Please wait.</p>
            </div>
        </div>
    </div>

    <!-- Replace Device Result Modal -->
    <div id="modal-replace-result" class="modal-overlay">
        <div class="modal replace-result-modal">
            <div class="modal-header">
                <h3 id="replace-result-title" data-i18n="replace.success">‚úÖ Device Replaced</h3>
            </div>
            
            <div id="replace-result-content" class="replace-result-content">
                <!-- Result will be inserted here -->
            </div>
            
            <div class="modal-actions">
                <button id="replace-result-close-btn" class="btn-primary" data-i18n="common.close">Close</button>
            </div>
        </div>
    </div>

    <style>
        /* Stage 1 Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .stage1-modal {
            background: var(--bg-card, #1f2940);
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-header h3 {
            margin-bottom: 0.5rem;
            font-size: 1.5rem;
        }
        
        .modal-subtitle {
            color: var(--text-secondary, #a0a0a0);
            font-size: 0.9rem;
        }
        
        /* Warning Modal */
        .warning-modal {
            max-width: 450px;
            text-align: center;
        }
        
        .warning-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .warning-modal h3 {
            margin-bottom: 1rem;
            color: var(--accent-warning, #ff9800);
        }
        
        .warning-content {
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }
        
        .warning-content p {
            margin-bottom: 0.75rem;
            color: var(--text-secondary, #a0a0a0);
        }
        
        .warning-content p:last-child {
            margin-bottom: 0;
        }
        
        .warning-highlight {
            color: var(--accent-danger, #f44336) !important;
            font-weight: 600;
        }
        
        .stage1-status {
            text-align: center;
            padding: 2rem;
            background: var(--bg-secondary, #16213e);
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        
        .status-indicator-large {
            width: 60px;
            height: 60px;
            margin: 0 auto 1rem;
        }
        
        .spinner-large {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border-color, #2a3a5a);
            border-top-color: var(--accent-primary, #4a9eff);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .status-indicator-large.waiting .spinner-large {
            border-top-color: var(--accent-warning, #ff9800);
            animation-duration: 2s;
        }
        
        .status-indicator-large.success .spinner-large {
            border: 4px solid var(--accent-success, #4caf50);
            animation: none;
        }
        
        .status-indicator-large.success .spinner-large::after {
            content: "‚úì";
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            font-size: 2rem;
            color: var(--accent-success, #4caf50);
        }
        
        .status-text {
            font-size: 1.1rem;
            font-weight: 500;
        }
        
        .stage1-devices {
            margin-bottom: 1.5rem;
        }
        
        .stage1-devices h4 {
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary, #a0a0a0);
        }
        
        .device-count-badge {
            display: inline-block;
            background: var(--accent-color, #4ade80);
            color: #000;
            font-weight: bold;
            font-size: 0.8rem;
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
            margin-left: 0.5rem;
            min-width: 1.5rem;
            text-align: center;
        }
        
        .device-list-mini {
            background: var(--bg-secondary, #16213e);
            border-radius: 8px;
            padding: 0.5rem;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .device-list-mini .empty-state {
            text-align: center;
            padding: 1rem;
            color: var(--text-secondary, #a0a0a0);
            font-size: 0.9rem;
        }
        
        .device-mini-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background: var(--bg-card, #1f2940);
            border-radius: 4px;
            margin-bottom: 0.25rem;
            font-size: 0.85rem;
        }
        
        .device-mini-item:last-child {
            margin-bottom: 0;
        }
        
        .device-mini-item .mac {
            font-family: monospace;
            color: var(--accent-primary, #4a9eff);
        }
        
        .device-mini-item .model {
            color: var(--text-secondary, #a0a0a0);
        }
        
        .device-mini-item .status-icon {
            color: var(--accent-success, #4caf50);
        }
        
        .stage1-log {
            background: #0d1117;
            border-radius: 8px;
            padding: 0.75rem;
            max-height: 120px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.75rem;
            margin-bottom: 1.5rem;
        }
        
        .log-entry {
            color: #8b949e;
            margin-bottom: 0.25rem;
        }
        
        .log-entry.success {
            color: var(--accent-success, #4caf50);
        }
        
        .log-entry.warning {
            color: var(--accent-warning, #ff9800);
        }
        
        .log-entry.error {
            color: var(--accent-danger, #f44336);
        }
        
        .modal-actions {
            display: flex;
            justify-content: center;
        }
        
        .btn-danger {
            background: var(--accent-danger, #f44336);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-danger:hover {
            background: #e53935;
        }
        
        /* Admin Buttons */
        .admin-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.125rem;
        }
        
        .admin-btn {
            padding: 0.5rem 0.75rem;
            background: transparent;
            border: none;
            border-radius: 4px;
            color: var(--text-primary, #e0e0e0);
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 400;
            text-align: left;
            transition: all 0.2s ease;
        }
        
        .admin-btn:hover {
            background: var(--bg-card, #1f2940);
        }
        
        /* PIN Modal */
        .pin-modal {
            background: var(--bg-card, #1f2940);
            border-radius: 12px;
            padding: 2rem;
            max-width: 360px;
            width: 90%;
        }
        
        .pin-form {
            margin: 1.5rem 0;
        }
        
        .pin-input {
            width: 100%;
            padding: 1rem;
            font-size: 1.2rem;
            text-align: center;
            letter-spacing: 0.5rem;
            background: var(--bg-secondary, #16213e);
            border: 2px solid var(--border-color, #2a3a5a);
            border-radius: 8px;
            color: var(--text-primary, #e0e0e0);
        }
        
        .pin-input:focus {
            outline: none;
            border-color: var(--accent-primary, #4a9eff);
        }
        
        .pin-error {
            color: var(--accent-danger, #f44336);
            font-size: 0.9rem;
            text-align: center;
            margin-top: 0.75rem;
        }
        
        /* YAML Editor Modal */
        .yaml-editor-modal {
            background: var(--bg-card, #1f2940);
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .yaml-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .yaml-tab-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-secondary, #16213e);
            border: 1px solid var(--border-color, #2a3a5a);
            border-radius: 6px;
            color: var(--text-secondary, #a0a0a0);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        
        .yaml-tab-btn:hover {
            background: var(--bg-hover, #253050);
        }
        
        .yaml-tab-btn.active {
            background: var(--accent-primary, #4a9eff);
            color: white;
            border-color: var(--accent-primary, #4a9eff);
        }
        
        .yaml-editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .yaml-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background: var(--bg-secondary, #16213e);
            border-radius: 6px 6px 0 0;
            border: 1px solid var(--border-color, #2a3a5a);
            border-bottom: none;
        }
        
        .yaml-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }
        
        .yaml-valid-indicator {
            font-size: 1rem;
        }
        
        .yaml-valid-indicator.valid {
            color: var(--accent-success, #4caf50);
        }
        
        .yaml-valid-indicator.invalid {
            color: var(--accent-danger, #f44336);
        }
        
        .yaml-valid-indicator.warning {
            color: var(--accent-warning, #ff9800);
        }
        
        .yaml-actions-small {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            background: var(--bg-card, #1f2940);
            border: 1px solid var(--border-color, #2a3a5a);
            border-radius: 4px;
            color: var(--text-secondary, #a0a0a0);
            cursor: pointer;
        }
        
        .btn-small:hover {
            background: var(--bg-hover, #253050);
            color: var(--text-primary, #e0e0e0);
        }
        
        .yaml-textarea {
            flex: 1;
            width: 100%;
            min-height: 400px;
            padding: 1rem;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            background: #0d1117;
            color: #c9d1d9;
            border: 1px solid var(--border-color, #2a3a5a);
            border-radius: 0 0 6px 6px;
            resize: vertical;
            tab-size: 2;
        }
        
        .yaml-textarea:focus {
            outline: none;
            border-color: var(--accent-primary, #4a9eff);
        }
        
        .yaml-warnings {
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: rgba(255, 152, 0, 0.1);
            border: 1px solid var(--accent-warning, #ff9800);
            border-radius: 6px;
        }
        
        .yaml-warning-item {
            color: var(--accent-warning, #ff9800);
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }
        
        .yaml-warning-item:last-child {
            margin-bottom: 0;
        }
        
        /* Settings Modal */
        .settings-modal {
            background: var(--bg-card, #1f2940);
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 800px;
            width: 95%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .settings-tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .settings-tab-btn {
            padding: 0.5rem 0.75rem;
            background: var(--bg-secondary, #16213e);
            border: 1px solid var(--border-color, #2a3a5a);
            border-radius: 6px;
            color: var(--text-secondary, #a0a0a0);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }
        
        .settings-tab-btn:hover {
            background: var(--bg-hover, #253050);
        }
        
        .settings-tab-btn.active {
            background: var(--accent-primary, #4a9eff);
            color: white;
            border-color: var(--accent-primary, #4a9eff);
        }
        
        .settings-content {
            flex: 1;
            overflow-y: auto;
            min-height: 300px;
            max-height: 60vh;
        }
        
        .settings-tab-content {
            display: none;
        }
        
        .settings-tab-content.active {
            display: block;
        }
        
        .settings-section {
            margin-bottom: 1.5rem;
        }
        
        .settings-section h4 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary, #e0e0e0);
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color, #2a3a5a);
        }
        
        .settings-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .checkbox-label {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            cursor: pointer;
        }
        
        .checkbox-label > span:first-of-type {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-primary, #e0e0e0);
        }
        
        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-primary, #4a9eff);
        }
        
        .checkbox-label small {
            margin-left: 26px;
            color: var(--text-secondary, #a0a0a0);
            font-size: 0.8rem;
        }
        
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            color: var(--text-primary, #e0e0e0);
        }
        
        .setting-row select,
        .setting-row input {
            padding: 0.5rem;
            background: var(--bg-secondary, #16213e);
            border: 1px solid var(--border-color, #2a3a5a);
            border-radius: 6px;
            color: var(--text-primary, #e0e0e0);
            font-size: 0.9rem;
        }
        
        .setting-row select {
            min-width: 180px;
        }
        
        .setting-input-small {
            width: 80px;
            text-align: center;
        }
        
        .settings-hint {
            color: var(--text-secondary, #a0a0a0);
            font-size: 0.85rem;
            margin-bottom: 0.75rem;
        }
        
        /* Building Profile Form Grid */
        .settings-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .settings-form-grid .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .settings-form-grid .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .settings-form-grid label {
            color: var(--text-secondary, #a0a0a0);
            font-size: 0.85rem;
        }
        
        .settings-form-grid input,
        .settings-form-grid textarea {
            padding: 0.5rem 0.75rem;
            background: var(--bg-secondary, #16213e);
            border: 1px solid var(--border-color, #2a3a5a);
            border-radius: 6px;
            color: var(--text-primary, #e0e0e0);
            font-size: 0.9rem;
            font-family: inherit;
        }
        
        .settings-form-grid input:focus,
        .settings-form-grid textarea:focus {
            outline: none;
            border-color: var(--accent-primary, #4a9eff);
        }
        
        .settings-form-grid textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        @media (max-width: 600px) {
            .settings-form-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .settings-columns-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 0.5rem;
        }
        
        .settings-columns-grid label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-primary, #e0e0e0);
            font-size: 0.9rem;
        }
        
        /* Model Map Table */
        .modelmap-table-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color, #2a3a5a);
            border-radius: 6px;
            margin-bottom: 0.75rem;
        }
        
        .modelmap-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .modelmap-table th,
        .modelmap-table td {
            padding: 0.5rem 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color, #2a3a5a);
        }
        
        .modelmap-table th {
            background: var(--bg-secondary, #16213e);
            color: var(--text-secondary, #a0a0a0);
            font-weight: 500;
            font-size: 0.85rem;
            position: sticky;
            top: 0;
        }
        
        .modelmap-table td {
            color: var(--text-primary, #e0e0e0);
        }
        
        .modelmap-table input {
            width: 100%;
            padding: 0.35rem 0.5rem;
            background: var(--bg-secondary, #16213e);
            border: 1px solid var(--border-color, #2a3a5a);
            border-radius: 4px;
            color: var(--text-primary, #e0e0e0);
            font-size: 0.9rem;
            font-family: monospace;
        }
        
        .modelmap-table input:focus {
            outline: none;
            border-color: var(--accent-primary, #4a9eff);
        }
        
        .modelmap-table .delete-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary, #a0a0a0);
            cursor: pointer;
            padding: 0.25rem;
            font-size: 1.1rem;
            transition: color 0.2s;
        }
        
        .modelmap-table .delete-btn:hover {
            color: var(--accent-danger, #f44336);
        }
        
        /* Advanced Tab */
        .advanced-warning {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: rgba(255, 152, 0, 0.1);
            border: 1px solid var(--accent-warning, #ff9800);
            border-radius: 6px;
            margin-bottom: 1rem;
            color: var(--accent-warning, #ff9800);
            font-size: 0.9rem;
        }
        
        .advanced-warning .warning-icon {
            font-size: 1.2rem;
        }
        
        #advanced-file-select {
            width: 100%;
            margin-bottom: 1rem;
        }

        /* Backups Modal */
        .backups-modal {
            background: var(--bg-card, #1f2940);
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 500px;
            width: 90%;
        }
        
        .backups-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 1rem 0;
        }
        
        .backup-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--bg-secondary, #16213e);
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }
        
        .backup-item:last-child {
            margin-bottom: 0;
        }
        
        .backup-info {
            flex: 1;
        }
        
        .backup-date {
            font-size: 0.9rem;
            color: var(--text-primary, #e0e0e0);
        }
        
        .backup-size {
            font-size: 0.8rem;
            color: var(--text-secondary, #a0a0a0);
        }
        
        .backup-restore-btn {
            padding: 0.5rem 1rem;
            background: var(--accent-primary, #4a9eff);
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .backup-restore-btn:hover {
            background: #3a8eef;
        }
        
        /* General modal button improvements */
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1rem;
        }
        
        .btn-secondary {
            padding: 0.75rem 1.5rem;
            background: var(--bg-secondary, #16213e);
            border: 1px solid var(--border-color, #2a3a5a);
            border-radius: 8px;
            color: var(--text-primary, #e0e0e0);
            cursor: pointer;
            font-size: 1rem;
        }
        
        .btn-secondary:hover {
            background: var(--bg-hover, #253050);
        }
        
        .btn-primary {
            padding: 0.75rem 1.5rem;
            background: var(--accent-primary, #4a9eff);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #3a8eef;
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Settings Buttons */
        .settings-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.125rem;
        }
        
        .settings-btn {
            padding: 0.5rem 0.75rem;
            background: transparent;
            border: none;
            border-radius: 4px;
            color: var(--text-primary, #e0e0e0);
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 400;
            text-align: left;
            transition: all 0.2s ease;
        }
        
        .settings-btn:hover {
            background: var(--bg-card, #1f2940);
        }
        
        /* Building Settings Modal */
        .building-settings-modal {
            background: var(--bg-card, #1f2940);
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 600px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .settings-form {
            margin: 1rem 0;
        }
        
        .settings-section {
            background: var(--bg-secondary, #16213e);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .settings-section h4 {
            margin: 0 0 0.75rem 0;
            font-size: 1rem;
            color: var(--text-primary, #e0e0e0);
        }
        
        .section-hint {
            font-size: 0.85rem;
            color: var(--accent-warning, #ff9800);
            margin-bottom: 1rem;
        }
        
        .wifi-group, .network-group {
            margin-bottom: 1rem;
        }
        
        .wifi-group:last-child, .network-group:last-child {
            margin-bottom: 0;
        }
        
        .wifi-label, .network-label {
            font-size: 0.85rem;
            color: var(--text-secondary, #a0a0a0);
            margin-bottom: 0.5rem;
        }
        
        .wifi-label.clickable {
            cursor: pointer;
            user-select: none;
        }
        
        .wifi-label.clickable:hover {
            color: var(--accent-primary, #4a9eff);
        }
        
        .wifi-fallback-fields {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px dashed var(--border-color, #2a3a5a);
        }
        
        .form-row {
            display: flex;
            gap: 1rem;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .ip-range-labels {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
            font-size: 0.8rem;
            color: var(--text-secondary, #a0a0a0);
        }
        
        .ip-range-labels span:first-child,
        .ip-range-labels span:last-child {
            flex: 1;
        }
        
        .ip-range-labels span:nth-child(2) {
            width: 1.5rem;
        }
        
        .ip-range-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .ip-range-row input {
            flex: 1;
            padding: 0.6rem 0.75rem;
            background: var(--bg-card, #1f2940);
            border: 1px solid var(--border-color, #2a3a5a);
            border-radius: 6px;
            color: var(--text-primary, #e0e0e0);
            font-size: 0.95rem;
            font-family: 'Monaco', 'Menlo', monospace;
        }
        
        .ip-range-row input:focus {
            outline: none;
            border-color: var(--accent-primary, #4a9eff);
        }
        
        .ip-range-row input.error {
            border-color: var(--accent-danger, #f44336);
        }
        
        .range-separator {
            color: var(--text-secondary, #a0a0a0);
            font-size: 1.2rem;
            width: 1.5rem;
            text-align: center;
        }
        
        .ip-single-row {
            display: flex;
            align-items: center;
        }
        
        .ip-single-row input {
            width: 180px;
            padding: 0.6rem 0.75rem;
            background: var(--bg-card, #1f2940);
            border: 1px solid var(--border-color, #2a3a5a);
            border-radius: 6px;
            color: var(--text-primary, #e0e0e0);
            font-size: 0.95rem;
            font-family: 'Monaco', 'Menlo', monospace;
        }
        
        .ip-single-row input:focus {
            outline: none;
            border-color: var(--accent-primary, #4a9eff);
        }
        
        .advanced-network-section {
            margin-top: 1rem;
            padding: 0.75rem;
            background: var(--bg-card, #1f2940);
            border-radius: 6px;
            border: 1px solid var(--border-color, #2a3a5a);
        }
        
        .advanced-network-section summary {
            cursor: pointer;
            color: var(--text-secondary, #a0a0a0);
            font-size: 0.9rem;
            user-select: none;
        }
        
        .advanced-network-section summary:hover {
            color: var(--text-primary, #e0e0e0);
        }
        
        .advanced-network-section[open] summary {
            margin-bottom: 0.75rem;
        }
        
        .advanced-hint {
            font-size: 0.8rem;
            color: var(--text-muted, #666);
            margin: 0.5rem 0;
        }
        
        .settings-section .form-group {
            margin-bottom: 0.75rem;
        }
        
        .settings-section .form-group:last-child {
            margin-bottom: 0;
        }
        
        .settings-section .form-group label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-secondary, #a0a0a0);
            margin-bottom: 0.25rem;
        }
        
        .settings-section .form-group input {
            width: 100%;
            padding: 0.6rem 0.75rem;
            background: var(--bg-card, #1f2940);
            border: 1px solid var(--border-color, #2a3a5a);
            border-radius: 6px;
            color: var(--text-primary, #e0e0e0);
            font-size: 0.95rem;
        }
        
        .settings-section .form-group input:focus {
            outline: none;
            border-color: var(--accent-primary, #4a9eff);
        }
        
        .settings-section .form-group input.error {
            border-color: var(--accent-danger, #f44336);
        }
        
        .ip-input {
            font-family: 'Monaco', 'Menlo', monospace;
        }
        
        .password-input-wrapper {
            position: relative;
            display: flex;
        }
        
        .password-input-wrapper input {
            flex: 1;
            padding-right: 2.5rem;
        }
        
        .toggle-password {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary, #a0a0a0);
            cursor: pointer;
            padding: 0.25rem;
            font-size: 1rem;
        }
        
        .toggle-password:hover {
            color: var(--text-primary, #e0e0e0);
        }
        
        .network-info {
            display: flex;
            gap: 1.5rem;
            margin-top: 0.75rem;
            padding: 0.5rem 0.75rem;
            background: var(--bg-card, #1f2940);
            border-radius: 6px;
        }
        
        .info-item {
            font-size: 0.85rem;
            color: var(--text-secondary, #a0a0a0);
        }
        
        .info-item.valid {
            color: var(--accent-success, #4caf50);
        }
        
        .network-validation {
            margin-top: 0.75rem;
            padding: 0.75rem;
            border-radius: 6px;
        }
        
        .network-validation.has-errors {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid var(--accent-danger, #f44336);
        }
        
        .network-validation.has-warnings {
            background: rgba(255, 152, 0, 0.1);
            border: 1px solid var(--accent-warning, #ff9800);
        }
        
        .validation-error {
            color: var(--accent-danger, #f44336);
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }
        
        .validation-warning {
            color: var(--accent-warning, #ff9800);
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }
        
        .validation-error:last-child, .validation-warning:last-child {
            margin-bottom: 0;
        }
        
        /* Export Labels Modal */
        .export-modal {
            max-width: 450px;
        }
        
        .export-info {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--bg-secondary, #16213e);
            border-radius: 8px;
        }
        
        .export-info p {
            margin: 0 0 0.5rem 0;
            color: var(--text-secondary, #a0a0a0);
        }
        
        .export-info ul {
            margin: 0.5rem 0;
            padding-left: 1.25rem;
        }
        
        .export-info li {
            margin: 0.25rem 0;
            color: var(--text-primary, #e0e0e0);
            font-size: 0.9rem;
        }
        
        .export-info code {
            background: var(--bg-card, #1f2940);
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85rem;
        }
        
        .export-result {
            margin-bottom: 1.5rem;
        }
        
        .export-success {
            text-align: center;
            padding: 1.5rem;
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid var(--accent-success, #4caf50);
            border-radius: 8px;
        }
        
        .export-success p {
            margin: 0.5rem 0;
        }
        
        .export-success p:first-child {
            font-size: 1.25rem;
            color: var(--accent-success, #4caf50);
        }
        
        .export-filename {
            font-family: 'Monaco', 'Menlo', monospace;
            background: var(--bg-secondary, #16213e);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            display: inline-block;
            margin: 0.5rem 0 !important;
        }
        
        .export-hint {
            font-size: 0.85rem;
            color: var(--text-secondary, #a0a0a0) !important;
        }
        
        /* Snapshots Modal */
        .snapshots-modal {
            max-width: 550px;
        }
        
        .snapshots-list {
            max-height: 350px;
            overflow-y: auto;
            margin-bottom: 1.5rem;
        }
        
        .snapshot-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary, #16213e);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
        
        .snapshot-info {
            flex: 1;
        }
        
        .snapshot-filename {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            color: var(--text-primary, #e0e0e0);
        }
        
        .snapshot-meta {
            font-size: 0.8rem;
            color: var(--text-secondary, #a0a0a0);
            margin-top: 0.25rem;
        }
        
        .snapshot-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .snapshot-actions button {
            padding: 0.4rem 0.6rem;
            font-size: 0.8rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .snapshot-download {
            background: var(--accent-primary, #4a9eff);
            color: white;
        }
        
        .snapshot-delete {
            background: var(--accent-danger, #ff5252);
            color: white;
        }
        
        .snapshots-empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary, #a0a0a0);
        }
        
        /* Snapshot Badge */
        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            font-size: 0.7rem;
            font-weight: bold;
            border-radius: 9px;
            margin-left: 0.5rem;
        }
        
        .badge-warning {
            background: var(--accent-warning, #ffc107);
            color: #000;
        }
        
        /* Reminder Modal */
        .reminder-modal {
            max-width: 400px;
        }
        
        .reminder-content {
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .reminder-content p {
            margin: 0.5rem 0;
            color: var(--text-secondary, #a0a0a0);
        }
        
        .reminder-content p:first-child {
            color: var(--accent-warning, #ffc107);
            font-weight: 500;
        }
        
        /* Progress Modal */
        .progress-modal {
            max-width: 350px;
            text-align: center;
        }
        
        .progress-content {
            padding: 2rem 1rem;
        }
        
        .progress-content p {
            margin: 0.5rem 0;
            color: var(--text-primary, #e0e0e0);
        }
        
        .progress-hint {
            font-size: 0.85rem;
            color: var(--text-secondary, #a0a0a0) !important;
            margin-top: 1rem !important;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--bg-secondary, #16213e);
            border-top-color: var(--accent-primary, #4a9eff);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Report Modal */
        .report-modal {
            max-width: 450px;
        }
        
        .report-options {
            padding: 0.5rem 0;
        }
        
        .report-section {
            margin-bottom: 1.25rem;
        }
        
        .report-label {
            display: block;
            font-weight: 600;
            color: var(--text-primary, #e0e0e0);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .report-radio-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        
        .radio-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            color: var(--text-primary, #e0e0e0);
            font-size: 0.9rem;
        }
        
        .radio-label input[type="radio"] {
            width: 16px;
            height: 16px;
            accent-color: var(--accent-primary, #4a9eff);
        }
        
        .report-select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            background: var(--bg-secondary, #16213e);
            border: 1px solid var(--border-color, #2a3a5a);
            border-radius: 6px;
            color: var(--text-primary, #e0e0e0);
            font-size: 0.9rem;
        }
        
        .report-select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .report-info {
            background: var(--bg-secondary, #16213e);
            border: 1px solid var(--border-color, #2a3a5a);
            border-radius: 6px;
            padding: 0.75rem 1rem;
            margin-top: 1rem;
        }
        
        .report-info p {
            margin: 0;
            font-size: 0.85rem;
            color: var(--text-secondary, #a0a0a0);
        }
        
        .report-progress {
            text-align: center;
            padding: 2rem 1rem;
        }
        
        .report-progress p {
            margin: 0.5rem 0 0 0;
            color: var(--text-primary, #e0e0e0);
        }
        
        /* Audit Modal */
        .audit-modal {
            max-width: 700px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        
        .audit-summary {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-secondary, #16213e);
            border-radius: 8px;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .audit-stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 500;
        }
        
        .audit-stat.ok {
            background: rgba(76, 175, 80, 0.2);
            color: var(--accent-success, #4caf50);
        }
        
        .audit-stat.warning {
            background: rgba(255, 193, 7, 0.2);
            color: var(--accent-warning, #ffc107);
        }
        
        .audit-stat.offline {
            background: rgba(255, 82, 82, 0.2);
            color: var(--accent-danger, #ff5252);
        }
        
        .audit-stat.unknown, .audit-stat.new {
            background: rgba(33, 150, 243, 0.2);
            color: #64b5f6;
        }
        
        .audit-results {
            flex: 1;
            overflow-y: auto;
            max-height: 400px;
        }
        
        .audit-device {
            padding: 0.75rem 1rem;
            background: var(--bg-secondary, #16213e);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border-left: 4px solid transparent;
        }
        
        .audit-device.ok {
            border-left-color: var(--accent-success, #4caf50);
        }
        
        .audit-device.warning {
            border-left-color: var(--accent-warning, #ffc107);
        }
        
        .audit-device.offline {
            border-left-color: var(--accent-danger, #ff5252);
        }
        
        .audit-device.unknown, .audit-device.new {
            border-left-color: #64b5f6;
        }
        
        .audit-device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .audit-device-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .audit-device-status {
            font-size: 1.2rem;
        }
        
        .audit-device-name {
            font-weight: 500;
            color: var(--text-primary, #e0e0e0);
        }
        
        .audit-device-ip {
            color: var(--text-secondary, #a0a0a0);
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85rem;
        }
        
        .audit-device-model {
            color: var(--text-secondary, #a0a0a0);
            font-size: 0.85rem;
        }
        
        .audit-device-sources {
            display: flex;
            gap: 0.5rem;
        }
        
        .audit-source {
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            background: var(--bg-card, #1f2940);
        }
        
        .audit-source.present {
            background: rgba(76, 175, 80, 0.3);
            color: var(--accent-success, #4caf50);
        }
        
        .audit-source.missing {
            background: rgba(255, 82, 82, 0.3);
            color: var(--accent-danger, #ff5252);
        }
        
        .audit-differences {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border-color, #2a3a5a);
        }
        
        .audit-diff-item {
            font-size: 0.85rem;
            color: var(--accent-warning, #ffc107);
            padding: 0.25rem 0;
            padding-left: 1.5rem;
            position: relative;
        }
        
        .audit-diff-item::before {
            content: '‚Üí';
            position: absolute;
            left: 0;
        }
        
        .audit-empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary, #a0a0a0);
        }
        
        /* Replace Device Modal */
        .replace-modal {
            max-width: 550px;
        }
        
        .replace-content {
            margin-bottom: 1.5rem;
        }
        
        .replace-section {
            margin-bottom: 1.25rem;
        }
        
        .replace-label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-primary, #e0e0e0);
        }
        
        .replace-select {
            width: 100%;
            padding: 0.6rem 0.8rem;
            border: 1px solid var(--border-color, #2a3a5a);
            border-radius: 6px;
            background: var(--bg-secondary, #16213e);
            color: var(--text-primary, #e0e0e0);
            font-size: 0.95rem;
        }
        
        .replace-select:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .replace-scan-row {
            display: flex;
            gap: 0.5rem;
        }
        
        .replace-scan-row .replace-select {
            flex: 1;
        }
        
        .replace-device-info {
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: var(--bg-secondary, #16213e);
            border-radius: 6px;
            font-size: 0.85rem;
        }
        
        .replace-device-info .info-row {
            display: flex;
            justify-content: space-between;
            padding: 0.2rem 0;
        }
        
        .replace-device-info .info-label {
            color: var(--text-secondary, #a0a0a0);
        }
        
        .replace-device-info .info-value {
            color: var(--text-primary, #e0e0e0);
            font-family: 'Monaco', 'Menlo', monospace;
        }
        
        .replace-warning {
            padding: 0.75rem;
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid var(--accent-warning, #ffc107);
            border-radius: 6px;
            color: var(--accent-warning, #ffc107);
            margin-bottom: 1rem;
        }
        
        .replace-snapshot-info {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color, #2a3a5a);
        }
        
        .replace-snapshot-content {
            max-height: 150px;
            overflow-y: auto;
            padding: 0.75rem;
            background: var(--bg-secondary, #16213e);
            border-radius: 6px;
            font-size: 0.8rem;
            font-family: 'Monaco', 'Menlo', monospace;
        }
        
        .replace-snapshot-content .config-item {
            padding: 0.2rem 0;
            color: var(--text-secondary, #a0a0a0);
        }
        
        .replace-snapshot-content .config-section {
            color: var(--accent-primary, #4a9eff);
            margin-top: 0.5rem;
            font-weight: 500;
        }
        
        .replace-snapshot-content .config-section:first-child {
            margin-top: 0;
        }
        
        /* Replace Result Modal */
        .replace-result-modal {
            max-width: 500px;
        }
        
        .replace-result-content {
            margin-bottom: 1.5rem;
        }
        
        .replace-result-content .result-success {
            padding: 1rem;
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid var(--accent-success, #4caf50);
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .replace-result-content .result-info {
            padding: 0.75rem;
            background: var(--bg-secondary, #16213e);
            border-radius: 6px;
            margin-bottom: 1rem;
        }
        
        .replace-result-content .result-info p {
            margin: 0.3rem 0;
        }
        
        .replace-result-content .next-steps {
            padding: 1rem;
            background: rgba(74, 158, 255, 0.1);
            border: 1px solid var(--accent-primary, #4a9eff);
            border-radius: 8px;
        }
        
        .replace-result-content .next-steps h4 {
            margin: 0 0 0.5rem 0;
            color: var(--accent-primary, #4a9eff);
        }
        
        .replace-result-content .next-steps ul {
            margin: 0;
            padding-left: 1.25rem;
        }
        
        .replace-result-content .next-steps li {
            margin: 0.3rem 0;
            color: var(--text-secondary, #a0a0a0);
        }
        
        .replace-result-content .result-snapshot {
            padding: 1rem;
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid var(--accent-warning, #ffc107);
            border-radius: 8px;
            margin-top: 1rem;
        }
        
        .replace-result-content .result-snapshot h4 {
            margin: 0 0 0.75rem 0;
            color: var(--accent-warning, #ffc107);
        }
        
        .snapshot-config-display {
            font-size: 0.85rem;
        }
        
        .snapshot-config-display .cfg-section {
            margin: 0.3rem 0;
            color: var(--text-secondary, #a0a0a0);
        }
        
        .snapshot-config-display .cfg-section strong {
            color: var(--text-primary, #e0e0e0);
        }
        
        /* Scripts Tab Styles */
        .scripts-panel {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .scripts-header {
            margin-bottom: 1rem;
        }
        
        .scripts-header h3 {
            margin-bottom: 0.75rem;
        }
        
        .scripts-source-select {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .scripts-source-select label {
            font-size: 0.85rem;
            color: var(--text-secondary, #a0a0a0);
        }
        
        .scripts-source-select select {
            flex: 1;
            padding: 0.4rem 0.6rem;
            background: var(--bg-secondary, #16213e);
            border: 1px solid var(--border-color, #2a3a5a);
            border-radius: 4px;
            color: var(--text-primary, #e0e0e0);
            font-size: 0.85rem;
        }
        
        .btn-small {
            padding: 0.4rem 0.6rem;
            font-size: 0.85rem;
            background: var(--bg-secondary, #16213e);
            border: 1px solid var(--border-color, #2a3a5a);
            border-radius: 4px;
            color: var(--text-primary, #e0e0e0);
            cursor: pointer;
        }
        
        .btn-small:hover {
            border-color: var(--accent-primary, #4a9eff);
        }
        
        .btn-small:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-danger-small {
            background: var(--accent-danger, #e74c3c);
            border-color: var(--accent-danger, #e74c3c);
            color: white;
        }
        
        .btn-danger-small:hover:not(:disabled) {
            background: #c0392b;
            border-color: #c0392b;
        }
        
        .scripts-header-divider {
            color: var(--text-muted, #666);
            margin: 0 0.5rem;
        }
        
        .scripts-list-container {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 1rem;
            background: var(--bg-secondary, #16213e);
            border: 1px solid var(--border-color, #2a3a5a);
            border-radius: 6px;
            min-height: 150px;
            max-height: 250px;
        }
        
        .scripts-list {
            padding: 0.5rem;
        }
        
        .script-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .script-item:hover {
            background: rgba(74, 158, 255, 0.1);
        }
        
        .script-item.selected {
            background: rgba(74, 158, 255, 0.2);
            border: 1px solid var(--accent-primary, #4a9eff);
        }
        
        .script-item input[type="radio"] {
            margin: 0;
        }
        
        .script-item-info {
            flex: 1;
            min-width: 0;
        }
        
        .script-item-name {
            font-weight: 500;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .script-item-desc {
            font-size: 0.75rem;
            color: var(--text-secondary, #a0a0a0);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .scripts-target {
            margin-bottom: 0.75rem;
        }
        
        .scripts-target-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .scripts-target-header h4 {
            font-size: 0.85rem;
            color: var(--text-secondary, #a0a0a0);
            margin: 0;
        }
        
        .scripts-target-controls {
            display: flex;
            gap: 0.25rem;
        }
        
        .btn-tiny {
            padding: 0.2rem 0.5rem;
            font-size: 0.75rem;
            background: var(--bg-secondary, #16213e);
            border: 1px solid var(--border-color, #2a3a5a);
            border-radius: 3px;
            color: var(--text-secondary, #a0a0a0);
            cursor: pointer;
        }
        
        .btn-tiny:hover {
            border-color: var(--accent-primary, #4a9eff);
            color: var(--text-primary, #e0e0e0);
        }
        
        .scripts-device-list {
            max-height: 150px;
            overflow-y: auto;
            background: var(--bg-secondary, #16213e);
            border: 1px solid var(--border-color, #2a3a5a);
            border-radius: 6px;
            padding: 0.5rem;
        }
        
        .scripts-device-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.3rem 0.5rem;
            border-radius: 3px;
            font-size: 0.8rem;
        }
        
        .scripts-device-item:hover {
            background: rgba(74, 158, 255, 0.1);
        }
        
        .scripts-device-item input[type="checkbox"] {
            margin: 0;
        }
        
        .scripts-device-item .device-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .scripts-device-item .device-ip {
            color: var(--text-secondary, #a0a0a0);
            font-size: 0.75rem;
        }
        
        .scripts-selection-info {
            margin-top: 0.25rem;
            font-size: 0.75rem;
            color: var(--text-secondary, #a0a0a0);
        }
        
        .scripts-actions-divider {
            color: var(--border-color, #2a3a5a);
            align-self: center;
        }
        
        .target-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }
        
        .radio-inline, .checkbox-inline {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.85rem;
            cursor: pointer;
        }
        
        .scripts-options {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--bg-secondary, #16213e);
            border-radius: 6px;
            align-items: center;
        }
        
        .script-name-input {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            min-width: 200px;
        }
        
        .script-name-input label {
            white-space: nowrap;
            font-size: 0.9rem;
            color: var(--text-secondary, #a0a0a0);
        }
        
        .script-name-input input {
            flex: 1;
            padding: 0.4rem 0.6rem;
            border: 1px solid var(--border-color, #2a3f5f);
            border-radius: 4px;
            background: var(--bg-primary, #0f0f23);
            color: var(--text-primary, #e0e0e0);
            font-size: 0.9rem;
            min-width: 120px;
        }
        
        .script-name-input input:focus {
            outline: none;
            border-color: var(--accent-color, #4a90d9);
        }
        
        .scripts-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .scripts-actions .btn-primary,
        .scripts-actions .btn-secondary,
        .scripts-actions .btn-danger {
            flex: 1;
            min-width: 100px;
            padding: 0.6rem 0.75rem;
            font-size: 0.85rem;
        }
        
        .scripts-progress {
            margin-bottom: 1rem;
        }
        
        .scripts-results {
            flex: 1;
            overflow-y: auto;
            font-size: 0.85rem;
        }
        
        .script-result-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0;
            border-bottom: 1px solid var(--border-color, #2a3a5a);
        }
        
        .script-result-item:last-child {
            border-bottom: none;
        }
        
        .script-result-item .device-name {
            flex: 1;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
        }
        
        .script-result-item .result-status {
            font-size: 0.9rem;
        }
        
        .script-result-item .result-status.success {
            color: var(--accent-success, #4caf50);
        }
        
        .script-result-item .result-status.error {
            color: var(--accent-danger, #f44336);
        }
        
        .loading-small {
            text-align: center;
            padding: 1rem;
            color: var(--text-secondary, #a0a0a0);
            font-size: 0.85rem;
        }
        
        .no-scripts {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--text-secondary, #a0a0a0);
        }

        /* KVS Panel Styles */
        .kvs-panel {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 1rem;
            gap: 0.75rem;
        }

        .kvs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .kvs-header h3 {
            margin: 0;
            font-size: 1rem;
        }

        .kvs-no-device {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--text-secondary, #a0a0a0);
        }

        .kvs-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            overflow: hidden;
        }

        .kvs-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 2rem;
            color: var(--text-secondary, #a0a0a0);
        }

        .kvs-empty {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--text-secondary, #a0a0a0);
        }

        .kvs-empty .kvs-hint {
            font-size: 0.8rem;
            margin-top: 0.5rem;
            opacity: 0.7;
        }

        .kvs-table-container {
            flex: 1;
            overflow-y: auto;
            border: 1px solid var(--border-color, #2a3a5a);
            border-radius: 4px;
        }

        .kvs-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .kvs-table thead {
            position: sticky;
            top: 0;
            background: var(--bg-secondary, #1a2a4a);
            z-index: 1;
        }

        .kvs-table th {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color, #2a3a5a);
            font-weight: 500;
        }

        .kvs-table th:last-child {
            width: 40px;
            text-align: center;
        }

        .kvs-table td {
            padding: 0.4rem 0.5rem;
            border-bottom: 1px solid var(--border-color, #2a3a5a);
        }

        .kvs-table tr:last-child td {
            border-bottom: none;
        }

        .kvs-table .kvs-key {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
            color: var(--accent-cyan, #00bcd4);
            white-space: nowrap;
        }

        .kvs-table .kvs-value-input {
            width: 100%;
            padding: 0.3rem 0.5rem;
            background: var(--bg-primary, #0d1b2a);
            border: 1px solid var(--border-color, #2a3a5a);
            border-radius: 3px;
            color: var(--text-primary, #e0e0e0);
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
        }

        .kvs-table .kvs-value-input:focus {
            outline: none;
            border-color: var(--accent-primary, #4a9eff);
        }

        .kvs-table .kvs-value-input.changed {
            border-color: var(--accent-warning, #ff9800);
            background: rgba(255, 152, 0, 0.1);
        }

        .kvs-table .kvs-delete-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary, #a0a0a0);
            cursor: pointer;
            padding: 0.3rem;
            font-size: 1rem;
            opacity: 0.6;
            transition: opacity 0.2s, color 0.2s;
        }

        .kvs-table .kvs-delete-btn:hover {
            opacity: 1;
            color: var(--accent-danger, #f44336);
        }

        .kvs-table tr.kvs-row-deleted {
            opacity: 0.4;
            text-decoration: line-through;
        }

        .kvs-table tr.kvs-row-deleted .kvs-value-input {
            pointer-events: none;
        }

        .kvs-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border-color, #2a3a5a);
        }

        .kvs-changes-hint {
            font-size: 0.8rem;
            color: var(--accent-warning, #ff9800);
        }

        .kvs-info {
            font-size: 0.75rem;
            color: var(--text-secondary, #a0a0a0);
            padding-top: 0.5rem;
            border-top: 1px solid var(--border-color, #2a3a5a);
        }

        .kvs-info p {
            margin: 0;
        }

        /* Webhooks Panel Styles */
        .webhooks-panel {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 1rem;
            gap: 0.75rem;
        }

        .webhooks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .webhooks-header h3 {
            margin: 0;
            font-size: 1rem;
        }

        .webhooks-no-device {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--text-secondary, #a0a0a0);
        }

        .webhooks-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            overflow: hidden;
        }

        .webhooks-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 2rem;
            color: var(--text-secondary, #a0a0a0);
        }

        .webhooks-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .webhooks-empty {
            text-align: center;
            padding: 1rem;
            color: var(--text-secondary, #a0a0a0);
        }

        .webhook-item {
            background: var(--bg-secondary, #1a2a4a);
            border: 1px solid var(--border-color, #2a3a5a);
            border-radius: 4px;
            padding: 0.5rem;
        }

        .webhook-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.3rem;
        }

        .webhook-item-event {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
            color: var(--accent-cyan, #00bcd4);
        }

        .webhook-item-status {
            font-size: 0.75rem;
        }

        .webhook-item-status.enabled {
            color: var(--accent-success, #4caf50);
        }

        .webhook-item-status.disabled {
            color: var(--text-secondary, #a0a0a0);
        }

        .webhook-item-url {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.7rem;
            color: var(--text-secondary, #a0a0a0);
            word-break: break-all;
            flex: 1;
        }

        .webhook-item-url-row {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            margin-bottom: 0.3rem;
        }

        .webhook-item-url-edit {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            margin-bottom: 0.3rem;
        }

        .webhook-url-input {
            flex: 1;
            padding: 0.3rem;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.7rem;
            background: var(--bg-primary, #0d1b2a);
            border: 1px solid var(--accent-primary, #4a9eff);
            border-radius: 3px;
            color: var(--text-primary, #e0e0e0);
        }

        .webhook-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .webhook-item-actions button {
            padding: 0.2rem 0.5rem;
            font-size: 0.75rem;
        }

        .webhooks-create {
            border-top: 1px solid var(--border-color, #2a3a5a);
            padding-top: 0.75rem;
        }

        .webhooks-create h4 {
            margin: 0 0 0.5rem 0;
            font-size: 0.9rem;
        }

        .webhook-form {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .webhook-form .form-row {
            display: flex;
            gap: 0.5rem;
        }

        .webhook-form .form-row .form-group {
            flex: 1;
        }

        .webhook-form .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }

        .webhook-form .form-group label {
            font-size: 0.75rem;
            color: var(--text-secondary, #a0a0a0);
        }

        .webhook-form .form-group input,
        .webhook-form .form-group select {
            padding: 0.4rem;
            background: var(--bg-primary, #0d1b2a);
            border: 1px solid var(--border-color, #2a3a5a);
            border-radius: 3px;
            color: var(--text-primary, #e0e0e0);
            font-size: 0.8rem;
        }

        .webhook-form .checkbox-inline {
            flex-direction: row;
            align-items: center;
            gap: 0.3rem;
        }

        .webhooks-info {
            font-size: 0.75rem;
            color: var(--text-secondary, #a0a0a0);
            padding-top: 0.5rem;
            border-top: 1px solid var(--border-color, #2a3a5a);
        }

        .webhooks-info p {
            margin: 0;
        }

        /* URL Builder Styles */
        .url-builder {
            border: 1px solid var(--border-color, #2a3a5a);
            border-radius: 4px;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.2);
        }

        .url-builder-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .url-builder-header label {
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-secondary, #a0a0a0);
            cursor: pointer;
        }

        .btn-tiny {
            background: transparent;
            border: none;
            color: var(--text-secondary, #a0a0a0);
            cursor: pointer;
            padding: 0.2rem;
            font-size: 0.7rem;
        }

        .url-builder-content {
            margin-top: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .url-builder-content.collapsed {
            display: none;
        }

        .url-builder .form-row {
            display: flex;
            gap: 0.4rem;
        }

        .url-builder .form-group {
            flex: 1;
        }

        .url-builder .form-group label {
            font-size: 0.7rem;
        }

        .url-builder .form-group input,
        .url-builder .form-group select {
            padding: 0.3rem;
            font-size: 0.75rem;
        }

        /* Firmware Panel Styles */
        .firmware-panel {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 1rem;
            gap: 0.75rem;
        }

        .firmware-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .firmware-header h3 {
            margin: 0;
            font-size: 1rem;
        }

        .firmware-scope {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
        }

        .firmware-scope label {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            cursor: pointer;
        }

        .firmware-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 2rem;
            color: var(--text-secondary, #a0a0a0);
        }

        .firmware-empty {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--text-secondary, #a0a0a0);
        }

        .firmware-table-container {
            flex: 1;
            overflow-y: auto;
            border: 1px solid var(--border-color, #2a3a5a);
            border-radius: 4px;
        }

        .firmware-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }

        .firmware-table thead {
            position: sticky;
            top: 0;
            background: var(--bg-secondary, #1a2a4a);
            z-index: 1;
        }

        .firmware-table th {
            padding: 0.5rem 0.4rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color, #2a3a5a);
            font-weight: 500;
        }

        .firmware-table th:first-child {
            width: 30px;
            text-align: center;
        }

        .firmware-table td {
            padding: 0.4rem;
            border-bottom: 1px solid var(--border-color, #2a3a5a);
        }

        .firmware-table tr:last-child td {
            border-bottom: none;
        }

        .firmware-table .fw-device {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.75rem;
        }

        .firmware-table .fw-version {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.75rem;
        }

        .firmware-table .fw-status {
            font-size: 0.85rem;
        }

        .firmware-table .fw-status.uptodate {
            color: var(--accent-success, #4caf50);
        }

        .firmware-table .fw-status.outdated {
            color: var(--accent-warning, #ff9800);
        }

        .firmware-table .fw-status.error {
            color: var(--accent-danger, #f44336);
        }

        .firmware-table .fw-status.updating {
            color: var(--accent-primary, #4a9eff);
        }

        .firmware-table tr.selected {
            background: rgba(74, 158, 255, 0.1);
        }

        .firmware-actions {
            display: flex;
            gap: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border-color, #2a3a5a);
        }

        .firmware-progress {
            padding: 0.5rem 0;
        }

        .firmware-info {
            font-size: 0.75rem;
            color: var(--text-secondary, #a0a0a0);
            padding-top: 0.5rem;
            border-top: 1px solid var(--border-color, #2a3a5a);
        }

        .firmware-info p {
            margin: 0;
        }

        /* Danger Zone Styles */
        .danger-zone {
            margin-top: 2rem;
            padding: 1rem;
            border: 1px solid var(--border-color, #2a3a5a);
            border-radius: 8px;
            background: var(--surface-color, #1a2a4a);
        }

        .danger-zone h4 {
            display: none;
        }

        .danger-zone-content {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .danger-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .danger-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .danger-title {
            font-weight: 600;
            color: var(--text-primary, #e0e0e0);
            font-size: 0.85rem;
        }

        .danger-description {
            font-size: 0.75rem;
            color: var(--text-secondary, #a0a0a0);
        }

        .btn-danger-small {
            padding: 0.4rem 0.8rem;
            background: var(--primary-color, #3b82f6);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .btn-danger-small:hover {
            background: #2563eb;
        }
    </style>

    <script src="{{ url_for('static', filename='js/i18n.js') }}?v=1"></script>
    <script src="{{ url_for('static', filename='js/api.js') }}?v=5"></script>
    <script src="{{ url_for('static', filename='js/ui.js') }}?v=5"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}?v=5"></script>
    
    <script>
        // Stage 1 functionality
        let stage1Running = false;
        let stage1HeartbeatInterval = null;
        let stage1StatusInterval = null;
        
        // Stage 1 button click
        document.getElementById('btn-stage1').addEventListener('click', startStage1);
        
        // Stop button
        document.getElementById('stage1-stop-btn').addEventListener('click', stopStage1);
        
        async function startStage1() {
            try {
                const response = await fetch('/api/stage1/start', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    stage1Running = true;
                    showStage1Modal();
                    startStage1Heartbeat();
                    startStage1StatusPolling();
                    addStage1Log(i18n.t('stage1.started'), 'success');
                } else {
                    alert(i18n.t('common.error') + ': ' + data.error);
                }
            } catch (error) {
                alert(i18n.t('stage1.connection_error') + ': ' + error);
            }
        }
        
        async function stopStage1() {
            try {
                addStage1Log(i18n.t('stage1.stopping'), 'warning');
                const response = await fetch('/api/stage1/stop', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    stage1Running = false;
                    stopStage1Heartbeat();
                    stopStage1StatusPolling();
                    addStage1Log(i18n.t('stage1.stopped'), 'success');
                    
                    // Close modal after short delay
                    setTimeout(() => {
                        hideStage1Modal();
                    }, 1500);
                } else {
                    addStage1Log(i18n.t('stage1.error_stopping') + ': ' + data.error, 'error');
                }
            } catch (error) {
                addStage1Log(i18n.t('stage1.connection_error') + ': ' + error, 'error');
            }
        }
        
        function showStage1Modal() {
            document.getElementById('modal-stage1').classList.add('active');
            document.getElementById('stage1-status-text').textContent = i18n.t('stage1.initializing');
            document.getElementById('stage1-device-list').innerHTML = `<div class="empty-state">${i18n.t('stage1.no_devices_yet')}</div>`;
            document.getElementById('stage1-device-count').textContent = '0';
            document.getElementById('stage1-log').innerHTML = '';
        }
        
        function hideStage1Modal() {
            document.getElementById('modal-stage1').classList.remove('active');
        }
        
        function startStage1Heartbeat() {
            stage1HeartbeatInterval = setInterval(async () => {
                try {
                    await fetch('/api/stage1/heartbeat', { method: 'POST' });
                } catch (error) {
                    console.error('Heartbeat failed:', error);
                }
            }, 5000);
        }
        
        function stopStage1Heartbeat() {
            if (stage1HeartbeatInterval) {
                clearInterval(stage1HeartbeatInterval);
                stage1HeartbeatInterval = null;
            }
        }
        
        function startStage1StatusPolling() {
            stage1StatusInterval = setInterval(updateStage1Status, 1000);
        }
        
        function stopStage1StatusPolling() {
            if (stage1StatusInterval) {
                clearInterval(stage1StatusInterval);
                stage1StatusInterval = null;
            }
        }
        
        async function updateStage1Status() {
            try {
                const response = await fetch('/api/stage1/status');
                const data = await response.json();
                
                if (data.success && data.status) {
                    const status = data.status;
                    const indicator = document.getElementById('stage1-status-indicator');
                    const statusText = document.getElementById('stage1-status-text');
                    
                    // Update status text
                    if (status.state === 'scanning') {
                        statusText.textContent = i18n.t('stage1.searching_aps');
                        indicator.className = 'status-indicator-large';
                    } else if (status.state === 'waiting') {
                        statusText.textContent = status.message || i18n.t('stage1.waiting_for_ap');
                        indicator.className = 'status-indicator-large waiting';
                    } else if (status.state === 'device_done') {
                        const lastDevice = status.last_device;
                        statusText.textContent = `‚úì ${lastDevice?.model || 'Device'} ${i18n.t('stage1.configured')}`;
                        indicator.className = 'status-indicator-large success';
                        
                        // Reset after short delay
                        setTimeout(() => {
                            if (stage1Running) {
                                indicator.className = 'status-indicator-large';
                            }
                        }, 2000);
                    }
                    
                    // Update device list and counter
                    if (status.devices_processed && status.devices_processed.length > 0) {
                        const deviceCount = status.devices_processed.length;
                        document.getElementById('stage1-device-count').textContent = deviceCount;
                        
                        const deviceList = document.getElementById('stage1-device-list');
                        const existingMacs = new Set(
                            Array.from(deviceList.querySelectorAll('.device-mini-item .mac'))
                                .map(el => el.textContent)
                        );
                        
                        // Clear empty state if present
                        const emptyState = deviceList.querySelector('.empty-state');
                        if (emptyState) emptyState.remove();
                        
                        // Only add new devices
                        status.devices_processed.forEach(d => {
                            if (!existingMacs.has(d.mac)) {
                                const item = document.createElement('div');
                                item.className = 'device-mini-item';
                                item.innerHTML = `
                                    <span class="mac">${d.mac || '?'}</span>
                                    <span class="model">${d.model || '?'}</span>
                                    <span class="status-icon">‚úì</span>
                                `;
                                deviceList.appendChild(item);
                            }
                        });
                    }
                    
                    // Check if stopped
                    if (!status.running && !status.thread_alive) {
                        stage1Running = false;
                        stopStage1Heartbeat();
                        stopStage1StatusPolling();
                        
                        if (status.reason === 'heartbeat_timeout') {
                            addStage1Log(i18n.t('stage1.timeout_stopped'), 'warning');
                        }
                    }
                }
            } catch (error) {
                console.error('Status polling failed:', error);
            }
        }
        
        function addStage1Log(message, type = '') {
            const log = document.getElementById('stage1-log');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }
        
        // Close modal when clicking outside (but not while running)
        document.getElementById('modal-stage1').addEventListener('click', (e) => {
            if (e.target === e.currentTarget && !stage1Running) {
                hideStage1Modal();
            }
        });
    </script>
    
    <script>
        // =====================================================================
        // Settings Modal Functionality
        // =====================================================================
        
        // Make settingsState global so it can be accessed from other script blocks
        window.settingsState = {
            isAuthenticated: false,
            pendingAction: null,
            hasChanges: false,
            currentTab: 'provisioning',
            settings: {},
            modelMap: [],
            buildingProfile: {},
            advancedFile: '',
            advancedContent: '',
            advancedOriginal: ''
        };
        const settingsState = window.settingsState;
        
        // Available columns for export
        const AVAILABLE_COLUMNS = [
            'id', 'ip', 'hostname', 'fw', 'model', 'hw_model', 
            'friendly_name', 'room', 'location', 'assigned_at', 
            'last_seen', 'stage3_friendly_status', 'stage3_ota_status', 'stage4_status_result'
        ];
        
        // DOM Elements
        const settingsBtn = document.getElementById('btn-settings');
        const pinModal = document.getElementById('modal-pin');
        const adminSettingsModal = document.getElementById('modal-settings');
        const pinInput = document.getElementById('admin-pin-input');
        const pinError = document.getElementById('pin-error');
        const yamlEditor = document.getElementById('yaml-editor');
        const yamlStatusText = document.getElementById('yaml-status-text');
        const yamlValidIndicator = document.getElementById('yaml-valid-indicator');
        
        // Event Listeners
        settingsBtn.addEventListener('click', openSettings);
        document.getElementById('pin-cancel-btn').addEventListener('click', closePinModal);
        document.getElementById('pin-submit-btn').addEventListener('click', submitPin);
        pinInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') submitPin();
        });
        
        document.getElementById('admin-settings-cancel-btn').addEventListener('click', closeSettings);
        document.getElementById('admin-settings-save-btn').addEventListener('click', saveSettings);
        document.getElementById('yaml-validate-btn').addEventListener('click', validateAdvancedYaml);
        document.getElementById('modelmap-add-btn').addEventListener('click', addModelMapRow);
        
        // Tab switching
        document.querySelectorAll('.settings-tab-btn').forEach(btn => {
            btn.addEventListener('click', () => switchSettingsTab(btn.dataset.tab));
        });
        
        // Advanced file selector
        document.getElementById('advanced-file-select').addEventListener('change', (e) => {
            loadAdvancedFile(e.target.value);
        });
        
        // Track changes in YAML editor
        yamlEditor.addEventListener('input', () => {
            settingsState.advancedContent = yamlEditor.value;
            settingsState.hasChanges = true;
            
            // Live validation (debounced)
            clearTimeout(settingsState.validateTimeout);
            settingsState.validateTimeout = setTimeout(() => {
                validateAdvancedYamlSilent();
            }, 500);
        });
        
        // Handle Tab key in textarea
        yamlEditor.addEventListener('keydown', (e) => {
            if (e.key === 'Tab') {
                e.preventDefault();
                const start = yamlEditor.selectionStart;
                const end = yamlEditor.selectionEnd;
                yamlEditor.value = yamlEditor.value.substring(0, start) + '  ' + yamlEditor.value.substring(end);
                yamlEditor.selectionStart = yamlEditor.selectionEnd = start + 2;
                yamlEditor.dispatchEvent(new Event('input'));
            }
        });
        
        // Track changes in building profile fields
        ['building-object-name', 'building-customer-name', 'building-address', 
         'building-contact-phone', 'building-contact-email', 'building-notes'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', () => {
                    settingsState.hasChanges = true;
                });
            }
        });
        
        // Close modal on overlay click
        pinModal.addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closePinModal();
        });
        adminSettingsModal.addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeSettings();
        });
        
        // =====================================================================
        // PIN Authentication
        // =====================================================================
        
        async function checkAdminStatus() {
            try {
                const response = await fetch('/api/admin/status');
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Failed to check admin status:', error);
                return { authenticated: false, pin_set: false };
            }
        }
        
        async function openSettings() {
            // Personal Edition: No PIN required - open directly
            if (!App.isPro) {
                showSettingsModal();
                return;
            }
            
            const status = await checkAdminStatus();
            
            if (status.authenticated) {
                settingsState.isAuthenticated = true;
                showSettingsModal();
            } else {
                settingsState.pendingAction = 'settings';
                showPinModal();
            }
        }
        
        function showPinModal() {
            pinModal.classList.add('active');
            pinInput.value = '';
            pinError.style.display = 'none';
            setTimeout(() => pinInput.focus(), 100);
        }
        
        function closePinModal() {
            pinModal.classList.remove('active');
            pinInput.value = '';
            settingsState.pendingAction = null;
        }
        
        async function submitPin() {
            const pin = pinInput.value.trim();
            
            if (!pin) {
                showPinError('Please enter PIN');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/authenticate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pin })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    settingsState.isAuthenticated = true;
                    // Save pending action before closing modal (which clears it)
                    const pendingAction = settingsState.pendingAction;
                    closePinModal();
                    
                    if (pendingAction === 'settings') {
                        showSettingsModal();
                    } else if (pendingAction === 'building-settings') {
                        // Call global function
                        if (typeof window.openBuildingSettings === 'function') {
                            window.openBuildingSettings();
                        }
                    }
                } else {
                    showPinError(data.error || 'Invalid PIN');
                }
            } catch (error) {
                showPinError('Connection error');
            }
        }
        
        function showPinError(message) {
            pinError.textContent = message;
            pinError.style.display = 'block';
            pinInput.select();
        }
        
        // =====================================================================
        // Settings Modal
        // =====================================================================
        
        async function showSettingsModal() {
            // Get active building name from UI
            const buildingName = document.getElementById('building-name').textContent || '-';
            document.getElementById('settings-subtitle').textContent = `Building: ${buildingName}`;
            
            adminSettingsModal.classList.add('active');
            settingsState.hasChanges = false;
            settingsState.currentTab = 'provisioning';
            
            // Load all data
            await Promise.all([
                loadSettings(),
                loadModelMap(),
                loadProfilesList()
            ]);
            
            // Render columns grid
            renderColumnsGrid();
        }
        
        function closeSettings() {
            if (settingsState.hasChanges) {
                if (!confirm(i18n.t('common.unsaved_changes'))) {
                    return;
                }
            }
            adminSettingsModal.classList.remove('active');
            settingsState.hasChanges = false;
        }
        
        function switchSettingsTab(tabName) {
            settingsState.currentTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.settings-tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabName);
            });
            
            // Update tab content
            document.querySelectorAll('.settings-tab-content').forEach(content => {
                content.classList.toggle('active', content.dataset.tab === tabName);
            });
        }
        
        // =====================================================================
        // Load Settings
        // =====================================================================
        
        async function loadSettings() {
            try {
                const response = await fetch('/api/admin/settings');
                const data = await response.json();
                
                if (data.success) {
                    settingsState.settings = data.settings;
                    populateSettingsForm(data.settings);
                }
                
                // Also load building profile
                await loadBuildingProfile();
            } catch (error) {
                console.error('Failed to load settings:', error);
            }
        }
        
        async function loadBuildingProfile() {
            try {
                const response = await fetch('/api/settings/building-profile');
                const data = await response.json();
                
                if (data.success) {
                    settingsState.buildingProfile = data.profile;
                    populateBuildingProfileForm(data.profile);
                }
            } catch (error) {
                console.error('Failed to load building profile:', error);
            }
        }
        
        function populateBuildingProfileForm(profile) {
            document.getElementById('building-object-name').value = profile.object_name || '';
            document.getElementById('building-customer-name').value = profile.customer_name || '';
            document.getElementById('building-address').value = profile.address || '';
            document.getElementById('building-contact-phone').value = profile.contact_phone || '';
            document.getElementById('building-contact-email').value = profile.contact_email || '';
            document.getElementById('building-notes').value = profile.notes || '';
        }
        
        function populateSettingsForm(settings) {
            // Stage 1
            document.getElementById('setting-loop-mode').checked = settings.stage1?.loop_mode ?? true;
            document.getElementById('setting-disable-ap').checked = settings.stage1?.disable_ap ?? true;
            document.getElementById('setting-disable-bt').checked = settings.stage1?.disable_bluetooth ?? true;
            document.getElementById('setting-disable-cloud').checked = settings.stage1?.disable_cloud ?? true;
            document.getElementById('setting-disable-mqtt').checked = settings.stage1?.mqtt_disable ?? true;
            
            // Stage 3
            document.getElementById('setting-ota-enabled').checked = settings.stage3?.ota_enabled ?? true;
            document.getElementById('setting-ota-mode').value = settings.stage3?.ota_mode || 'check_and_update';
            document.getElementById('setting-ota-timeout').value = settings.stage3?.ota_timeout || 20;
            
            // Report
            document.getElementById('setting-csv-delimiter').value = settings.report?.csv_delimiter || ';';
            settingsState.selectedColumns = settings.report?.default_columns || [];
        }
        
        function renderColumnsGrid() {
            const grid = document.getElementById('settings-columns-grid');
            const selected = settingsState.selectedColumns || [];
            
            grid.innerHTML = AVAILABLE_COLUMNS.map(col => `
                <label>
                    <input type="checkbox" value="${col}" ${selected.includes(col) ? 'checked' : ''}>
                    ${col}
                </label>
            `).join('');
            
            // Add change listeners
            grid.querySelectorAll('input').forEach(cb => {
                cb.addEventListener('change', () => {
                    settingsState.hasChanges = true;
                });
            });
        }
        
        function getSelectedColumns() {
            const grid = document.getElementById('settings-columns-grid');
            return Array.from(grid.querySelectorAll('input:checked')).map(cb => cb.value);
        }
        
        // =====================================================================
        // Model Map
        // =====================================================================
        
        async function loadModelMap() {
            try {
                const response = await fetch('/api/admin/model-map');
                const data = await response.json();
                
                if (data.success) {
                    settingsState.modelMap = data.entries || [];
                    renderModelMapTable();
                }
            } catch (error) {
                console.error('Failed to load model map:', error);
            }
        }
        
        function renderModelMapTable() {
            const tbody = document.getElementById('modelmap-tbody');
            
            if (settingsState.modelMap.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:var(--text-secondary)">No entries</td></tr>';
                return;
            }
            
            tbody.innerHTML = settingsState.modelMap.map((entry, idx) => `
                <tr data-idx="${idx}">
                    <td><input type="text" value="${escapeHtml(entry.hw_id)}" data-field="hw_id" placeholder="e.g. S3SW-001X16EU"></td>
                    <td><input type="text" value="${escapeHtml(entry.display_name)}" data-field="display_name" placeholder="e.g. S1G3"></td>
                    <td><button class="delete-btn" onclick="deleteModelMapRow(${idx})">üóëÔ∏è</button></td>
                </tr>
            `).join('');
            
            // Add change listeners
            tbody.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const idx = parseInt(e.target.closest('tr').dataset.idx);
                    const field = e.target.dataset.field;
                    settingsState.modelMap[idx][field] = e.target.value;
                    settingsState.hasChanges = true;
                });
            });
        }
        
        function addModelMapRow() {
            settingsState.modelMap.push({ hw_id: '', display_name: '' });
            settingsState.hasChanges = true;
            renderModelMapTable();
            
            // Focus the new row
            const tbody = document.getElementById('modelmap-tbody');
            const lastRow = tbody.querySelector('tr:last-child input');
            if (lastRow) lastRow.focus();
        }
        
        function deleteModelMapRow(idx) {
            settingsState.modelMap.splice(idx, 1);
            settingsState.hasChanges = true;
            renderModelMapTable();
        }
        
        // =====================================================================
        // Advanced Tab (Profiles)
        // =====================================================================
        
        async function loadProfilesList() {
            try {
                const response = await fetch('/api/admin/profiles');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('advanced-file-select');
                    select.innerHTML = '<option value="">-- Select file --</option>';
                    
                    data.files.forEach(file => {
                        const option = document.createElement('option');
                        option.value = file.path;
                        option.textContent = file.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to load profiles:', error);
            }
        }
        
        async function loadAdvancedFile(filepath) {
            if (!filepath) {
                yamlEditor.value = '';
                yamlStatusText.textContent = '-';
                yamlValidIndicator.className = 'yaml-valid-indicator';
                settingsState.advancedFile = '';
                return;
            }
            
            yamlStatusText.textContent = 'Loading...';
            
            try {
                const response = await fetch(`/api/admin/profiles/${encodeURIComponent(filepath)}`);
                const data = await response.json();
                
                if (data.success) {
                    yamlEditor.value = data.content || '';
                    settingsState.advancedFile = filepath;
                    settingsState.advancedContent = data.content || '';
                    settingsState.advancedOriginal = data.content || '';
                    
                    if (data.valid) {
                        yamlStatusText.textContent = 'Valid YAML';
                        yamlValidIndicator.className = 'yaml-valid-indicator valid';
                    } else {
                        yamlStatusText.textContent = 'Syntax error';
                        yamlValidIndicator.className = 'yaml-valid-indicator invalid';
                    }
                } else {
                    yamlStatusText.textContent = 'Error: ' + (data.error || 'Unknown');
                    yamlValidIndicator.className = 'yaml-valid-indicator invalid';
                }
            } catch (error) {
                yamlStatusText.textContent = 'Connection error';
                yamlValidIndicator.className = 'yaml-valid-indicator invalid';
            }
        }
        
        async function validateAdvancedYaml() {
            const content = yamlEditor.value;
            if (!settingsState.advancedFile) return;
            
            yamlStatusText.textContent = 'Validating...';
            
            try {
                const response = await fetch(`/api/admin/profiles/${encodeURIComponent(settingsState.advancedFile)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content, validate_only: true })
                });
                const data = await response.json();
                
                // For validation, we just check if the YAML is parseable
                // Since we're using PUT for saving, we'll do a simple client-side check
                try {
                    // Basic YAML validation - if it has valid structure
                    if (content.trim() && !content.includes('\t')) {
                        yamlStatusText.textContent = 'Valid YAML';
                        yamlValidIndicator.className = 'yaml-valid-indicator valid';
                    }
                } catch (e) {
                    yamlStatusText.textContent = 'Syntax error';
                    yamlValidIndicator.className = 'yaml-valid-indicator invalid';
                }
            } catch (error) {
                yamlStatusText.textContent = 'Validation failed';
            }
        }
        
        function validateAdvancedYamlSilent() {
            const content = yamlEditor.value;
            if (!content.trim()) {
                yamlValidIndicator.className = 'yaml-valid-indicator';
                yamlStatusText.textContent = '-';
                return;
            }
            
            // Basic validation - check for tabs (common YAML error)
            if (content.includes('\t')) {
                yamlValidIndicator.className = 'yaml-valid-indicator warning';
                yamlStatusText.textContent = 'Warning: tabs detected';
            } else {
                yamlValidIndicator.className = 'yaml-valid-indicator valid';
                yamlStatusText.textContent = 'Valid YAML';
            }
        }
        
        // =====================================================================
        // Save All Settings
        // =====================================================================
        
        async function saveSettings() {
            const saveBtn = document.getElementById('admin-settings-save-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            
            try {
                // Gather settings from form
                const settings = {
                    stage1: {
                        loop_mode: document.getElementById('setting-loop-mode').checked,
                        disable_ap: document.getElementById('setting-disable-ap').checked,
                        disable_bluetooth: document.getElementById('setting-disable-bt').checked,
                        disable_cloud: document.getElementById('setting-disable-cloud').checked,
                        mqtt_disable: document.getElementById('setting-disable-mqtt').checked,
                    },
                    stage3: {
                        ota_enabled: document.getElementById('setting-ota-enabled').checked,
                        ota_mode: document.getElementById('setting-ota-mode').value,
                        ota_timeout: parseInt(document.getElementById('setting-ota-timeout').value) || 20,
                    },
                    report: {
                        csv_delimiter: document.getElementById('setting-csv-delimiter').value,
                        default_columns: getSelectedColumns(),
                    }
                };
                
                // Save main settings
                const settingsResp = await fetch('/api/admin/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ settings })
                });
                
                if (!settingsResp.ok) {
                    const text = await settingsResp.text();
                    throw new Error(`Settings save failed: ${settingsResp.status}`);
                }
                
                const settingsData = await settingsResp.json();
                
                if (!settingsData.success) {
                    throw new Error(settingsData.error || 'Failed to save settings');
                }
                
                // Save model map
                const validEntries = settingsState.modelMap.filter(e => e.hw_id && e.display_name);
                const mapResp = await fetch('/api/admin/model-map', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ entries: validEntries })
                });
                
                if (!mapResp.ok) {
                    const text = await mapResp.text();
                    throw new Error(`Model map save failed: ${mapResp.status}`);
                }
                
                const mapData = await mapResp.json();
                
                if (!mapData.success) {
                    throw new Error(mapData.error || 'Failed to save model map');
                }
                
                // Save advanced file if modified
                if (settingsState.advancedFile && settingsState.advancedContent !== settingsState.advancedOriginal) {
                    const advResp = await fetch(`/api/admin/profiles/${encodeURIComponent(settingsState.advancedFile)}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content: settingsState.advancedContent })
                    });
                    
                    if (!advResp.ok) {
                        const text = await advResp.text();
                        throw new Error(`Profile save failed: ${advResp.status}`);
                    }
                    
                    const advData = await advResp.json();
                    
                    if (!advData.success) {
                        throw new Error(advData.error || 'Failed to save profile');
                    }
                    settingsState.advancedOriginal = settingsState.advancedContent;
                }
                
                // Save building profile
                const buildingProfile = {
                    object_name: document.getElementById('building-object-name').value,
                    customer_name: document.getElementById('building-customer-name').value,
                    address: document.getElementById('building-address').value,
                    contact_phone: document.getElementById('building-contact-phone').value,
                    contact_email: document.getElementById('building-contact-email').value,
                    notes: document.getElementById('building-notes').value
                };
                
                const profileResp = await fetch('/api/settings/building-profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(buildingProfile)
                });
                
                if (!profileResp.ok) {
                    const text = await profileResp.text();
                    throw new Error(`Building profile save failed: ${profileResp.status} - ${text}`);
                }
                
                const profileData = await profileResp.json();
                
                if (!profileData.success) {
                    throw new Error(profileData.error || 'Failed to save building profile');
                }
                
                settingsState.hasChanges = false;
                
                // Show success
                if (typeof UI !== 'undefined' && UI.showToast) {
                    UI.showToast('Settings saved', 'success');
                }
                
                closeSettings();
                
            } catch (error) {
                console.error('Save error:', error);
                alert(i18n.t('common.error_saving') + ': ' + error.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'üíæ Save';
            }
        }
        
        // Track form changes
        document.querySelectorAll('#modal-settings input, #modal-settings select').forEach(el => {
            el.addEventListener('change', () => {
                settingsState.hasChanges = true;
            });
        });
    </script>
    
    <script>
        // =====================================================================
        // Building Settings Functionality
        // =====================================================================
        
        const settingsModal = document.getElementById('modal-building-settings');
        const settingsBuildingName = document.getElementById('settings-building-name');
        
        // Event Listeners
        document.getElementById('btn-building-settings').addEventListener('click', openBuildingSettings);
        document.getElementById('settings-cancel-btn').addEventListener('click', closeBuildingSettings);
        document.getElementById('settings-save-btn').addEventListener('click', saveBuildingSettings);
        
        // Export Labels CSV
        document.getElementById('btn-export-labels').addEventListener('click', openExportModal);
        
        function openExportModal() {
            const filteredDevices = UI.filteredDevices || [];
            
            if (filteredDevices.length === 0) {
                UI.showToast('No devices to export', 'warning');
                return;
            }
            
            // Update count in modal
            document.getElementById('export-device-count').textContent = filteredDevices.length;
            document.getElementById('modal-export-labels').classList.add('active');
        }
        
        function closeExportModal() {
            document.getElementById('modal-export-labels').classList.remove('active');
        }
        
        document.getElementById('export-cancel-btn').addEventListener('click', closeExportModal);
        document.getElementById('export-download-btn').addEventListener('click', exportLabelsCSV);
        
        document.getElementById('modal-export-labels').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeExportModal();
        });
        
        async function exportLabelsCSV() {
            try {
                const filteredDevices = UI.filteredDevices || [];
                const macs = filteredDevices.map(d => d.id);
                
                const btn = document.getElementById('export-download-btn');
                btn.disabled = true;
                btn.textContent = 'Exportiere...';
                
                // POST the MAC list, receive CSV
                const response = await fetch('/api/devices/export/labels', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ macs })
                });
                
                if (!response.ok) {
                    throw new Error('Export failed');
                }
                
                // Get filename from header
                const contentDisp = response.headers.get('Content-Disposition') || '';
                const filenameMatch = contentDisp.match(/filename=([^;]+)/);
                const filename = filenameMatch ? filenameMatch[1] : 'labels.csv';
                
                // Trigger download
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                // Show success in modal
                const resultDiv = document.getElementById('export-result');
                resultDiv.innerHTML = `
                    <div class="export-success">
                        <p>‚úÖ Export erfolgreich!</p>
                        <p><strong>${macs.length} Labels</strong> exportiert</p>
                        <p class="export-filename">üìÅ ${filename}</p>
                        <p class="export-hint">File was saved to your download folder.</p>
                    </div>
                `;
                resultDiv.style.display = 'block';
                
                btn.textContent = '‚úì Fertig';
                
                // Change button to "Close" after success
                setTimeout(() => {
                    btn.textContent = 'Close';
                    btn.disabled = false;
                    btn.onclick = closeExportModal;
                }, 1000);
                
            } catch (error) {
                UI.showToast('Export failed: ' + error.message, 'error');
                document.getElementById('export-download-btn').disabled = false;
                document.getElementById('export-download-btn').textContent = 'Download';
            }
        }
        
        // ===========================================================================
        // Snapshot Management
        // ===========================================================================
        
        let hasRecentSnapshot = true; // Track if there's a recent snapshot
        
        document.getElementById('btn-create-snapshot').addEventListener('click', createSnapshot);
        document.getElementById('btn-view-snapshots').addEventListener('click', openSnapshotsModal);
        document.getElementById('snapshots-close-btn').addEventListener('click', closeSnapshotsModal);
        document.getElementById('snapshots-create-btn').addEventListener('click', createSnapshotFromModal);
        
        document.getElementById('modal-snapshots').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeSnapshotsModal();
        });
        
        document.getElementById('modal-snapshot-reminder').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeReminderModal();
        });
        
        // Check snapshot status on page load (Pro only)
        async function checkSnapshotStatus() {
            // Skip for Personal edition - snapshots are Pro-only
            if (!App.isPro) {
                return;
            }
            
            try {
                const response = await fetch('/api/building/snapshots');
                const data = await response.json();
                
                if (data.success) {
                    hasRecentSnapshot = data.has_recent;
                    const hasAnySnapshot = data.snapshots && data.snapshots.length > 0;
                    updateSnapshotBadge(hasAnySnapshot);
                }
            } catch (error) {
                console.error('Error checking snapshot status:', error);
            }
        }
        
        function updateSnapshotBadge(hasAnySnapshot = false) {
            const badge = document.getElementById('snapshot-badge');
            if (badge) {
                badge.style.display = hasRecentSnapshot ? 'none' : 'inline-flex';
                badge.title = hasAnySnapshot 
                    ? i18n.t('snapshots.badge_old_snapshot') 
                    : i18n.t('snapshots.badge_no_snapshot');
            }
        }
        
        function showSnapshotProgress() {
            document.getElementById('modal-snapshot-progress').classList.add('active');
        }
        
        function hideSnapshotProgress() {
            document.getElementById('modal-snapshot-progress').classList.remove('active');
        }
        
        async function createSnapshot() {
            const btn = document.getElementById('btn-create-snapshot');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span>‚è≥ Creating...</span>';
            
            // Show progress modal
            showSnapshotProgress();
            
            try {
                const response = await fetch('/api/building/snapshot', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    UI.showToast(`Snapshot created: ${data.device_count} devices`, 'success');
                    hasRecentSnapshot = true;
                    updateSnapshotBadge(true);
                } else {
                    UI.showToast('Snapshot failed: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                UI.showToast('Snapshot failed: ' + error.message, 'error');
            } finally {
                hideSnapshotProgress();
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        
        async function createSnapshotFromModal() {
            await createSnapshot();
            await loadSnapshots();
        }
        
        function openSnapshotsModal() {
            document.getElementById('modal-snapshots').classList.add('active');
            loadSnapshots();
        }
        
        function closeSnapshotsModal() {
            document.getElementById('modal-snapshots').classList.remove('active');
        }
        
        function closeReminderModal() {
            document.getElementById('modal-snapshot-reminder').classList.remove('active');
        }
        
        function showSnapshotReminder() {
            if (!hasRecentSnapshot) {
                document.getElementById('modal-snapshot-reminder').classList.add('active');
                return true;
            }
            return false;
        }
        
        async function loadSnapshots() {
            const container = document.getElementById('snapshots-list');
            container.innerHTML = '<div class="loading-message">Loading snapshots...</div>';
            
            try {
                const response = await fetch('/api/building/snapshots');
                const data = await response.json();
                
                if (!data.success) {
                    container.innerHTML = '<div class="snapshots-empty">Error loading snapshots: ' + (data.error || 'Unknown') + '</div>';
                    return;
                }
                
                if (data.snapshots.length === 0) {
                    container.innerHTML = '<div class="snapshots-empty">No snapshots yet.<br>Create your first snapshot to document the installation.</div>';
                    return;
                }
                
                container.innerHTML = data.snapshots.map(s => {
                    const date = s.timestamp ? new Date(s.timestamp).toLocaleString() : 'Unknown date';
                    const types = (s.summary && s.summary.by_type) ? Object.entries(s.summary.by_type).map(([k,v]) => `${v}√ó ${k}`).join(', ') : '';
                    const sizeKB = s.size_bytes ? Math.round(s.size_bytes / 1024) : 0;
                    const sizeStr = sizeKB > 0 ? ` ‚Ä¢ ${sizeKB} KB` : '';
                    const rangeStr = s.scan_range ? ` ‚Ä¢ ${s.scan_range}` : '';
                    
                    return `
                        <div class="snapshot-item">
                            <div class="snapshot-info">
                                <div class="snapshot-filename">üì¶ ${s.filename}</div>
                                <div class="snapshot-meta">${date} ‚Ä¢ ${s.device_count} devices${types ? ' ‚Ä¢ ' + types : ''}${rangeStr}${sizeStr}</div>
                            </div>
                            <div class="snapshot-actions">
                                <button class="snapshot-download" onclick="downloadSnapshot('${s.filename}')" title="Download ZIP">üì•</button>
                                <button class="snapshot-delete" onclick="deleteSnapshot('${s.filename}')" title="Delete">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                container.innerHTML = '<div class="snapshots-empty">Error loading snapshots: ' + error.message + '</div>';
            }
        }
        
        async function downloadSnapshot(filename) {
            // Simple direct download via link
            const a = document.createElement('a');
            a.href = `/api/building/snapshot/${filename}/download`;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        async function deleteSnapshot(filename) {
            if (!confirm(`Delete snapshot ${filename}?`)) return;
            
            try {
                const response = await fetch(`/api/building/snapshot/${filename}`, { method: 'DELETE' });
                const data = await response.json();
                
                if (data.success) {
                    UI.showToast('Snapshot deleted', 'success');
                    loadSnapshots();
                    checkSnapshotStatus(); // Update badge
                } else {
                    UI.showToast('Delete failed: ' + (data.error || 'Unknown'), 'error');
                }
            } catch (error) {
                UI.showToast('Delete failed: ' + error.message, 'error');
            }
        }
        
        // ===========================================================================
        // Audit Functionality
        // ===========================================================================
        
        document.getElementById('btn-run-audit').addEventListener('click', openAuditSetupModal);
        document.getElementById('audit-close-btn').addEventListener('click', closeAuditModal);
        
        document.getElementById('modal-audit').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeAuditModal();
        });
        
        document.getElementById('modal-audit-setup').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeAuditSetupModal();
        });
        
        function showAuditProgress() {
            document.getElementById('modal-audit-progress').classList.add('active');
        }
        
        function hideAuditProgress() {
            document.getElementById('modal-audit-progress').classList.remove('active');
        }
        
        function openAuditModal() {
            document.getElementById('modal-audit').classList.add('active');
        }
        
        function closeAuditModal() {
            document.getElementById('modal-audit').classList.remove('active');
        }
        
        async function openAuditSetupModal() {
            // Load available snapshots
            const select = document.getElementById('audit-snapshot-select');
            select.innerHTML = '<option value="">Loading...</option>';
            
            try {
                const response = await fetch('/api/building/snapshots');
                const data = await response.json();
                
                if (data.success && data.snapshots && data.snapshots.length > 0) {
                    select.innerHTML = data.snapshots.map(snap => {
                        const date = snap.filename.match(/snapshot_(\d{8})_(\d{6})/);
                        let displayDate = snap.filename;
                        if (date) {
                            const d = date[1];
                            const t = date[2];
                            displayDate = `${d.slice(6,8)}.${d.slice(4,6)}.${d.slice(0,4)} ${t.slice(0,2)}:${t.slice(2,4)}`;
                        }
                        const sizeKB = snap.size_bytes ? Math.round(snap.size_bytes / 1024) : '?';
                        return `<option value="${snap.filename}">${displayDate} (${sizeKB} KB)</option>`;
                    }).join('');
                    document.getElementById('audit-start-btn').disabled = false;
                } else {
                    select.innerHTML = '<option value="">No snapshots available</option>';
                    document.getElementById('audit-start-btn').disabled = true;
                }
            } catch (error) {
                select.innerHTML = '<option value="">Error loading snapshots</option>';
                document.getElementById('audit-start-btn').disabled = true;
            }
            
            document.getElementById('modal-audit-setup').classList.add('active');
        }
        
        function closeAuditSetupModal() {
            document.getElementById('modal-audit-setup').classList.remove('active');
        }
        
        async function startAudit() {
            const snapshotFile = document.getElementById('audit-snapshot-select').value;
            if (!snapshotFile) {
                UI.showToast('Please select a snapshot', 'warning');
                return;
            }
            
            closeAuditSetupModal();
            showAuditProgress();
            
            try {
                const response = await fetch('/api/building/audit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ snapshot: snapshotFile })
                });
                const data = await response.json();
                
                hideAuditProgress();
                
                if (data.success) {
                    renderAuditResults(data);
                    openAuditModal();
                } else {
                    UI.showToast('Audit failed: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                hideAuditProgress();
                UI.showToast('Audit failed: ' + error.message, 'error');
            }
        }
        
        function renderAuditResults(data) {
            const summary = data.summary || {};
            const devices = data.devices || [];
            
            // Update subtitle
            const subtitle = document.getElementById('audit-subtitle');
            let subtitleText = `Live scan: ${data.timestamp ? new Date(data.timestamp).toLocaleString() : 'N/A'}`;
            if (data.snapshot_timestamp) {
                subtitleText += ` | Reference: ${new Date(data.snapshot_timestamp).toLocaleString()}`;
            }
            subtitle.textContent = subtitleText;
            
            // Render summary
            const summaryEl = document.getElementById('audit-summary');
            summaryEl.innerHTML = `
                <div class="audit-stat ok">‚úÖ OK: ${summary.ok || 0}</div>
                <div class="audit-stat warning">‚ö†Ô∏è Changed: ${summary.warning || 0}</div>
                <div class="audit-stat offline">‚ùå Offline: ${summary.offline || 0}</div>
                <div class="audit-stat new">üÜï New: ${summary.new || 0}</div>
            `;
            
            // Render device list
            const resultsEl = document.getElementById('audit-results');
            
            if (devices.length === 0) {
                resultsEl.innerHTML = '<div class="audit-empty">No devices found</div>';
                return;
            }
            
            resultsEl.innerHTML = devices.map(dev => {
                const statusIcon = {
                    'ok': '‚úÖ',
                    'warning': '‚ö†Ô∏è',
                    'offline': '‚ùå',
                    'new': 'üÜï'
                }[dev.status] || '‚ùì';
                
                const sourcesHtml = `
                    <span class="audit-source ${dev.in_snapshot ? 'present' : 'missing'}">snapshot</span>
                    <span class="audit-source ${dev.in_live ? 'present' : 'missing'}">live</span>
                `;
                
                const differencesHtml = dev.differences && dev.differences.length > 0 
                    ? `<div class="audit-differences">
                        ${dev.differences.map(d => `<div class="audit-diff-item">${escapeHtmlAudit(d)}</div>`).join('')}
                       </div>`
                    : '';
                
                return `
                    <div class="audit-device ${dev.status}">
                        <div class="audit-device-header">
                            <div class="audit-device-info">
                                <span class="audit-device-status">${statusIcon}</span>
                                <span class="audit-device-ip">${dev.ip || 'N/A'}</span>
                                <span class="audit-device-name">${dev.name || dev.mac}</span>
                                <span class="audit-device-model">(${dev.model || 'Unknown'})</span>
                            </div>
                            <div class="audit-device-sources">
                                ${sourcesHtml}
                            </div>
                        </div>
                        ${differencesHtml}
                    </div>
                `;
            }).join('');
        }
        
        function escapeHtmlAudit(str) {
            if (!str) return '';
            return str.replace(/[&<>"']/g, m => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            }[m]));
        }
        
        // ===========================================================================
        // Report Generator Functionality
        // ===========================================================================
        
        const reportModal = document.getElementById('modal-report');
        const reportSnapshotSelect = document.getElementById('report-snapshot-select');
        const reportLanguageSelect = document.getElementById('report-language');
        const reportFormatSelect = document.getElementById('report-format');
        const reportProgress = document.getElementById('report-progress');
        const reportError = document.getElementById('report-error');
        const reportGenerateBtn = document.getElementById('report-generate-btn');
        
        // Set default language from i18n
        document.addEventListener('DOMContentLoaded', () => {
            const currentLang = i18n.getLanguage() || 'de';
            if (reportLanguageSelect) {
                reportLanguageSelect.value = currentLang;
            }
        });
        
        document.getElementById('btn-generate-report').addEventListener('click', openReportModal);
        document.getElementById('report-cancel-btn').addEventListener('click', closeReportModal);
        document.getElementById('report-generate-btn').addEventListener('click', generateReport);
        
        // Toggle snapshot select based on radio
        document.querySelectorAll('input[name="snapshot-source"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                reportSnapshotSelect.disabled = (e.target.value === 'new');
                if (e.target.value === 'existing' && reportSnapshotSelect.options.length <= 1) {
                    loadSnapshotsForReport();
                }
            });
        });
        
        reportModal.addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeReportModal();
        });
        
        async function openReportModal() {
            // Reset state
            reportError.style.display = 'none';
            reportProgress.style.display = 'none';
            reportGenerateBtn.disabled = false;
            reportGenerateBtn.innerHTML = 'üìÑ ' + i18n.t('report.generate_btn');
            
            // Set default to "create new"
            document.querySelector('input[name="snapshot-source"][value="new"]').checked = true;
            reportSnapshotSelect.disabled = true;
            
            // Set language from current UI
            const currentLang = i18n.getLanguage() || 'de';
            reportLanguageSelect.value = currentLang;
            
            reportModal.classList.add('active');
        }
        
        function closeReportModal() {
            reportModal.classList.remove('active');
        }
        
        async function loadSnapshotsForReport() {
            try {
                const response = await fetch('/api/building/snapshots');
                const data = await response.json();
                
                if (data.success && data.snapshots && data.snapshots.length > 0) {
                    reportSnapshotSelect.innerHTML = `<option value="">${i18n.t('report.select_snapshot')}</option>`;
                    
                    data.snapshots.forEach(snap => {
                        const date = snap.timestamp ? new Date(snap.timestamp).toLocaleString() : snap.filename;
                        const option = document.createElement('option');
                        option.value = snap.filename;
                        option.textContent = `${date} (${snap.device_count} ${i18n.t('report.devices')})`;
                        reportSnapshotSelect.appendChild(option);
                    });
                } else {
                    reportSnapshotSelect.innerHTML = `<option value="">${i18n.t('report.no_snapshots')}</option>`;
                }
            } catch (error) {
                console.error('Failed to load snapshots:', error);
                reportSnapshotSelect.innerHTML = `<option value="">${i18n.t('common.error')}</option>`;
            }
        }
        
        async function generateReport() {
            const snapshotSource = document.querySelector('input[name="snapshot-source"]:checked').value;
            const language = reportLanguageSelect.value;
            const format = reportFormatSelect.value;
            
            let snapshotId = 'new';
            if (snapshotSource === 'existing') {
                snapshotId = reportSnapshotSelect.value;
                if (!snapshotId) {
                    showReportError(i18n.t('report.select_snapshot_error'));
                    return;
                }
            }
            
            // Show progress
            reportProgress.style.display = 'block';
            reportError.style.display = 'none';
            reportGenerateBtn.disabled = true;
            reportGenerateBtn.innerHTML = '‚è≥ ' + i18n.t('report.generating');
            
            try {
                const response = await fetch('/api/building/report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        snapshot_id: snapshotId,
                        language: language,
                        format: format
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
                
                // Get filename from Content-Disposition header
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = format === 'xlsx' ? 'report.xlsx' : 'report.pdf';
                if (contentDisposition) {
                    const match = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                    if (match && match[1]) {
                        filename = match[1].replace(/['"]/g, '');
                    }
                }
                
                // Download the file
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                closeReportModal();
                
                if (typeof UI !== 'undefined' && UI.showToast) {
                    UI.showToast(i18n.t('report.success'), 'success');
                }
                
            } catch (error) {
                console.error('Report generation failed:', error);
                showReportError(error.message);
            } finally {
                reportProgress.style.display = 'none';
                reportGenerateBtn.disabled = false;
                reportGenerateBtn.innerHTML = 'üìÑ ' + i18n.t('report.generate_btn');
            }
        }
        
        function showReportError(message) {
            reportError.textContent = message;
            reportError.style.display = 'block';
        }
        
        // ===========================================================================
        // Replace Device Functionality
        // ===========================================================================
        
        let replaceOldDevices = [];
        let replaceNewDevices = [];
        let replaceSelectedOld = null;
        let replaceSelectedNew = null;
        
        document.getElementById('btn-replace-device').addEventListener('click', openReplaceModal);
        document.getElementById('replace-cancel-btn').addEventListener('click', closeReplaceModal);
        document.getElementById('replace-scan-btn').addEventListener('click', scanForNewDevices);
        document.getElementById('replace-execute-btn').addEventListener('click', executeReplace);
        document.getElementById('replace-result-close-btn').addEventListener('click', closeReplaceResultModal);
        
        document.getElementById('replace-old-device').addEventListener('change', onOldDeviceSelected);
        document.getElementById('replace-new-device').addEventListener('change', onNewDeviceSelected);
        
        document.getElementById('modal-replace-device').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeReplaceModal();
        });
        
        function openReplaceModal() {
            resetReplaceState();
            document.getElementById('modal-replace-device').classList.add('active');
            loadOldDevices();
        }
        
        function closeReplaceModal() {
            document.getElementById('modal-replace-device').classList.remove('active');
        }
        
        function closeReplaceResultModal() {
            document.getElementById('modal-replace-result').classList.remove('active');
        }
        
        function resetReplaceState() {
            replaceOldDevices = [];
            replaceNewDevices = [];
            replaceSelectedOld = null;
            replaceSelectedNew = null;
            
            document.getElementById('replace-old-device').innerHTML = '<option value="">-- Select device --</option>';
            document.getElementById('replace-new-device').innerHTML = '<option value="">-- Scan first --</option>';
            document.getElementById('replace-new-device').disabled = true;
            document.getElementById('replace-old-info').style.display = 'none';
            document.getElementById('replace-new-info').style.display = 'none';
            document.getElementById('replace-type-warning').style.display = 'none';
            document.getElementById('replace-snapshot-info').style.display = 'none';
            document.getElementById('replace-execute-btn').disabled = true;
        }
        
        async function loadOldDevices() {
            try {
                const response = await fetch('/api/replace/devices');
                const data = await response.json();
                
                if (data.success) {
                    replaceOldDevices = data.devices;
                    const select = document.getElementById('replace-old-device');
                    select.innerHTML = '<option value="">-- Select device --</option>' +
                        data.devices.map(d => 
                            `<option value="${d.mac}">${d.ip} - ${d.name || d.mac} (${d.model || 'Unknown'})</option>`
                        ).join('');
                }
            } catch (error) {
                UI.showToast('Error loading devices: ' + error.message, 'error');
            }
        }
        
        async function onOldDeviceSelected() {
            const mac = document.getElementById('replace-old-device').value;
            const infoDiv = document.getElementById('replace-old-info');
            
            if (!mac) {
                replaceSelectedOld = null;
                infoDiv.style.display = 'none';
                document.getElementById('replace-snapshot-info').style.display = 'none';
                updateReplaceButton();
                return;
            }
            
            replaceSelectedOld = replaceOldDevices.find(d => d.mac === mac);
            
            if (replaceSelectedOld) {
                infoDiv.innerHTML = `
                    <div class="info-row"><span class="info-label">MAC:</span><span class="info-value">${replaceSelectedOld.mac}</span></div>
                    <div class="info-row"><span class="info-label">IP:</span><span class="info-value">${replaceSelectedOld.ip}</span></div>
                    <div class="info-row"><span class="info-label">Model:</span><span class="info-value">${replaceSelectedOld.model || 'Unknown'}</span></div>
                `;
                infoDiv.style.display = 'block';
                
                // Load snapshot config
                await loadSnapshotConfig(mac);
            }
            
            checkTypeMatch();
            updateReplaceButton();
        }
        
        async function loadSnapshotConfig(mac) {
            const infoDiv = document.getElementById('replace-snapshot-info');
            const contentDiv = document.getElementById('replace-snapshot-content');
            
            try {
                const response = await fetch(`/api/replace/snapshot-config/${mac}`);
                const data = await response.json();
                
                if (data.success && data.found) {
                    // Store for later download - include device info
                    window.replaceSnapshotData = data;
                    window.replaceSnapshotData.deviceName = replaceSelectedOld?.name || 'device';
                    window.replaceSnapshotData.deviceMac = replaceSelectedOld?.mac || 'unknown';
                    
                    let html = `<div class="config-item">Snapshot: ${new Date(data.snapshot_timestamp).toLocaleString()}</div>`;
                    
                    const cfg = data.config;
                    
                    if (cfg.inputs && cfg.inputs.length) {
                        html += '<div class="config-section">Inputs:</div>';
                        cfg.inputs.forEach(i => html += `<div class="config-item">${i}</div>`);
                    }
                    
                    if (cfg.switches && cfg.switches.length) {
                        html += '<div class="config-section">Switches:</div>';
                        cfg.switches.forEach(s => html += `<div class="config-item">${s}</div>`);
                    }
                    
                    if (cfg.covers && cfg.covers.length) {
                        html += '<div class="config-section">Covers:</div>';
                        cfg.covers.forEach(c => html += `<div class="config-item">${c}</div>`);
                    }
                    
                    if (cfg.scripts && cfg.scripts.length) {
                        html += '<div class="config-section">Scripts:</div>';
                        cfg.scripts.forEach(s => {
                            const name = typeof s === 'object' ? s.name : s;
                            html += `<div class="config-item">${name}</div>`;
                        });
                    }
                    
                    if (cfg.kvs && Object.keys(cfg.kvs).length) {
                        html += '<div class="config-section">KVS:</div>';
                        for (const [key, val] of Object.entries(cfg.kvs)) {
                            const valStr = typeof val === 'object' ? JSON.stringify(val.value || val) : val;
                            html += `<div class="config-item">${key} = ${valStr.substring(0, 50)}${valStr.length > 50 ? '...' : ''}</div>`;
                        }
                    }
                    
                    if (cfg.webhooks && cfg.webhooks.length) {
                        html += '<div class="config-section">Webhooks:</div>';
                        cfg.webhooks.forEach(w => {
                            const event = w.event || 'unknown';
                            const url = (w.urls && w.urls[0]) || 'no url';
                            html += `<div class="config-item">${event} ‚Üí ${url.substring(0, 40)}...</div>`;
                        });
                    }
                    
                    contentDiv.innerHTML = html;
                    infoDiv.style.display = 'block';
                } else {
                    window.replaceSnapshotData = null;
                    infoDiv.style.display = 'none';
                }
            } catch (error) {
                window.replaceSnapshotData = null;
                infoDiv.style.display = 'none';
            }
        }
        
        async function scanForNewDevices() {
            const btn = document.getElementById('replace-scan-btn');
            const select = document.getElementById('replace-new-device');
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Scanning...';
            select.innerHTML = '<option value="">-- Scanning... --</option>';
            
            try {
                const response = await fetch('/api/replace/scan-dhcp', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    replaceNewDevices = data.devices;
                    
                    if (data.devices.length === 0) {
                        select.innerHTML = '<option value="">-- No devices found --</option>';
                    } else {
                        select.innerHTML = '<option value="">-- Select new device --</option>' +
                            data.devices.map(d => 
                                `<option value="${d.mac}">${d.ip} - ${d.name || d.mac} (${d.model || 'Unknown'})</option>`
                            ).join('');
                        select.disabled = false;
                    }
                } else {
                    UI.showToast('Scan failed: ' + (data.error || 'Unknown'), 'error');
                    select.innerHTML = '<option value="">-- Scan failed --</option>';
                }
            } catch (error) {
                UI.showToast('Scan failed: ' + error.message, 'error');
                select.innerHTML = '<option value="">-- Scan failed --</option>';
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîç Scan';
            }
        }
        
        function onNewDeviceSelected() {
            const mac = document.getElementById('replace-new-device').value;
            const infoDiv = document.getElementById('replace-new-info');
            
            if (!mac) {
                replaceSelectedNew = null;
                infoDiv.style.display = 'none';
                updateReplaceButton();
                return;
            }
            
            replaceSelectedNew = replaceNewDevices.find(d => d.mac === mac);
            
            if (replaceSelectedNew) {
                infoDiv.innerHTML = `
                    <div class="info-row"><span class="info-label">MAC:</span><span class="info-value">${replaceSelectedNew.mac}</span></div>
                    <div class="info-row"><span class="info-label">IP:</span><span class="info-value">${replaceSelectedNew.ip}</span></div>
                    <div class="info-row"><span class="info-label">Model:</span><span class="info-value">${replaceSelectedNew.model || 'Unknown'}</span></div>
                    <div class="info-row"><span class="info-label">Firmware:</span><span class="info-value">${replaceSelectedNew.fw || 'Unknown'}</span></div>
                `;
                infoDiv.style.display = 'block';
            }
            
            checkTypeMatch();
            updateReplaceButton();
        }
        
        function checkTypeMatch() {
            const warningDiv = document.getElementById('replace-type-warning');
            
            if (replaceSelectedOld && replaceSelectedNew) {
                const oldModel = (replaceSelectedOld.model || '').toLowerCase();
                const newModel = (replaceSelectedNew.model || '').toLowerCase();
                
                if (oldModel && newModel && oldModel !== newModel) {
                    warningDiv.style.display = 'block';
                } else {
                    warningDiv.style.display = 'none';
                }
            } else {
                warningDiv.style.display = 'none';
            }
        }
        
        function updateReplaceButton() {
            const btn = document.getElementById('replace-execute-btn');
            btn.disabled = !(replaceSelectedOld && replaceSelectedNew);
        }
        
        async function executeReplace() {
            if (!replaceSelectedOld || !replaceSelectedNew) return;
            
            // Show progress
            closeReplaceModal();
            document.getElementById('modal-replace-progress').classList.add('active');
            document.getElementById('replace-progress-text').textContent = 'Updating ip_state.json and configuring device...';
            
            try {
                const response = await fetch('/api/replace/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        old_mac: replaceSelectedOld.mac,
                        new_mac: replaceSelectedNew.mac,
                        new_ip: replaceSelectedNew.ip
                    })
                });
                
                const data = await response.json();
                
                document.getElementById('modal-replace-progress').classList.remove('active');
                
                if (data.success) {
                    showReplaceResult(data);
                    // Refresh device list
                    App.loadDevices();
                } else {
                    UI.showToast('Replace failed: ' + (data.error || 'Unknown'), 'error');
                }
            } catch (error) {
                document.getElementById('modal-replace-progress').classList.remove('active');
                UI.showToast('Replace failed: ' + error.message, 'error');
            }
        }
        
        function showReplaceResult(data) {
            const titleEl = document.getElementById('replace-result-title');
            const contentEl = document.getElementById('replace-result-content');
            
            const stage2Success = data.stage2_result && data.stage2_result.success;
            
            titleEl.textContent = stage2Success ? '‚úÖ Device Replaced' : '‚ö†Ô∏è Partially Complete';
            
            let html = `
                <div class="result-success">
                    <p>‚úÖ ip_state.json updated</p>
                    <p>Old MAC: ${data.old_mac} ‚Üí New MAC: ${data.new_mac}</p>
                </div>
                
                <div class="result-info">
                    <p><strong>Device:</strong> ${data.device_name || 'Unknown'}</p>
                    <p><strong>Target IP:</strong> ${data.target_ip}</p>
                    <p><strong>Stage 2:</strong> ${stage2Success ? '‚úÖ Static IP + WiFi configured' : '‚ùå ' + (data.stage2_result?.error || 'Failed')}</p>
                </div>
                
                <div class="next-steps">
                    <h4>Next Steps:</h4>
                    <ul>
                        <li>Wait for device to reboot (~30 seconds)</li>
                        <li>Run <strong>Stage 3</strong> for firmware update and friendly name</li>
                        <li>Run <strong>Stage 4</strong> for profile configuration</li>
                        <li>Manually restore scripts, KVS, and webhooks if needed</li>
                    </ul>
                </div>
            `;
            
            // Add snapshot config section if available
            if (window.replaceSnapshotData && window.replaceSnapshotData.config) {
                const cfg = window.replaceSnapshotData.config;
                html += `
                    <div class="result-snapshot">
                        <h4>üì∏ Old Device Config from Snapshot:</h4>
                        <div class="snapshot-config-display">
                `;
                
                if (cfg.inputs && cfg.inputs.length) {
                    html += `<div class="cfg-section"><strong>Inputs:</strong> ${cfg.inputs.join(', ')}</div>`;
                }
                if (cfg.switches && cfg.switches.length) {
                    html += `<div class="cfg-section"><strong>Switches:</strong> ${cfg.switches.join(', ')}</div>`;
                }
                if (cfg.scripts && cfg.scripts.length) {
                    const names = cfg.scripts.map(s => typeof s === 'object' ? s.name : s).join(', ');
                    html += `<div class="cfg-section"><strong>Scripts:</strong> ${names}</div>`;
                }
                if (cfg.kvs && Object.keys(cfg.kvs).length) {
                    html += `<div class="cfg-section"><strong>KVS:</strong> ${Object.keys(cfg.kvs).join(', ')}</div>`;
                }
                if (cfg.webhooks && cfg.webhooks.length) {
                    html += `<div class="cfg-section"><strong>Webhooks:</strong> ${cfg.webhooks.length} configured</div>`;
                }
                
                html += `
                        </div>
                        <button class="btn-secondary" onclick="downloadSnapshotConfig()" style="margin-top: 0.75rem;">
                            üì• Download Full Config
                        </button>
                    </div>
                `;
            }
            
            contentEl.innerHTML = html;
            document.getElementById('modal-replace-result').classList.add('active');
        }
        
        function downloadSnapshotConfig() {
            if (!window.replaceSnapshotData) return;
            
            const data = window.replaceSnapshotData;
            const deviceName = data.deviceName || 'device';
            const deviceMac = data.deviceMac || 'unknown';
            
            // Build readable text file
            let content = `Device Configuration Backup\n`;
            content += `===========================\n\n`;
            content += `Device: ${deviceName}\n`;
            content += `MAC: ${deviceMac}\n`;
            content += `Snapshot: ${data.snapshot_timestamp}\n`;
            content += `\n`;
            
            const cfg = data.config;
            
            if (cfg.inputs && cfg.inputs.length) {
                content += `INPUTS:\n`;
                cfg.inputs.forEach(i => content += `  ${i}\n`);
                content += `\n`;
            }
            
            if (cfg.switches && cfg.switches.length) {
                content += `SWITCHES:\n`;
                cfg.switches.forEach(s => content += `  ${s}\n`);
                content += `\n`;
            }
            
            if (cfg.covers && cfg.covers.length) {
                content += `COVERS:\n`;
                cfg.covers.forEach(c => content += `  ${c}\n`);
                content += `\n`;
            }
            
            if (cfg.scripts && cfg.scripts.length) {
                content += `SCRIPTS:\n`;
                cfg.scripts.forEach(s => {
                    if (typeof s === 'object') {
                        content += `  --- ${s.name} ---\n`;
                        if (s.code) {
                            content += s.code + `\n`;
                        }
                        content += `\n`;
                    } else {
                        content += `  ${s}\n`;
                    }
                });
                content += `\n`;
            }
            
            if (cfg.kvs && Object.keys(cfg.kvs).length) {
                content += `KVS (Key-Value Store):\n`;
                for (const [key, val] of Object.entries(cfg.kvs)) {
                    const valStr = typeof val === 'object' ? JSON.stringify(val, null, 2) : val;
                    content += `  ${key}:\n    ${valStr}\n`;
                }
                content += `\n`;
            }
            
            if (cfg.webhooks && cfg.webhooks.length) {
                content += `WEBHOOKS:\n`;
                cfg.webhooks.forEach(w => {
                    content += `  Event: ${w.event || 'unknown'}\n`;
                    content += `  URLs: ${(w.urls || []).join(', ')}\n`;
                    content += `  Enable: ${w.enable}\n`;
                    content += `\n`;
                });
            }
            
            // Download
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${deviceName}_config_backup.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Check snapshot status after devices load
        setTimeout(checkSnapshotStatus, 2000);
        
        // Back button - navigate directly (badge provides subtle reminder)
        document.getElementById('btn-back').addEventListener('click', async (e) => {
            e.preventDefault();
            await navigateToGreeting();
        });
        
        // Helper to deactivate building and navigate to greeting
        async function navigateToGreeting() {
            try {
                await fetch('/api/buildings/deactivate', { method: 'POST' });
            } catch (error) {
                console.error('Error deactivating building:', error);
            }
            window.location.href = '/';
        }
        
        // Reminder modal: Skip button navigates away
        document.getElementById('reminder-skip-btn').addEventListener('click', async () => {
            closeReminderModal();
            await navigateToGreeting();
        });
        
        // Reminder modal: Create button creates snapshot then navigates
        document.getElementById('reminder-create-btn').addEventListener('click', async () => {
            closeReminderModal();
            await createSnapshot();
            await navigateToGreeting();
        });
        
        // Toggle password visibility
        document.querySelectorAll('.toggle-password').forEach(btn => {
            btn.addEventListener('click', () => {
                const targetId = btn.dataset.target;
                const input = document.getElementById(targetId);
                if (input.type === 'password') {
                    input.type = 'text';
                    btn.textContent = 'üôà';
                } else {
                    input.type = 'password';
                    btn.textContent = 'üëÅ';
                }
            });
        });
        
        // Toggle fallback WiFi section
        document.getElementById('toggle-fallback-wifi').addEventListener('click', function() {
            const fields = document.getElementById('fallback-wifi-fields');
            const isHidden = fields.style.display === 'none';
            fields.style.display = isHidden ? 'block' : 'none';
            this.textContent = (isHidden ? '‚ñº' : '‚ñ∂') + ' Fallback WiFi (optional)';
        });
        
        // Live validation on network inputs
        ['pool-start', 'pool-end', 'network-gateway', 'dhcp-start', 'dhcp-end'].forEach(id => {
            document.getElementById(id).addEventListener('input', debounce(validateNetworkInputs, 500));
        });
        
        // Close modal on overlay click
        settingsModal.addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeBuildingSettings();
        });
        
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }
        
        async function openBuildingSettings() {
            // Personal Edition: No PIN required - open directly
            if (!App.isPro) {
                doOpenBuildingSettings();
                return;
            }
            
            // First check local auth state (set after successful PIN entry)
            if (window.settingsState && window.settingsState.isAuthenticated) {
                // Already authenticated - open directly
                doOpenBuildingSettings();
                return;
            }
            
            // Check with server
            try {
                const response = await fetch('/api/admin/status');
                const statusData = await response.json();
                
                if (statusData.authenticated) {
                    window.settingsState.isAuthenticated = true;
                    doOpenBuildingSettings();
                } else {
                    // Need PIN - show dialog and set pending action
                    window.settingsState.pendingAction = 'building-settings';
                    const pinModal = document.getElementById('modal-pin');
                    const pinInput = document.getElementById('admin-pin-input');
                    const pinError = document.getElementById('pin-error');
                    if (pinModal) {
                        pinModal.classList.add('active');
                        if (pinInput) pinInput.value = '';
                        if (pinError) pinError.style.display = 'none';
                        setTimeout(() => pinInput && pinInput.focus(), 100);
                    }
                }
            } catch (error) {
                console.error('Failed to check admin status:', error);
                UI.showToast('Connection error', 'error');
            }
        }
        
        async function doOpenBuildingSettings() {
            // Get active building name from UI
            const buildingName = document.getElementById('building-name').textContent || '-';
            settingsBuildingName.textContent = `Building: ${buildingName}`;
            
            // Reset fallback WiFi to collapsed state
            document.getElementById('fallback-wifi-fields').style.display = 'none';
            document.getElementById('toggle-fallback-wifi').textContent = '‚ñ∂ Fallback WiFi (optional)';
            
            settingsModal.classList.add('active');
            await loadBuildingSettings();
        }
        
        // Make function globally accessible for PIN callback
        window.openBuildingSettings = openBuildingSettings;
        
        function closeBuildingSettings() {
            settingsModal.classList.remove('active');
        }
        
        async function loadBuildingSettings() {
            try {
                // Load building settings (WiFi, Network)
                const data = await API.getBuildingSettings();
                
                if (data.success) {
                    // WiFi
                    document.getElementById('wifi-primary-ssid').value = data.wifi.primary.ssid || '';
                    document.getElementById('wifi-primary-password').value = data.wifi.primary.password || '';
                    document.getElementById('wifi-fallback-ssid').value = data.wifi.fallback.ssid || '';
                    document.getElementById('wifi-fallback-password').value = data.wifi.fallback.password || '';
                    
                    // Show fallback section if it has data
                    if (data.wifi.fallback.ssid) {
                        document.getElementById('fallback-wifi-fields').style.display = 'block';
                        document.getElementById('toggle-fallback-wifi').textContent = '‚ñº Fallback WiFi (optional)';
                    }
                    
                    // Network
                    document.getElementById('pool-start').value = data.network.pool_start || '';
                    document.getElementById('pool-end').value = data.network.pool_end || '';
                    document.getElementById('network-gateway').value = data.network.gateway || '';
                    document.getElementById('dhcp-start').value = data.network.dhcp_scan_start || '';
                    document.getElementById('dhcp-end').value = data.network.dhcp_scan_end || '';
                    
                    // Trigger validation
                    validateNetworkInputs();
                }
                
                // Load admin settings (Provisioning, OTA, Export) - Pro only
                if (App.isPro) {
                    const adminResp = await fetch('/api/admin/settings');
                    const adminData = await adminResp.json();
                    if (adminData.success) {
                        const settings = adminData.settings;
                        
                        // Stage 1 - Provisioning
                        document.getElementById('setting-loop-mode').checked = settings.stage1?.loop_mode ?? true;
                        document.getElementById('setting-disable-ap').checked = settings.stage1?.disable_ap ?? true;
                        document.getElementById('setting-disable-bt').checked = settings.stage1?.disable_bluetooth ?? true;
                        document.getElementById('setting-disable-cloud').checked = settings.stage1?.disable_cloud ?? true;
                        document.getElementById('setting-disable-mqtt').checked = settings.stage1?.mqtt_disable ?? true;
                        
                        // Stage 3 - OTA
                        document.getElementById('setting-ota-enabled').checked = settings.stage3?.ota_enabled ?? true;
                        document.getElementById('setting-ota-mode').value = settings.stage3?.ota_mode || 'check_and_update';
                        document.getElementById('setting-ota-timeout').value = settings.stage3?.ota_timeout || 20;
                        
                        // Export
                        document.getElementById('setting-csv-delimiter').value = settings.report?.csv_delimiter || ';';
                        buildingSettingsState.selectedColumns = settings.report?.default_columns || [];
                        renderBuildingColumnsGrid();
                    }
                    
                    // Load model map - Pro only
                    await loadBuildingModelMap();
                    
                    // Load profiles list for advanced tab - Pro only
                    await loadBuildingProfilesList();
                }
                
                // Load building profile (both editions)
                await loadBuildingProfile();
                
            } catch (error) {
                console.error('Error loading building settings:', error);
                UI.showToast('Error loading settings', 'error');
            }
        }
        
        // State for building settings dialog
        let buildingSettingsState = {
            selectedColumns: [],
            modelMap: [],
            advancedFile: '',
            advancedContent: '',
            advancedOriginal: ''
        };
        
        function renderBuildingColumnsGrid() {
            const grid = document.getElementById('settings-columns-grid');
            if (!grid) return;
            
            const AVAILABLE_COLUMNS = [
                'id', 'ip', 'hostname', 'fw', 'model', 'hw_model', 
                'friendly_name', 'room', 'location', 'assigned_at', 
                'last_seen', 'stage3_friendly_status', 'stage3_ota_status', 'stage4_status_result'
            ];
            
            const selected = buildingSettingsState.selectedColumns || [];
            
            grid.innerHTML = AVAILABLE_COLUMNS.map(col => `
                <label>
                    <input type="checkbox" value="${col}" ${selected.includes(col) ? 'checked' : ''}>
                    ${col}
                </label>
            `).join('');
        }
        
        function getBuildingSelectedColumns() {
            const grid = document.getElementById('settings-columns-grid');
            if (!grid) return [];
            return Array.from(grid.querySelectorAll('input:checked')).map(cb => cb.value);
        }
        
        async function loadBuildingModelMap() {
            try {
                const response = await fetch('/api/admin/model-map');
                const data = await response.json();
                if (data.success) {
                    buildingSettingsState.modelMap = data.entries || [];
                    renderBuildingModelMapTable();
                }
            } catch (error) {
                console.error('Failed to load model map:', error);
            }
        }
        
        function renderBuildingModelMapTable() {
            const tbody = document.getElementById('model-map-body');
            if (!tbody) return;
            
            if (buildingSettingsState.modelMap.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="empty-message">No mappings defined</td></tr>';
                return;
            }
            
            tbody.innerHTML = buildingSettingsState.modelMap.map((entry, idx) => `
                <tr>
                    <td><input type="text" value="${entry.hw_id || ''}" data-idx="${idx}" data-field="hw_id" class="model-map-input"></td>
                    <td><input type="text" value="${entry.display_name || ''}" data-idx="${idx}" data-field="display_name" class="model-map-input"></td>
                    <td><button class="btn-icon btn-remove-model" data-idx="${idx}">üóëÔ∏è</button></td>
                </tr>
            `).join('');
            
            // Add event listeners
            tbody.querySelectorAll('.model-map-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const idx = parseInt(e.target.dataset.idx);
                    const field = e.target.dataset.field;
                    buildingSettingsState.modelMap[idx][field] = e.target.value;
                });
            });
            
            tbody.querySelectorAll('.btn-remove-model').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idx = parseInt(e.target.dataset.idx);
                    buildingSettingsState.modelMap.splice(idx, 1);
                    renderBuildingModelMapTable();
                });
            });
        }
        
        async function loadBuildingProfile() {
            try {
                const response = await fetch('/api/settings/building-profile');
                const data = await response.json();
                if (data.success && data.profile) {
                    document.getElementById('building-object-name').value = data.profile.object_name || '';
                    document.getElementById('building-address').value = data.profile.address || '';
                    document.getElementById('building-customer-name').value = data.profile.customer_name || '';
                    document.getElementById('building-contact-phone').value = data.profile.contact_phone || '';
                    document.getElementById('building-contact-email').value = data.profile.contact_email || '';
                    document.getElementById('building-notes').value = data.profile.notes || '';
                }
            } catch (error) {
                console.error('Failed to load building profile:', error);
            }
        }
        
        async function loadBuildingProfilesList() {
            try {
                const response = await fetch('/api/admin/profiles');
                const data = await response.json();
                if (data.success) {
                    const select = document.getElementById('advanced-file-select');
                    if (select) {
                        select.innerHTML = '<option value="">Select file...</option>' +
                            data.files.map(f => `<option value="${f.path}">${f.name}</option>`).join('');
                    }
                }
            } catch (error) {
                console.error('Failed to load profiles list:', error);
            }
        }
        
        async function validateNetworkInputs() {
            const network = {
                pool_start: document.getElementById('pool-start').value.trim(),
                pool_end: document.getElementById('pool-end').value.trim(),
                gateway: document.getElementById('network-gateway').value.trim(),
                dhcp_scan_start: document.getElementById('dhcp-start').value.trim(),
                dhcp_scan_end: document.getElementById('dhcp-end').value.trim()
            };
            
            // Only require pool_start and pool_end - gateway and DHCP are optional
            if (!network.pool_start || !network.pool_end) {
                document.getElementById('network-validation').style.display = 'none';
                document.getElementById('pool-count-info').textContent = 'Pool: - IPs';
                document.getElementById('dhcp-count-info').textContent = 'DHCP: full scan';
                return;
            }
            
            try {
                const data = await API.validateNetworkSettings(network);
                
                const validationDiv = document.getElementById('network-validation');
                const poolCountInfo = document.getElementById('pool-count-info');
                const dhcpCountInfo = document.getElementById('dhcp-count-info');
                
                // Update counts
                if (data.info) {
                    poolCountInfo.textContent = `Pool: ${data.info.pool_count} IPs`;
                    poolCountInfo.className = 'info-item' + (data.info.pool_count >= 10 ? ' valid' : '');
                    dhcpCountInfo.textContent = `DHCP: ${data.info.dhcp_count} IPs`;
                    dhcpCountInfo.className = 'info-item valid';
                }
                
                // Show errors/warnings
                if (data.errors && data.errors.length > 0) {
                    validationDiv.innerHTML = data.errors.map(e => 
                        `<div class="validation-error">‚ùå ${e}</div>`
                    ).join('');
                    validationDiv.className = 'network-validation has-errors';
                    validationDiv.style.display = 'block';
                    
                    // Mark inputs as error
                    ['pool-start', 'pool-end', 'dhcp-start', 'dhcp-end'].forEach(id => {
                        document.getElementById(id).classList.add('error');
                    });
                } else if (data.warnings && data.warnings.length > 0) {
                    validationDiv.innerHTML = data.warnings.map(w => 
                        `<div class="validation-warning">‚ö†Ô∏è ${w}</div>`
                    ).join('');
                    validationDiv.className = 'network-validation has-warnings';
                    validationDiv.style.display = 'block';
                    
                    // Remove error class
                    ['pool-start', 'pool-end', 'dhcp-start', 'dhcp-end'].forEach(id => {
                        document.getElementById(id).classList.remove('error');
                    });
                } else {
                    validationDiv.style.display = 'none';
                    ['pool-start', 'pool-end', 'dhcp-start', 'dhcp-end'].forEach(id => {
                        document.getElementById(id).classList.remove('error');
                    });
                }
            } catch (error) {
                console.error('Validation error:', error);
            }
        }
        
        async function saveBuildingSettings() {
            const wifiNetworkSettings = {
                wifi: {
                    primary: {
                        ssid: document.getElementById('wifi-primary-ssid').value.trim(),
                        password: document.getElementById('wifi-primary-password').value
                    },
                    fallback: {
                        ssid: document.getElementById('wifi-fallback-ssid').value.trim(),
                        password: document.getElementById('wifi-fallback-password').value
                    }
                },
                network: {
                    pool_start: document.getElementById('pool-start').value.trim(),
                    pool_end: document.getElementById('pool-end').value.trim(),
                    gateway: document.getElementById('network-gateway').value.trim(),
                    dhcp_scan_start: document.getElementById('dhcp-start').value.trim(),
                    dhcp_scan_end: document.getElementById('dhcp-end').value.trim()
                }
            };
            
            // Basic validation - only require pool, gateway is auto-derived if empty
            if (!wifiNetworkSettings.wifi.primary.ssid) {
                alert('Primary WiFi SSID is required');
                document.getElementById('wifi-primary-ssid').focus();
                return;
            }
            
            if (!wifiNetworkSettings.network.pool_start || !wifiNetworkSettings.network.pool_end) {
                alert('Pool Start and Pool End are required');
                return;
            }
            
            const saveBtn = document.getElementById('settings-save-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            
            try {
                // 1. Save WiFi/Network settings
                const wifiData = await API.saveBuildingSettings(wifiNetworkSettings);
                if (!wifiData.success) {
                    throw new Error('WiFi/Network: ' + (wifiData.error || 'Unknown error'));
                }
                
                // 2. Save admin settings (Provisioning, OTA, Export) - Pro only
                if (App.isPro) {
                    const adminSettings = {
                        settings: {
                            stage1: {
                                loop_mode: document.getElementById('setting-loop-mode').checked,
                                disable_ap: document.getElementById('setting-disable-ap').checked,
                                disable_bluetooth: document.getElementById('setting-disable-bt').checked,
                                disable_cloud: document.getElementById('setting-disable-cloud').checked,
                                mqtt_disable: document.getElementById('setting-disable-mqtt').checked,
                            },
                            stage3: {
                                ota_enabled: document.getElementById('setting-ota-enabled').checked,
                                ota_mode: document.getElementById('setting-ota-mode').value,
                                ota_timeout: parseInt(document.getElementById('setting-ota-timeout').value) || 20,
                            },
                            report: {
                                csv_delimiter: document.getElementById('setting-csv-delimiter').value,
                                default_columns: getBuildingSelectedColumns(),
                            }
                        }
                    };
                    
                    const adminResp = await fetch('/api/admin/settings', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(adminSettings)
                    });
                    const adminData = await adminResp.json();
                    if (!adminData.success) {
                        throw new Error('Admin settings: ' + (adminData.error || 'Unknown error'));
                    }
                    
                    // 3. Save model map - Pro only
                    const validEntries = buildingSettingsState.modelMap.filter(e => e.hw_id && e.display_name);
                    const mapResp = await fetch('/api/admin/model-map', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ entries: validEntries })
                    });
                    const mapData = await mapResp.json();
                    if (!mapData.success) {
                        throw new Error('Model map: ' + (mapData.error || 'Unknown error'));
                    }
                }
                
                // 4. Save building profile
                const profile = {
                    object_name: document.getElementById('building-object-name').value.trim(),
                    address: document.getElementById('building-address').value.trim(),
                    customer_name: document.getElementById('building-customer-name').value.trim(),
                    contact_phone: document.getElementById('building-contact-phone').value.trim(),
                    contact_email: document.getElementById('building-contact-email').value.trim(),
                    notes: document.getElementById('building-notes').value.trim()
                };
                
                const profileResp = await fetch('/api/settings/building-profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(profile)
                });
                const profileData = await profileResp.json();
                if (!profileData.success) {
                    throw new Error('Building profile: ' + (profileData.error || 'Unknown error'));
                }
                
                UI.showToast('Settings saved!', 'success');
                closeBuildingSettings();
                
            } catch (error) {
                UI.showToast('Error: ' + error.message, 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'üíæ Speichern';
            }
        }
        
        // =====================================================================
        // Scripts Tab Functionality
        // =====================================================================
        
        let selectedScript = null;
        let scriptsCache = [];
        let scriptsSelectedDevices = new Set();
        
        // Initialize scripts tab
        document.getElementById('scripts-source').addEventListener('change', loadScripts);
        document.getElementById('btn-refresh-scripts').addEventListener('click', loadScripts);
        document.getElementById('btn-deploy-script').addEventListener('click', deployScript);
        document.getElementById('btn-script-status').addEventListener('click', checkScriptStatus);
        document.getElementById('btn-delete-script').addEventListener('click', deleteScriptFromDevices);
        document.getElementById('btn-script-start').addEventListener('click', () => controlScripts('start'));
        document.getElementById('btn-script-stop').addEventListener('click', () => controlScripts('stop'));
        document.getElementById('btn-script-restart').addEventListener('click', () => controlScripts('restart'));
        document.getElementById('btn-scripts-select-all').addEventListener('click', scriptsSelectAll);
        document.getElementById('btn-scripts-select-none').addEventListener('click', scriptsSelectNone);
        
        // Script pool management (upload/delete .js files)
        document.getElementById('btn-upload-script-file').addEventListener('click', () => {
            document.getElementById('script-upload-input').click();
        });
        document.getElementById('script-upload-input').addEventListener('change', uploadScriptFile);
        document.getElementById('btn-delete-script-file').addEventListener('click', deleteScriptFile);
        
        // Update device list when filter changes
        document.addEventListener('deviceSelected', () => {
            document.getElementById('scripts-results').innerHTML = '';
            updateScriptsDeviceList();
        });
        
        document.addEventListener('deviceSelectionChanged', updateScriptsDeviceList);
        
        // Load scripts when tab is activated
        document.querySelector('.tab-btn[data-tab="scripts"]').addEventListener('click', () => {
            loadScripts();
            updateScriptsDeviceList();
        });
        
        async function loadScripts() {
            const source = document.getElementById('scripts-source').value;
            const listEl = document.getElementById('scripts-list');
            
            listEl.innerHTML = '<div class="loading-small">Loading scripts...</div>';
            selectedScript = null;
            updateScriptsButtons();
            
            try {
                const response = await fetch(`/api/scripts?source=${source}`);
                const data = await response.json();
                
                if (!data.success) {
                    listEl.innerHTML = `<div class="no-scripts">Error: ${data.error}</div>`;
                    return;
                }
                
                scriptsCache = data.scripts || [];
                
                if (scriptsCache.length === 0) {
                    listEl.innerHTML = '<div class="no-scripts">Keine Scripts gefunden</div>';
                    return;
                }
                
                listEl.innerHTML = scriptsCache.map((script, idx) => `
                    <div class="script-item" data-idx="${idx}" onclick="selectScript(${idx})">
                        <input type="radio" name="script-select" ${idx === 0 ? '' : ''}>
                        <div class="script-item-info">
                            <div class="script-item-name">${script.name}</div>
                            <div class="script-item-desc">${script.description || script.filename || ''}</div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                listEl.innerHTML = `<div class="no-scripts">Verbindungsfehler</div>`;
            }
        }
        
        function selectScript(idx) {
            selectedScript = scriptsCache[idx];
            
            // Update UI
            document.querySelectorAll('.script-item').forEach((el, i) => {
                el.classList.toggle('selected', i === idx);
                el.querySelector('input[type="radio"]').checked = (i === idx);
            });
            
            // Prefill script name input with source script name
            const nameInput = document.getElementById('script-deploy-name');
            if (nameInput && selectedScript) {
                // Use script name without .js extension
                const baseName = selectedScript.name || selectedScript.filename || '';
                nameInput.value = baseName.replace(/\.js$/i, '');
            }
            
            updateScriptsButtons();
        }
        
        function updateScriptsButtons() {
            const hasScript = selectedScript !== null;
            const hasTargets = getScriptTargetDevices().length > 0;
            const source = document.getElementById('scripts-source').value;
            
            document.getElementById('btn-deploy-script').disabled = !(hasScript && hasTargets);
            document.getElementById('btn-script-status').disabled = !hasTargets;
            document.getElementById('btn-delete-script').disabled = !hasTargets;
            document.getElementById('btn-script-start').disabled = !hasTargets;
            document.getElementById('btn-script-stop').disabled = !hasTargets;
            document.getElementById('btn-script-restart').disabled = !hasTargets;
            
            // Delete from pool only enabled for local scripts when one is selected
            document.getElementById('btn-delete-script-file').disabled = !(hasScript && source === 'local');
        }
        
        async function uploadScriptFile() {
            const fileInput = document.getElementById('script-upload-input');
            const file = fileInput.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.js')) {
                UI.showToast('Only .js files allowed', 'error');
                fileInput.value = '';
                return;
            }
            
            const formData = new FormData();
            formData.append('script', file);
            
            try {
                const response = await fetch('/api/admin/scripts/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                if (data.success) {
                    UI.showToast('Script uploaded: ' + file.name, 'success');
                    fileInput.value = '';
                    // Switch to local source and reload
                    document.getElementById('scripts-source').value = 'local';
                    loadScripts();
                } else {
                    UI.showToast('Upload failed: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                UI.showToast('Upload failed: ' + error.message, 'error');
            }
            
            fileInput.value = '';
        }
        
        async function deleteScriptFile() {
            if (!selectedScript) return;
            
            const filename = selectedScript.filename || selectedScript.name;
            if (!confirm(`Delete script "${filename}" from pool?`)) return;
            
            try {
                const response = await fetch('/api/admin/scripts/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: filename })
                });
                const data = await response.json();
                
                if (data.success) {
                    UI.showToast('Script deleted: ' + filename, 'success');
                    selectedScript = null;
                    loadScripts();
                } else {
                    UI.showToast('Delete failed: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                UI.showToast('Delete failed: ' + error.message, 'error');
            }
        }
        
        function updateScriptsDeviceList() {
            const listEl = document.getElementById('scripts-device-list');
            const allDevices = (window.UI && UI.filteredDevices) ? UI.filteredDevices : [];
            
            // Only show online devices
            const devices = allDevices.filter(d => UI.deviceStatus[d.id] === true);
            
            if (devices.length === 0) {
                const offlineCount = allDevices.length - devices.length;
                listEl.innerHTML = `<div class="no-devices-hint">No online devices${offlineCount > 0 ? ` (${offlineCount} offline)` : ''}</div>`;
                scriptsSelectedDevices.clear();
                updateScriptsSelectionCount();
                return;
            }
            
            // Pre-select all online devices
            scriptsSelectedDevices = new Set(devices.map(d => d.id));
            
            listEl.innerHTML = devices.map(d => `
                <label class="scripts-device-item">
                    <input type="checkbox" value="${d.id}" checked onchange="toggleScriptDevice('${d.id}')">
                    <span class="device-name">${d.friendly_name || d.hostname || d.id}</span>
                    <span class="device-ip">${d.ip}</span>
                </label>
            `).join('');
            
            updateScriptsSelectionCount();
        }
        
        function toggleScriptDevice(deviceId) {
            if (scriptsSelectedDevices.has(deviceId)) {
                scriptsSelectedDevices.delete(deviceId);
            } else {
                scriptsSelectedDevices.add(deviceId);
            }
            updateScriptsSelectionCount();
        }
        
        function scriptsSelectAll() {
            const allDevices = (window.UI && UI.filteredDevices) ? UI.filteredDevices : [];
            const devices = allDevices.filter(d => UI.deviceStatus[d.id] === true);
            scriptsSelectedDevices = new Set(devices.map(d => d.id));
            document.querySelectorAll('#scripts-device-list input[type="checkbox"]').forEach(cb => cb.checked = true);
            updateScriptsSelectionCount();
        }
        
        function scriptsSelectNone() {
            scriptsSelectedDevices.clear();
            document.querySelectorAll('#scripts-device-list input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateScriptsSelectionCount();
        }
        
        function updateScriptsSelectionCount() {
            document.getElementById('scripts-selected-count').textContent = scriptsSelectedDevices.size;
            updateScriptsButtons();
        }
        
        function getScriptTargetDevices() {
            return Array.from(scriptsSelectedDevices);
        }
        
        async function deployScript() {
            if (!selectedScript) {
                UI.showToast('No script selected', 'warning');
                return;
            }
            
            const targetDevices = getScriptTargetDevices();
            if (targetDevices.length === 0) {
                UI.showToast('Keine Target devices', 'warning');
                return;
            }
            
            const enableOnBoot = document.getElementById('script-enable-on-boot').checked;
            const startAfterDeploy = document.getElementById('script-start-after-deploy').checked;
            
            // Get custom script name from input (trimmed, fallback to source name)
            const nameInput = document.getElementById('script-deploy-name');
            const customName = nameInput ? nameInput.value.trim() : '';
            // Base name from source file (without .js)
            const scriptFileBase = (selectedScript.name || selectedScript.filename || '').replace(/\.js$/i, '');
            const scriptName = customName || scriptFileBase;
            
            // Show progress
            const progressEl = document.getElementById('scripts-progress');
            const progressFill = document.getElementById('scripts-progress-fill');
            const progressText = document.getElementById('scripts-progress-text');
            const resultsEl = document.getElementById('scripts-results');
            
            progressEl.style.display = 'block';
            progressFill.style.width = '0%';
            progressText.textContent = `Deploying ${scriptName}...`;
            resultsEl.innerHTML = '';
            
            document.getElementById('btn-deploy-script').disabled = true;
            
            try {
                const response = await fetch('/api/scripts/deploy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        script: selectedScript.filename || selectedScript.name,
                        source: document.getElementById('scripts-source').value,
                        devices: targetDevices,
                        enable_on_boot: enableOnBoot,
                        start_after_deploy: startAfterDeploy,
                        script_name: scriptName,
                        script_file_base: scriptFileBase
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show results
                    let successCount = 0;
                    let errorCount = 0;
                    
                    resultsEl.innerHTML = data.results.map(r => {
                        if (r.success) successCount++;
                        else errorCount++;
                        
                        return `
                            <div class="script-result-item">
                                <span class="device-name">${r.ip || r.device}</span>
                                <span class="result-status ${r.success ? 'success' : 'error'}">
                                    ${r.success ? '‚úì' : '‚úó'} ${r.message || ''}
                                </span>
                            </div>
                        `;
                    }).join('');
                    
                    progressFill.style.width = '100%';
                    progressText.textContent = `Done: ${successCount} OK, ${errorCount} errors`;
                    
                    UI.showToast(`Script deployed: ${successCount}/${data.results.length}`, successCount === data.results.length ? 'success' : 'warning');
                    
                    // Auto-refresh status after delay
                    setTimeout(() => {
                        checkScriptStatus();
                    }, 2000);
                } else {
                    progressText.textContent = 'Error: ' + (data.error || 'Unknown');
                    UI.showToast('Deploy fehlgeschlagen: ' + data.error, 'error');
                }
            } catch (error) {
                progressText.textContent = 'Verbindungsfehler';
                UI.showToast('Verbindungsfehler', 'error');
            } finally {
                document.getElementById('btn-deploy-script').disabled = false;
            }
        }
        
        async function checkScriptStatus() {
            const targetDevices = getScriptTargetDevices();
            if (targetDevices.length === 0) {
                UI.showToast('Keine Target devices', 'warning');
                return;
            }
            
            const resultsEl = document.getElementById('scripts-results');
            resultsEl.innerHTML = '<div class="loading-small">Checking script status...</div>';
            
            document.getElementById('btn-script-status').disabled = true;
            
            try {
                const response = await fetch('/api/scripts/status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ devices: targetDevices })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultsEl.innerHTML = data.results.map(r => {
                        const scripts = r.scripts || [];
                        const scriptInfo = scripts.length > 0 
                            ? scripts.map(s => `${s.name}${s.running ? ' ‚ñ∂' : ''}`).join(', ')
                            : 'keine';
                        
                        return `
                            <div class="script-result-item">
                                <span class="device-name">${r.ip || r.device}</span>
                                <span class="result-status ${r.success ? '' : 'error'}">
                                    ${r.success ? scriptInfo : '‚úó ' + (r.error || 'Fehler')}
                                </span>
                            </div>
                        `;
                    }).join('');
                } else {
                    resultsEl.innerHTML = `<div class="no-scripts">Error: ${data.error}</div>`;
                }
            } catch (error) {
                resultsEl.innerHTML = `<div class="no-scripts">Verbindungsfehler</div>`;
            } finally {
                document.getElementById('btn-script-status').disabled = false;
            }
        }
        
        async function deleteScriptFromDevices() {
            const targetDevices = getScriptTargetDevices();
            if (targetDevices.length === 0) {
                UI.showToast('Keine Target devices', 'warning');
                return;
            }
            
            // Ask for script name/id to delete
            const scriptName = prompt('Enter script name to delete (or "all" for all scripts):');
            if (!scriptName) return;
            
            if (!confirm(`Really delete .* from .* device(s)?`)) {
                return;
            }
            
            const resultsEl = document.getElementById('scripts-results');
            resultsEl.innerHTML = '<div class="loading-small">Deleting scripts...</div>';
            
            document.getElementById('btn-delete-script').disabled = true;
            
            try {
                const response = await fetch('/api/scripts/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        devices: targetDevices,
                        script_name: scriptName
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    let successCount = data.results.filter(r => r.success).length;
                    
                    resultsEl.innerHTML = data.results.map(r => `
                        <div class="script-result-item">
                            <span class="device-name">${r.ip || r.device}</span>
                            <span class="result-status ${r.success ? 'success' : 'error'}">
                                ${r.success ? '‚úì deleted' : '‚úó ' + (r.error || 'Fehler')}
                            </span>
                        </div>
                    `).join('');
                    
                    UI.showToast(`Scripts deleted: ${successCount}/${data.results.length}`, 'success');
                } else {
                    resultsEl.innerHTML = `<div class="no-scripts">Error: ${data.error}</div>`;
                }
            } catch (error) {
                resultsEl.innerHTML = `<div class="no-scripts">Verbindungsfehler</div>`;
            } finally {
                document.getElementById('btn-delete-script').disabled = false;
            }
        }
        
        async function controlScripts(action) {
            const targetDevices = getScriptTargetDevices();
            if (targetDevices.length === 0) {
                UI.showToast('Keine Target devices', 'warning');
                return;
            }
            
            const actionLabels = { start: 'Starting', stop: 'Stopping', restart: 'Restarting' };
            const resultsEl = document.getElementById('scripts-results');
            resultsEl.innerHTML = `<div class="loading-small">${actionLabels[action]} scripts...</div>`;
            
            document.getElementById(`btn-script-${action}`).disabled = true;
            
            try {
                const response = await fetch('/api/scripts/control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        devices: targetDevices,
                        action: action
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    let successCount = data.results.filter(r => r.success).length;
                    
                    resultsEl.innerHTML = data.results.map(r => `
                        <div class="script-result-item">
                            <span class="device-name">${r.ip || r.device}</span>
                            <span class="result-status ${r.success ? 'success' : 'error'}">
                                ${r.success ? '‚úì ' + action : '‚úó ' + (r.error || 'Fehler')}
                            </span>
                        </div>
                    `).join('');
                    
                    UI.showToast(`Scripts ${action}: ${successCount}/${data.results.length}`, 'success');
                    
                    // Auto-refresh status after delay
                    setTimeout(() => {
                        checkScriptStatus();
                    }, 2000);
                } else {
                    resultsEl.innerHTML = `<div class="no-scripts">Error: ${data.error}</div>`;
                }
            } catch (error) {
                resultsEl.innerHTML = `<div class="no-scripts">Verbindungsfehler</div>`;
            } finally {
                document.getElementById(`btn-script-${action}`).disabled = false;
            }
        }
        
        // Update device list when filter changes
        document.addEventListener('devicesFiltered', updateScriptsDeviceList);
    </script>

    <script>
        // ============================================
        // KVS Tab Functionality
        // ============================================
        
        let kvsCache = {};           // Current KVS data from device
        let kvsOriginal = {};        // Original values for change detection
        let kvsDeleted = new Set();  // Keys marked for deletion
        let kvsCurrentDevice = null; // Currently selected device MAC
        
        // Initialize KVS tab
        document.getElementById('btn-refresh-kvs').addEventListener('click', loadKVS);
        document.getElementById('btn-save-kvs').addEventListener('click', saveKVS);
        document.getElementById('btn-delete-all-kvs').addEventListener('click', deleteAllKVS);
        
        // Load KVS when device is selected
        document.addEventListener('deviceSelected', (e) => {
            if (e.detail && e.detail.mac) {
                kvsCurrentDevice = e.detail.mac;
                // Reset state for new device
                resetKVSState();
                // Auto-load KVS if the KVS tab is active
                const kvsTab = document.getElementById('tab-kvs');
                if (kvsTab && kvsTab.classList.contains('active')) {
                    loadKVS();
                }
            }
        });
        
        // Load KVS when tab is clicked (only if not already loaded for this device)
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (btn.dataset.tab === 'kvs' && kvsCurrentDevice) {
                    // Always reload when switching to KVS tab
                    loadKVS();
                }
            });
        });
        
        async function loadKVS() {
            if (!kvsCurrentDevice) {
                document.getElementById('kvs-no-device').style.display = 'block';
                document.getElementById('kvs-content').style.display = 'none';
                return;
            }
            
            document.getElementById('kvs-no-device').style.display = 'none';
            document.getElementById('kvs-content').style.display = 'flex';
            document.getElementById('kvs-loading').style.display = 'flex';
            document.getElementById('kvs-empty').style.display = 'none';
            document.getElementById('kvs-table-container').style.display = 'none';
            document.getElementById('kvs-actions').style.display = 'none';
            
            try {
                const response = await fetch(`/api/devices/${kvsCurrentDevice}/kvs`);
                const data = await response.json();
                
                document.getElementById('kvs-loading').style.display = 'none';
                
                if (data.success) {
                    kvsCache = data.kvs || {};
                    kvsOriginal = JSON.parse(JSON.stringify(kvsCache));
                    kvsDeleted = new Set();
                    
                    if (Object.keys(kvsCache).length === 0) {
                        document.getElementById('kvs-empty').style.display = 'block';
                    } else {
                        renderKVSTable();
                        document.getElementById('kvs-table-container').style.display = 'block';
                        document.getElementById('kvs-actions').style.display = 'flex';
                        updateKVSSaveButton();
                    }
                } else {
                    document.getElementById('kvs-empty').style.display = 'block';
                    document.querySelector('#kvs-empty p').textContent = 'Error: ' + (data.error || 'Unbekannt');
                }
            } catch (error) {
                document.getElementById('kvs-loading').style.display = 'none';
                document.getElementById('kvs-empty').style.display = 'block';
                document.querySelector('#kvs-empty p').textContent = 'Verbindungsfehler';
            }
        }
        
        function renderKVSTable() {
            const tbody = document.getElementById('kvs-table-body');
            const keys = Object.keys(kvsCache).sort();
            
            tbody.innerHTML = keys.map(key => {
                const value = kvsCache[key];
                const displayValue = typeof value === 'object' ? JSON.stringify(value) : String(value);
                const isDeleted = kvsDeleted.has(key);
                
                return `
                    <tr class="${isDeleted ? 'kvs-row-deleted' : ''}" data-key="${escapeHtml(key)}">
                        <td class="kvs-key">${escapeHtml(key)}</td>
                        <td>
                            <input type="text" 
                                   class="kvs-value-input" 
                                   value="${escapeHtml(displayValue)}"
                                   data-original="${escapeHtml(displayValue)}"
                                   onchange="onKVSValueChange(this, '${escapeHtml(key)}')"
                                   oninput="onKVSValueInput(this)">
                        </td>
                        <td>
                            <button class="kvs-delete-btn" 
                                    onclick="toggleKVSDelete('${escapeHtml(key)}')"
                                    title="${isDeleted ? 'Restore' : 'Delete'}">
                                ${isDeleted ? '‚Ü©Ô∏è' : 'üóë'}
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML.replace(/"/g, '&quot;');
        }
        
        function onKVSValueInput(input) {
            const original = input.dataset.original;
            const current = input.value;
            
            if (current !== original) {
                input.classList.add('changed');
            } else {
                input.classList.remove('changed');
            }
            
            updateKVSSaveButton();
        }
        
        function onKVSValueChange(input, key) {
            const newValue = input.value;
            
            // Try to parse as JSON/number/boolean
            // BUT: Keep IP addresses as strings
            let parsedValue = newValue;
            
            // IP-Pattern: 4 Zahlengruppen mit Punkten (e.g. 192.168.1.41)
            const isIP = /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(newValue);
            
            if (newValue === 'true') {
                parsedValue = true;
            } else if (newValue === 'false') {
                parsedValue = false;
            } else if (isIP) {
                // Keep IP addresses as strings
                parsedValue = newValue;
            } else if (newValue !== '' && !isNaN(newValue)) {
                // Parse as number (int or float)
                parsedValue = newValue.includes('.') ? parseFloat(newValue) : parseInt(newValue, 10);
            }
            
            kvsCache[key] = parsedValue;
            updateKVSSaveButton();
        }
        
        function toggleKVSDelete(key) {
            if (kvsDeleted.has(key)) {
                kvsDeleted.delete(key);
            } else {
                kvsDeleted.add(key);
            }
            renderKVSTable();
            updateKVSSaveButton();
        }
        
        function updateKVSSaveButton() {
            const btn = document.getElementById('btn-save-kvs');
            const hint = document.getElementById('kvs-changes-hint');
            
            // Check for changes
            const changedInputs = document.querySelectorAll('.kvs-value-input.changed');
            const deletedCount = kvsDeleted.size;
            
            const hasChanges = changedInputs.length > 0 || deletedCount > 0;
            btn.disabled = !hasChanges;
            
            if (hasChanges) {
                const parts = [];
                if (changedInputs.length > 0) parts.push(`${changedInputs.length} changed`);
                if (deletedCount > 0) parts.push(`${deletedCount} to delete`);
                hint.textContent = parts.join(', ');
            } else {
                hint.textContent = '';
            }
        }
        
        async function saveKVS() {
            if (!kvsCurrentDevice) return;
            
            const btn = document.getElementById('btn-save-kvs');
            btn.disabled = true;
            btn.textContent = i18n.t('common.saving') || 'Saving...';
            
            // Collect changes
            const updates = {};
            const deletes = Array.from(kvsDeleted);
            
            document.querySelectorAll('.kvs-value-input.changed').forEach(input => {
                const row = input.closest('tr');
                const key = row.dataset.key;
                if (!kvsDeleted.has(key)) {
                    updates[key] = kvsCache[key];
                }
            });
            
            try {
                const response = await fetch(`/api/devices/${kvsCurrentDevice}/kvs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ updates, deletes })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    UI.showToast('KVS gespeichert', 'success');
                    // Reload to show current state
                    await loadKVS();
                } else {
                    UI.showToast('Error: ' + (data.error || 'Unbekannt'), 'error');
                }
            } catch (error) {
                UI.showToast('Verbindungsfehler', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = i18n.t('kvs.save_changes') || 'Save Changes';
            }
        }
        
        // Reset KVS state when device changes
        async function deleteAllKVS() {
            if (!kvsCurrentDevice) {
                UI.showToast(i18n.t('kvs.no_device') || 'No device selected', 'warning');
                return;
            }
            
            const keyCount = Object.keys(kvsCache).length;
            if (keyCount === 0) {
                UI.showToast(i18n.t('kvs.empty') || 'No KVS entries to delete', 'info');
                return;
            }
            
            const confirmMsg = i18n.t('kvs.confirm_delete_all') || `Delete all ${keyCount} KVS entries from this device?`;
            if (!confirm(confirmMsg)) {
                return;
            }
            
            const btn = document.getElementById('btn-delete-all-kvs');
            btn.disabled = true;
            btn.textContent = i18n.t('common.deleting') || 'Deleting...';
            
            try {
                const response = await fetch('/api/kvs/delete-all', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device: kvsCurrentDevice })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const msg = i18n.t('kvs.deleted_count', {count: data.deleted_count || keyCount}) || `Deleted ${data.deleted_count || keyCount} KVS entries`;
                    UI.showToast(msg, 'success');
                    // Reload KVS to show empty state
                    loadKVS();
                } else {
                    UI.showToast('Error: ' + (data.error || 'Unknown'), 'error');
                }
            } catch (error) {
                UI.showToast(i18n.t('common.connection_error') || 'Connection error', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = i18n.t('kvs.delete_all') || 'üóëÔ∏è Delete All';
            }
        }
        
        function resetKVSState() {
            kvsCache = {};
            kvsOriginal = {};
            kvsDeleted = new Set();
            // Don't hide content - loadKVS will handle the display
        }
    </script>

    <script>
        // ============================================
        // Webhooks Tab Functionality
        // ============================================
        
        let webhooksData = [];           // Current webhooks from device
        let webhooksComponents = [];     // Available components
        let webhooksCurrentDevice = null;
        
        // Event types per component type
        const WEBHOOK_EVENTS = {
            'input': [
                { value: 'input.button_push', label: 'Button Push (single)' },
                { value: 'input.button_longpush', label: 'Button Long Push' },
                { value: 'input.button_doublepush', label: 'Button Double Push' },
                { value: 'input.toggle_on', label: 'Toggle On' },
                { value: 'input.toggle_off', label: 'Toggle Off' }
            ],
            'switch': [
                { value: 'switch.on', label: 'Switch On' },
                { value: 'switch.off', label: 'Switch Off' }
            ],
            'cover': [
                { value: 'cover.open', label: 'Cover Open' },
                { value: 'cover.closed', label: 'Cover Closed' },
                { value: 'cover.stopped', label: 'Cover Stopped' },
                { value: 'cover.opening', label: 'Cover Opening' },
                { value: 'cover.closing', label: 'Cover Closing' }
            ],
            'light': [
                { value: 'light.on', label: 'Light On' },
                { value: 'light.off', label: 'Light Off' }
            ]
        };
        
        // Initialize webhooks tab
        document.getElementById('btn-refresh-webhooks').addEventListener('click', loadWebhooks);
        document.getElementById('btn-create-webhook').addEventListener('click', createWebhook);
        document.getElementById('webhook-event').addEventListener('change', updateCreateButton);
        document.getElementById('webhook-url').addEventListener('input', updateCreateButton);
        
        // Load webhooks when device is selected
        document.addEventListener('deviceSelected', (e) => {
            if (e.detail && e.detail.mac) {
                webhooksCurrentDevice = e.detail.mac;
                // Auto-load if tab is active
                const tab = document.getElementById('tab-webhooks');
                if (tab && tab.classList.contains('active')) {
                    loadWebhooks();
                }
            }
        });
        
        // Load webhooks when tab is clicked
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (btn.dataset.tab === 'webhooks' && webhooksCurrentDevice) {
                    loadWebhooks();
                }
            });
        });
        
        async function loadWebhooks() {
            if (!webhooksCurrentDevice) {
                document.getElementById('webhooks-no-device').style.display = 'block';
                document.getElementById('webhooks-content').style.display = 'none';
                return;
            }
            
            document.getElementById('webhooks-no-device').style.display = 'none';
            document.getElementById('webhooks-content').style.display = 'flex';
            document.getElementById('webhooks-loading').style.display = 'flex';
            document.getElementById('webhooks-list').innerHTML = '';
            document.getElementById('webhooks-empty').style.display = 'none';
            
            try {
                const response = await fetch(`/api/devices/${webhooksCurrentDevice}/webhooks`);
                const data = await response.json();
                
                document.getElementById('webhooks-loading').style.display = 'none';
                
                if (data.success) {
                    webhooksData = data.webhooks || [];
                    webhooksComponents = data.components || [];
                    
                    renderWebhooksList();
                    populateEventDropdown();
                    populateComponentDropdown();
                    
                    if (webhooksData.length === 0) {
                        document.getElementById('webhooks-empty').style.display = 'block';
                    }
                } else {
                    document.getElementById('webhooks-empty').style.display = 'block';
                    document.querySelector('#webhooks-empty p').textContent = 'Error: ' + (data.error || 'Unbekannt');
                }
            } catch (error) {
                document.getElementById('webhooks-loading').style.display = 'none';
                document.getElementById('webhooks-empty').style.display = 'block';
                document.querySelector('#webhooks-empty p').textContent = 'Verbindungsfehler';
            }
        }
        
        function renderWebhooksList() {
            const listEl = document.getElementById('webhooks-list');
            
            if (webhooksData.length === 0) {
                listEl.innerHTML = '';
                return;
            }
            
            listEl.innerHTML = webhooksData.map(wh => {
                const urls = Array.isArray(wh.urls) ? wh.urls : [wh.urls];
                const urlStr = urls[0] || '';
                return `
                    <div class="webhook-item" data-id="${wh.id}">
                        <div class="webhook-item-header">
                            <span class="webhook-item-event">${wh.event} (${wh.cid})</span>
                            <span class="webhook-item-status ${wh.enable ? 'enabled' : 'disabled'}">
                                ${wh.enable ? '‚óè Active' : '‚óã Inactive'}
                            </span>
                        </div>
                        ${wh.name ? `<div class="webhook-item-name" style="font-size: 0.75rem; margin-bottom: 0.2rem;">${wh.name}</div>` : ''}
                        <div class="webhook-item-url-row">
                            <span class="webhook-item-url" id="webhook-url-display-${wh.id}">${urlStr}</span>
                            <button class="btn-tiny" onclick="startEditWebhookUrl(${wh.id}, '${urlStr.replace(/'/g, "\\'")}')">‚úèÔ∏è</button>
                        </div>
                        <div class="webhook-item-url-edit" id="webhook-url-edit-${wh.id}" style="display: none;">
                            <input type="text" class="webhook-url-input" id="webhook-url-input-${wh.id}" value="${urlStr}">
                            <button class="btn-tiny" onclick="saveWebhookUrl(${wh.id})">üíæ</button>
                            <button class="btn-tiny" onclick="cancelEditWebhookUrl(${wh.id})">‚úñ</button>
                        </div>
                        <div class="webhook-item-actions">
                            <button class="btn-small ${wh.enable ? 'btn-secondary' : 'btn-primary'}" 
                                    onclick="toggleWebhook(${wh.id}, ${!wh.enable})">
                                ${wh.enable ? 'Disable' : 'Enable'}
                            </button>
                            <button class="btn-small btn-danger" onclick="deleteWebhook(${wh.id})">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function startEditWebhookUrl(id, currentUrl) {
            document.getElementById(`webhook-url-display-${id}`).parentElement.style.display = 'none';
            document.getElementById(`webhook-url-edit-${id}`).style.display = 'flex';
            document.getElementById(`webhook-url-input-${id}`).value = currentUrl;
            document.getElementById(`webhook-url-input-${id}`).focus();
        }
        
        function cancelEditWebhookUrl(id) {
            document.getElementById(`webhook-url-display-${id}`).parentElement.style.display = 'flex';
            document.getElementById(`webhook-url-edit-${id}`).style.display = 'none';
        }
        
        async function saveWebhookUrl(id) {
            const newUrl = document.getElementById(`webhook-url-input-${id}`).value.trim();
            if (!newUrl) {
                UI.showToast('URL darf nicht leer sein', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`/api/devices/${webhooksCurrentDevice}/webhooks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'update', id, urls: [newUrl] })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    UI.showToast('URL gespeichert', 'success');
                    await loadWebhooks();
                } else {
                    UI.showToast('Error: ' + (data.error || 'Unbekannt'), 'error');
                }
            } catch (error) {
                UI.showToast('Verbindungsfehler', 'error');
            }
        }
        
        function populateEventDropdown() {
            const select = document.getElementById('webhook-event');
            select.innerHTML = '<option value="">-- Select event --</option>';
            
            // Get unique component types from device
            const componentTypes = new Set();
            webhooksComponents.forEach(comp => {
                const type = comp.split(':')[0].toLowerCase();
                componentTypes.add(type);
            });
            
            // Add events for each component type
            componentTypes.forEach(type => {
                const events = WEBHOOK_EVENTS[type];
                if (events) {
                    const group = document.createElement('optgroup');
                    group.label = type.charAt(0).toUpperCase() + type.slice(1);
                    events.forEach(evt => {
                        const option = document.createElement('option');
                        option.value = evt.value;
                        option.textContent = evt.label;
                        group.appendChild(option);
                    });
                    select.appendChild(group);
                }
            });
        }
        
        function populateComponentDropdown() {
            const select = document.getElementById('webhook-component');
            const eventSelect = document.getElementById('webhook-event');
            const selectedEvent = eventSelect.value;
            
            select.innerHTML = '';
            
            if (!selectedEvent) {
                select.innerHTML = '<option value="0">0</option>';
                return;
            }
            
            // Get component type from event (e.g., "input" from "input.button_push")
            const eventType = selectedEvent.split('.')[0];
            
            // Filter components by type
            const matching = webhooksComponents.filter(c => c.toLowerCase().startsWith(eventType + ':'));
            
            if (matching.length === 0) {
                select.innerHTML = '<option value="0">0</option>';
            } else {
                matching.forEach(comp => {
                    const id = comp.split(':')[1];
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = comp;
                    select.appendChild(option);
                });
            }
        }
        
        // Update component dropdown when event changes
        document.getElementById('webhook-event').addEventListener('change', () => {
            populateComponentDropdown();
            updateCreateButton();
        });
        
        function updateCreateButton() {
            const event = document.getElementById('webhook-event').value;
            const url = document.getElementById('webhook-url').value.trim();
            document.getElementById('btn-create-webhook').disabled = !event || !url;
        }
        
        async function createWebhook() {
            const event = document.getElementById('webhook-event').value;
            const cid = parseInt(document.getElementById('webhook-component').value) || 0;
            const name = document.getElementById('webhook-name').value.trim();
            const url = document.getElementById('webhook-url').value.trim();
            const enable = document.getElementById('webhook-enable').checked;
            
            if (!event || !url) return;
            
            document.getElementById('btn-create-webhook').disabled = true;
            
            try {
                const response = await fetch(`/api/devices/${webhooksCurrentDevice}/webhooks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'create',
                        event, cid, name, url, enable
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    UI.showToast('Webhook erstellt', 'success');
                    // Clear form
                    document.getElementById('webhook-name').value = '';
                    document.getElementById('webhook-url').value = '';
                    // Reload
                    await loadWebhooks();
                } else {
                    UI.showToast('Error: ' + (data.error || 'Unbekannt'), 'error');
                }
            } catch (error) {
                UI.showToast('Verbindungsfehler', 'error');
            } finally {
                updateCreateButton();
            }
        }
        
        async function toggleWebhook(id, enable) {
            try {
                const response = await fetch(`/api/devices/${webhooksCurrentDevice}/webhooks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'update', id, enable })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    UI.showToast(enable ? 'Webhook aktiviert' : 'Webhook deaktiviert', 'success');
                    await loadWebhooks();
                } else {
                    UI.showToast('Error: ' + (data.error || 'Unbekannt'), 'error');
                }
            } catch (error) {
                UI.showToast('Verbindungsfehler', 'error');
            }
        }
        
        async function deleteWebhook(id) {
            if (!confirm('Really delete webhook?')) return;
            
            try {
                const response = await fetch(`/api/devices/${webhooksCurrentDevice}/webhooks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'delete', id })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    UI.showToast('Webhook deleted', 'success');
                    await loadWebhooks();
                } else {
                    UI.showToast('Error: ' + (data.error || 'Unbekannt'), 'error');
                }
            } catch (error) {
                UI.showToast('Verbindungsfehler', 'error');
            }
        }
        
        // ============================================
        // URL Builder Functionality
        // ============================================
        
        // Toggle URL Builder visibility
        document.getElementById('btn-toggle-url-builder').addEventListener('click', toggleUrlBuilder);
        document.querySelector('.url-builder-header').addEventListener('click', toggleUrlBuilder);
        
        function toggleUrlBuilder() {
            const content = document.getElementById('url-builder-content');
            const btn = document.getElementById('btn-toggle-url-builder');
            content.classList.toggle('collapsed');
            btn.textContent = content.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
        }
        
        // Populate target device dropdown when webhooks tab loads
        function populateTargetDeviceDropdown() {
            const select = document.getElementById('url-target-device');
            select.innerHTML = '<option value="">-- Select device --</option>';
            
            if (window.UI && UI.allDevices) {
                UI.allDevices.forEach(device => {
                    if (device.ip) {
                        const option = document.createElement('option');
                        option.value = device.ip;
                        option.textContent = device.friendly_name || device.ip;
                        select.appendChild(option);
                    }
                });
            }
        }
        
        // Show/hide extra params based on action
        document.getElementById('url-action').addEventListener('change', function() {
            const extraParams = document.getElementById('url-extra-params');
            if (this.value.includes('{pos}')) {
                extraParams.style.display = 'flex';
            } else {
                extraParams.style.display = 'none';
            }
        });
        
        // Clear manual IP when device selected and vice versa
        document.getElementById('url-target-device').addEventListener('change', function() {
            if (this.value) {
                document.getElementById('url-target-ip').value = '';
            }
        });
        
        document.getElementById('url-target-ip').addEventListener('input', function() {
            if (this.value) {
                document.getElementById('url-target-device').value = '';
            }
        });
        
        // Generate URL
        document.getElementById('btn-generate-url').addEventListener('click', generateWebhookUrl);
        
        function generateWebhookUrl() {
            const deviceSelect = document.getElementById('url-target-device');
            const manualIp = document.getElementById('url-target-ip').value.trim();
            const action = document.getElementById('url-action').value;
            const paramId = document.getElementById('url-param-id').value;
            const paramPos = document.getElementById('url-param-pos').value;
            
            // Get IP
            const ip = manualIp || deviceSelect.value;
            if (!ip) {
                UI.showToast('Please select target device or IP', 'warning');
                return;
            }
            
            if (!action) {
                UI.showToast('Please select an action', 'warning');
                return;
            }
            
            // Build URL
            let urlPath = action
                .replace('{id}', paramId)
                .replace('{pos}', paramPos);
            
            const url = `http://${ip}/rpc/${urlPath}`;
            
            // Set URL field
            document.getElementById('webhook-url').value = url;
            updateCreateButton();
            
            UI.showToast('URL generiert', 'success');
        }
        
        // Update target device dropdown when webhooks are loaded
        const originalLoadWebhooks = loadWebhooks;
        loadWebhooks = async function() {
            await originalLoadWebhooks();
            populateTargetDeviceDropdown();
        };
    </script>

    <script>
        // ============================================
        // Firmware Tab Functionality
        // ============================================
        
        let firmwareData = [];           // Array of {mac, ip, name, current, available, status}
        let firmwareSelected = new Set(); // Selected device MACs for update
        
        // Initialize firmware tab
        document.getElementById('btn-check-firmware').addEventListener('click', checkFirmware);
        document.getElementById('btn-update-firmware').addEventListener('click', updateSelectedFirmware);
        document.getElementById('btn-update-all-outdated').addEventListener('click', updateAllOutdated);
        document.getElementById('fw-select-all').addEventListener('change', toggleSelectAllFirmware);
        
        // Update counts when tab is shown
        document.querySelector('.tab-btn[data-tab="firmware"]').addEventListener('click', () => {
            updateFirmwareCounts();
        });
        
        // Update counts when filter changes
        document.addEventListener('deviceSelectionChanged', updateFirmwareCounts);
        document.addEventListener('devicesFiltered', updateFirmwareCounts);
        
        function updateFirmwareCounts() {
            const filtered = (window.UI && UI.filteredDevices) ? UI.filteredDevices.length : 0;
            const all = (window.UI && UI.allDevices) ? UI.allDevices.length : 0;
            document.getElementById('fw-filtered-count').textContent = filtered;
            document.getElementById('fw-all-count').textContent = all;
        }
        
        function getFirmwareTargetDevices() {
            const scope = document.querySelector('input[name="fw-scope"]:checked').value;
            if (scope === 'all') {
                return (window.UI && UI.allDevices) ? UI.allDevices.map(d => d.id) : [];
            } else {
                // Use filtered devices (what's visible in the list)
                return (window.UI && UI.filteredDevices) ? UI.filteredDevices.map(d => d.id) : [];
            }
        }
        
        async function checkFirmware() {
            const devices = getFirmwareTargetDevices();
            if (devices.length === 0) {
                UI.showToast('No devices in filter', 'warning');
                return;
            }
            
            document.getElementById('firmware-loading').style.display = 'flex';
            document.getElementById('firmware-table-container').style.display = 'none';
            document.getElementById('firmware-empty').style.display = 'none';
            document.getElementById('firmware-actions').style.display = 'none';
            document.getElementById('btn-check-firmware').disabled = true;
            
            try {
                const response = await fetch('/api/firmware/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ devices })
                });
                
                const data = await response.json();
                
                document.getElementById('firmware-loading').style.display = 'none';
                
                if (data.success) {
                    firmwareData = data.results || [];
                    firmwareSelected = new Set();
                    
                    if (firmwareData.length === 0) {
                        document.getElementById('firmware-empty').style.display = 'block';
                    } else {
                        renderFirmwareTable();
                        document.getElementById('firmware-table-container').style.display = 'block';
                        document.getElementById('firmware-actions').style.display = 'flex';
                        updateFirmwareButtons();
                    }
                } else {
                    document.getElementById('firmware-empty').style.display = 'block';
                    document.querySelector('#firmware-empty p').textContent = 'Error: ' + (data.error || 'Unbekannt');
                }
            } catch (error) {
                document.getElementById('firmware-loading').style.display = 'none';
                document.getElementById('firmware-empty').style.display = 'block';
                document.querySelector('#firmware-empty p').textContent = 'Verbindungsfehler';
            } finally {
                document.getElementById('btn-check-firmware').disabled = false;
            }
        }
        
        function renderFirmwareTable() {
            const tbody = document.getElementById('firmware-table-body');
            
            tbody.innerHTML = firmwareData.map((fw, idx) => {
                const isOutdated = fw.available && fw.current !== fw.available;
                const isSelected = firmwareSelected.has(fw.mac);
                const statusClass = fw.error ? 'error' : (isOutdated ? 'outdated' : 'uptodate');
                const statusText = fw.error ? '‚úó ' + fw.error : (isOutdated ? '‚¨Ü Update' : '‚úì Current');
                
                return `
                    <tr class="${isSelected ? 'selected' : ''}" data-mac="${fw.mac}">
                        <td style="text-align: center;">
                            <input type="checkbox" 
                                   class="fw-checkbox" 
                                   data-mac="${fw.mac}"
                                   ${isSelected ? 'checked' : ''}
                                   ${!isOutdated || fw.error ? 'disabled' : ''}
                                   onchange="toggleFirmwareSelect('${fw.mac}')">
                        </td>
                        <td class="fw-device" title="${fw.mac}">${fw.name || fw.ip}</td>
                        <td class="fw-version">${fw.current || '?'}</td>
                        <td class="fw-version">${fw.available || '-'}</td>
                        <td class="fw-status ${statusClass}">${statusText}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function toggleFirmwareSelect(mac) {
            if (firmwareSelected.has(mac)) {
                firmwareSelected.delete(mac);
            } else {
                firmwareSelected.add(mac);
            }
            updateFirmwareButtons();
            updateSelectAllCheckbox();
        }
        
        function toggleSelectAllFirmware(e) {
            const checked = e.target.checked;
            firmwareData.forEach(fw => {
                const isOutdated = fw.available && fw.current !== fw.available && !fw.error;
                if (isOutdated) {
                    if (checked) {
                        firmwareSelected.add(fw.mac);
                    } else {
                        firmwareSelected.delete(fw.mac);
                    }
                }
            });
            renderFirmwareTable();
            updateFirmwareButtons();
        }
        
        function updateSelectAllCheckbox() {
            const outdatedMacs = firmwareData
                .filter(fw => fw.available && fw.current !== fw.available && !fw.error)
                .map(fw => fw.mac);
            const allSelected = outdatedMacs.length > 0 && outdatedMacs.every(mac => firmwareSelected.has(mac));
            document.getElementById('fw-select-all').checked = allSelected;
        }
        
        function updateFirmwareButtons() {
            const selectedCount = firmwareSelected.size;
            const outdatedCount = firmwareData.filter(fw => 
                fw.available && fw.current !== fw.available && !fw.error
            ).length;
            
            document.getElementById('fw-update-count').textContent = selectedCount;
            document.getElementById('btn-update-firmware').disabled = selectedCount === 0;
            document.getElementById('btn-update-all-outdated').disabled = outdatedCount === 0;
        }
        
        async function updateSelectedFirmware() {
            const devices = Array.from(firmwareSelected);
            if (devices.length === 0) return;
            await performFirmwareUpdate(devices);
        }
        
        async function updateAllOutdated() {
            const devices = firmwareData
                .filter(fw => fw.available && fw.current !== fw.available && !fw.error)
                .map(fw => fw.mac);
            if (devices.length === 0) return;
            await performFirmwareUpdate(devices);
        }
        
        async function performFirmwareUpdate(devices) {
            document.getElementById('btn-update-firmware').disabled = true;
            document.getElementById('btn-update-all-outdated').disabled = true;
            document.getElementById('firmware-progress').style.display = 'block';
            
            const progressFill = document.getElementById('firmware-progress-fill');
            const progressText = document.getElementById('firmware-progress-text');
            
            progressFill.style.width = '0%';
            progressText.textContent = `Starting update for ${devices.length} Device(s)...`;
            
            // Update status in table
            devices.forEach(mac => {
                const row = document.querySelector(`tr[data-mac="${mac}"]`);
                if (row) {
                    const statusCell = row.querySelector('.fw-status');
                    statusCell.className = 'fw-status updating';
                    statusCell.textContent = '‚è≥ Updating...';
                }
            });
            
            try {
                const response = await fetch('/api/firmware/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ devices })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    let successCount = 0;
                    let errorCount = 0;
                    
                    data.results.forEach(r => {
                        const row = document.querySelector(`tr[data-mac="${r.mac}"]`);
                        if (row) {
                            const statusCell = row.querySelector('.fw-status');
                            if (r.success) {
                                statusCell.className = 'fw-status uptodate';
                                statusCell.textContent = '‚úì Update started';
                                successCount++;
                            } else {
                                statusCell.className = 'fw-status error';
                                statusCell.textContent = '‚úó ' + (r.error || 'Fehler');
                                errorCount++;
                            }
                        }
                    });
                    
                    progressFill.style.width = '100%';
                    progressText.textContent = `Done: ${successCount} started, ${errorCount} errors`;
                    
                    UI.showToast(`Firmware update: ${successCount}/${devices.length} started`, 
                        successCount === devices.length ? 'success' : 'warning');
                    
                    // Clear selection
                    firmwareSelected.clear();
                    updateFirmwareButtons();
                } else {
                    progressText.textContent = 'Error: ' + (data.error || 'Unbekannt');
                    UI.showToast('Update fehlgeschlagen: ' + data.error, 'error');
                }
            } catch (error) {
                progressText.textContent = 'Verbindungsfehler';
                UI.showToast('Verbindungsfehler', 'error');
            } finally {
                document.getElementById('btn-update-firmware').disabled = false;
                document.getElementById('btn-update-all-outdated').disabled = false;
            }
        }
        
        // Check if this is a newly created building (opened with ?new=1)
        (function checkNewBuilding() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('new') === '1') {
                // Remove the query parameter from URL without reload
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // Show toast and open settings after a short delay
                setTimeout(() => {
                    UI.showToast('Building created! Configure WiFi and network settings.', 'success', 3000);
                    openBuildingSettings();
                }, 500);
            }
        })();
    </script>

    <script>
        // ============================================
        // Delete Device Functionality
        // ============================================
        
        let deleteDeviceCurrentMac = null;
        
        // Show danger zone when device is selected
        document.addEventListener('deviceSelected', (e) => {
            if (e.detail && e.detail.mac) {
                deleteDeviceCurrentMac = e.detail.mac;
                document.getElementById('danger-zone').style.display = 'block';
            }
        });
        
        // Hide danger zone when device is deselected
        document.addEventListener('deviceDeselected', () => {
            deleteDeviceCurrentMac = null;
            document.getElementById('danger-zone').style.display = 'none';
        });
        
        // Delete button click handler
        document.getElementById('btn-delete-device').addEventListener('click', async () => {
            if (!deleteDeviceCurrentMac) {
                UI.showToast(i18n.t('device.no_device_selected') || 'No device selected', 'warning');
                return;
            }
            
            const confirmMsg = i18n.t('device.confirm_remove') || 'Are you sure you want to remove this device from Stagebox?';
            if (!confirm(confirmMsg)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/devices/${deleteDeviceCurrentMac}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    UI.showToast(i18n.t('device.removed_success') || 'Device removed', 'success');
                    // Hide danger zone and clear selection
                    deleteDeviceCurrentMac = null;
                    document.getElementById('danger-zone').style.display = 'none';
                    // Hide device form
                    const deviceForm = document.getElementById('device-form');
                    if (deviceForm) deviceForm.style.display = 'none';
                    
                    // Refresh device list
                    if (window.App && typeof window.App.loadDevices === 'function') {
                        await window.App.loadDevices();
                    }
                } else {
                    UI.showToast('Error: ' + (data.error || 'Unknown'), 'error');
                }
            } catch (error) {
                UI.showToast(i18n.t('common.connection_error') || 'Connection error', 'error');
            }
        });
    </script>
</body>
</html>